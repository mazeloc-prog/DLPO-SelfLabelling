<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>MazeShield Email</title>
    <script src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 16px;
        }
        .container { max-width: 100%; }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .logo { font-size: 22px; font-weight: 700; color: #00d4ff; }
        .subtitle { font-size: 11px; color: #888; margin-top: 4px; }
        .user-info {
            font-size: 10px;
            color: #00d4ff;
            margin-top: 8px;
            padding: 4px 10px;
            background: rgba(0,212,255,0.1);
            border-radius: 12px;
            display: inline-block;
        }
        
        .section {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 14px;
        }
        .section-title {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #888;
            margin-bottom: 10px;
        }
        
        .class-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        .class-btn {
            padding: 12px 10px;
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            transition: all 0.2s;
            text-align: center;
            color: #fff;
        }
        .class-btn:hover { transform: scale(1.02); }
        .class-btn.selected { border-color: #fff; box-shadow: 0 0 15px rgba(255,255,255,0.3); }
        
        .class-public { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .class-internal { background: linear-gradient(135deg, #3498db, #2980b9); }
        .class-confidential { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .class-restricted { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        
        .current-class {
            text-align: center;
            padding: 8px;
            border-radius: 8px;
            font-size: 11px;
            margin-top: 10px;
            font-weight: 600;
        }
        .current-class.success { background: rgba(46,204,113,0.2); color: #2ecc71; }
        .current-class.info { background: rgba(52,152,219,0.2); color: #3498db; }
        
        .recipients-list { max-height: 140px; overflow-y: auto; }
        .recipient {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            margin-bottom: 6px;
            font-size: 12px;
        }
        .recipient.internal { border-left: 3px solid #2ecc71; }
        .recipient.external { border-left: 3px solid #e74c3c; }
        .badge {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 700;
        }
        .badge.internal { background: #2ecc71; color: #000; }
        .badge.external { background: #e74c3c; color: #fff; }
        .no-recipients { color: #666; font-style: italic; font-size: 12px; }
        
        .warning-banner {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 14px;
            display: none;
            text-align: center;
        }
        .warning-banner.visible { display: block; animation: pulse 2s infinite; }
        .warning-title { font-weight: 700; font-size: 13px; margin-bottom: 4px; }
        .warning-text { font-size: 11px; opacity: 0.9; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }
        
        .status-msg {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            font-size: 11px;
            margin-top: 10px;
            background: rgba(46,204,113,0.2);
            color: #2ecc71;
            display: none;
        }
        
        .info-box {
            background: rgba(52,152,219,0.1);
            border: 1px solid rgba(52,152,219,0.3);
            border-radius: 8px;
            padding: 10px;
            font-size: 10px;
            color: #3498db;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">üõ°Ô∏è MazeShield</div>
            <div class="subtitle">Email Classification</div>
            <div class="user-info" id="userInfo">üë§ Chargement...</div>
        </div>
        
        <div class="warning-banner" id="warningBanner">
            <div class="warning-title">‚ö†Ô∏è ATTENTION</div>
            <div class="warning-text">Email sensible vers destinataire externe !<br/>Une justification sera demand√©e √† l'envoi.</div>
        </div>
        
        <div class="section">
            <div class="section-title">Classification</div>
            <div class="class-grid">
                <button class="class-btn class-public" data-class="Public" onclick="setClassification('Public')">
                    üåê Public
                </button>
                <button class="class-btn class-internal" data-class="Internal" onclick="setClassification('Internal')">
                    üè¢ Internal
                </button>
                <button class="class-btn class-confidential" data-class="Confidential" onclick="setClassification('Confidential')">
                    üîí Confidential
                </button>
                <button class="class-btn class-restricted" data-class="Restricted" onclick="setClassification('Restricted')">
                    üö´ Restricted
                </button>
            </div>
            <div class="current-class info" id="currentClass">Aucune classification</div>
        </div>
        
        <div class="section">
            <div class="section-title">Destinataires</div>
            <div class="recipients-list" id="recipientsList">
                <div class="no-recipients">Chargement...</div>
            </div>
        </div>
        
        <div class="info-box">
            üí° Cliquez sur <strong>Envoyer</strong> normalement.<br/>
            Si l'email est sensible + externe, une alerte appara√Ætra.
        </div>
        
        <div class="status-msg" id="statusMsg"></div>
    </div>

    <script>
        // Variables globales
        let internalDomain = null;
        let currentUserEmail = 'unknown';
        let currentClassification = null;
        let hasExternalRecipients = false;
        const SENSITIVE = ["Confidential", "Restricted"];

        Office.onReady(function(info) {
            if (info.host === Office.HostType.Outlook) {
                // SSO : R√©cup√©rer l'utilisateur et son domaine
                getUserWithSSO();
                
                // Charger la classification existante
                loadCurrentClassification();
                
                // Charger les destinataires
                loadRecipients();
                
                // √âcouter les changements de destinataires
                try {
                    Office.context.mailbox.item.to.addHandlerAsync(
                        Office.EventType.RecipientsChanged, loadRecipients
                    );
                    Office.context.mailbox.item.cc.addHandlerAsync(
                        Office.EventType.RecipientsChanged, loadRecipients
                    );
                } catch(e) {
                    console.log("RecipientsChanged not supported");
                }
            }
        });

        // === SSO : R√©cup√©rer l'utilisateur ===
        async function getUserWithSSO() {
            try {
                // M√©thode 1 : userProfile (le plus fiable)
                currentUserEmail = Office.context.mailbox.userProfile.emailAddress;
                
                if (currentUserEmail) {
                    const atIndex = currentUserEmail.indexOf('@');
                    if (atIndex > -1) {
                        internalDomain = currentUserEmail.substring(atIndex + 1).toLowerCase();
                    }
                    document.getElementById('userInfo').textContent = 'üë§ ' + currentUserEmail;
                    console.log('User:', currentUserEmail, 'Domain:', internalDomain);
                    return;
                }
            } catch(e) {
                console.log('userProfile error:', e);
            }
            
            try {
                // M√©thode 2 : SSO Token
                const token = await OfficeRuntime.auth.getAccessToken({ allowSignInPrompt: false });
                const payload = JSON.parse(atob(token.split('.')[1]));
                currentUserEmail = payload.preferred_username || payload.upn || payload.email || 'unknown';
                
                const atIndex = currentUserEmail.indexOf('@');
                if (atIndex > -1) {
                    internalDomain = currentUserEmail.substring(atIndex + 1).toLowerCase();
                }
                document.getElementById('userInfo').textContent = 'üë§ ' + currentUserEmail;
            } catch(e) {
                console.log('SSO error:', e);
                document.getElementById('userInfo').textContent = 'üë§ Non connect√©';
            }
        }

        function loadCurrentClassification() {
            Office.context.mailbox.item.loadCustomPropertiesAsync(function(result) {
                if (result.status === Office.AsyncResultStatus.Succeeded) {
                    const props = result.value;
                    const saved = props.get("MazeShield_Classification");
                    if (saved) {
                        currentClassification = saved;
                        updateUI();
                    }
                }
            });
        }

        function setClassification(level) {
            currentClassification = level;
            
            Office.context.mailbox.item.loadCustomPropertiesAsync(function(result) {
                if (result.status === Office.AsyncResultStatus.Succeeded) {
                    const props = result.value;
                    props.set("MazeShield_Classification", level);
                    props.saveAsync(function(saveResult) {
                        if (saveResult.status === Office.AsyncResultStatus.Succeeded) {
                            // Ajouter le label dans le sujet
                            updateSubjectWithLabel(level);
                            updateUI();
                            showStatus("‚úì Classification : " + level);
                        }
                    });
                }
            });
        }

        function updateSubjectWithLabel(level) {
            Office.context.mailbox.item.subject.getAsync(function(result) {
                if (result.status === Office.AsyncResultStatus.Succeeded) {
                    let subject = result.value || '';
                    // Enlever l'ancien label s'il existe
                    subject = subject.replace(/\[(PUBLIC|INTERNAL|CONFIDENTIAL|RESTRICTED)\]\s*/gi, '');
                    // Ajouter le nouveau
                    const newSubject = '[' + level.toUpperCase() + '] ' + subject;
                    Office.context.mailbox.item.subject.setAsync(newSubject);
                }
            });
        }

        function loadRecipients() {
            const allRecipients = [];
            let pending = 3;

            function done() {
                pending--;
                if (pending === 0) {
                    displayRecipients(allRecipients);
                }
            }

            Office.context.mailbox.item.to.getAsync(function(r) {
                if (r.status === Office.AsyncResultStatus.Succeeded) {
                    allRecipients.push(...r.value.map(x => ({ ...x, type: "To" })));
                }
                done();
            });

            Office.context.mailbox.item.cc.getAsync(function(r) {
                if (r.status === Office.AsyncResultStatus.Succeeded) {
                    allRecipients.push(...r.value.map(x => ({ ...x, type: "Cc" })));
                }
                done();
            });

            Office.context.mailbox.item.bcc.getAsync(function(r) {
                if (r.status === Office.AsyncResultStatus.Succeeded) {
                    allRecipients.push(...r.value.map(x => ({ ...x, type: "Bcc" })));
                }
                done();
            });
        }

        function displayRecipients(recipients) {
            const list = document.getElementById("recipientsList");
            hasExternalRecipients = false;

            if (recipients.length === 0) {
                list.innerHTML = '<div class="no-recipients">Aucun destinataire</div>';
                updateWarning();
                return;
            }

            let html = "";
            for (const r of recipients) {
                const email = r.emailAddress.toLowerCase();
                const domain = email.split("@")[1] || "";
                const isInternal = internalDomain && domain.toLowerCase() === internalDomain;
                
                if (!isInternal) hasExternalRecipients = true;

                html += `
                    <div class="recipient ${isInternal ? 'internal' : 'external'}">
                        <span class="badge ${isInternal ? 'internal' : 'external'}">
                            ${isInternal ? '‚úì INT' : '‚ö† EXT'}
                        </span>
                        <span style="flex:1;overflow:hidden;text-overflow:ellipsis;">
                            ${r.displayName || email}
                        </span>
                    </div>
                `;
            }
            list.innerHTML = html;
            updateWarning();
        }

        function updateUI() {
            document.querySelectorAll(".class-btn").forEach(btn => {
                btn.classList.toggle("selected", btn.dataset.class === currentClassification);
            });

            const display = document.getElementById("currentClass");
            if (currentClassification) {
                display.textContent = "Actuel : " + currentClassification;
                display.className = "current-class success";
            } else {
                display.textContent = "Aucune classification";
                display.className = "current-class info";
            }

            updateWarning();
        }

        function updateWarning() {
            const banner = document.getElementById("warningBanner");
            const isSensitive = SENSITIVE.includes(currentClassification);
            
            if (isSensitive && hasExternalRecipients) {
                banner.classList.add("visible");
            } else {
                banner.classList.remove("visible");
            }
        }

        function showStatus(msg) {
            const el = document.getElementById("statusMsg");
            el.textContent = msg;
            el.style.display = "block";
            setTimeout(() => { el.style.display = "none"; }, 3000);
        }
    </script>
</body>
</html>
