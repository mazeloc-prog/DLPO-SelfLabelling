<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>MazeShield Email</title>
    <script src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 100%; }
        
        /* Header */
        .header {
            text-align: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .logo { font-size: 24px; font-weight: 700; color: #00d4ff; }
        .subtitle { font-size: 12px; color: #888; margin-top: 4px; }
        
        /* Section */
        .section {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .section-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #888;
            margin-bottom: 12px;
        }
        
        /* Classification Buttons */
        .class-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        .class-btn {
            padding: 14px 12px;
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.2s;
            text-align: center;
        }
        .class-btn:hover { transform: scale(1.02); }
        .class-btn.selected { border-color: #fff; box-shadow: 0 0 20px rgba(255,255,255,0.2); }
        
        .class-public { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .class-internal { background: linear-gradient(135deg, #3498db, #2980b9); }
        .class-confidential { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .class-restricted { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        
        /* Recipients */
        .recipients-list {
            max-height: 150px;
            overflow-y: auto;
        }
        .recipient {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            margin-bottom: 6px;
            font-size: 13px;
        }
        .recipient.internal { border-left: 3px solid #2ecc71; }
        .recipient.external { border-left: 3px solid #e74c3c; }
        .badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }
        .badge.internal { background: #2ecc71; color: #000; }
        .badge.external { background: #e74c3c; color: #fff; }
        .no-recipients { color: #666; font-style: italic; font-size: 13px; }
        
        /* Warning Banner */
        .warning-banner {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 16px;
            display: none;
        }
        .warning-banner.visible { display: block; animation: pulse 2s infinite; }
        .warning-title { font-weight: 700; font-size: 14px; margin-bottom: 4px; }
        .warning-text { font-size: 12px; opacity: 0.9; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        /* Status */
        .status {
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            font-size: 12px;
            margin-top: 8px;
        }
        .status.success { background: rgba(46,204,113,0.2); color: #2ecc71; }
        .status.info { background: rgba(52,152,219,0.2); color: #3498db; }
        
        /* Current Classification Display */
        .current-class {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            font-weight: 600;
            margin-top: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">üõ°Ô∏è MazeShield</div>
            <div class="subtitle">Email Classification</div>
        </div>
        
        <!-- Warning Banner -->
        <div class="warning-banner" id="warningBanner">
            <div class="warning-title">‚ö†Ô∏è ATTENTION</div>
            <div class="warning-text">Email sensible vers destinataire externe !</div>
        </div>
        
        <!-- Classification -->
        <div class="section">
            <div class="section-title">Classification</div>
            <div class="class-grid">
                <button class="class-btn class-public" data-class="Public" onclick="setClassification('Public')">
                    üåê Public
                </button>
                <button class="class-btn class-internal" data-class="Internal" onclick="setClassification('Internal')">
                    üè¢ Internal
                </button>
                <button class="class-btn class-confidential" data-class="Confidential" onclick="setClassification('Confidential')">
                    üîí Confidential
                </button>
                <button class="class-btn class-restricted" data-class="Restricted" onclick="setClassification('Restricted')">
                    üö´ Restricted
                </button>
            </div>
            <div class="current-class status info" id="currentClass">
                No classification set
            </div>
        </div>
        
        <!-- Recipients -->
        <div class="section">
            <div class="section-title">Recipients</div>
            <div class="recipients-list" id="recipientsList">
                <div class="no-recipients">Loading recipients...</div>
            </div>
        </div>
        
        <!-- Status -->
        <div class="status success" id="statusMsg" style="display:none;"></div>
    </div>

    <script>
        // ‚ö†Ô∏è CONFIGURER - Domaines internes
        const INTERNAL_DOMAINS = [
            "votredomaine.com",
            "votredomaine.fr"
        ];
        
        const SENSITIVE = ["Confidential", "Restricted"];
        let currentClassification = null;
        let hasExternalRecipients = false;

        Office.onReady(function(info) {
            if (info.host === Office.HostType.Outlook) {
                loadCurrentClassification();
                loadRecipients();
                // Refresh recipients quand ils changent
                Office.context.mailbox.item.to.addHandlerAsync(
                    Office.EventType.RecipientsChanged, loadRecipients
                );
                Office.context.mailbox.item.cc.addHandlerAsync(
                    Office.EventType.RecipientsChanged, loadRecipients
                );
            }
        });

        function loadCurrentClassification() {
            Office.context.mailbox.item.loadCustomPropertiesAsync(function(result) {
                if (result.status === Office.AsyncResultStatus.Succeeded) {
                    const props = result.value;
                    const saved = props.get("MazeShield_Classification");
                    if (saved) {
                        currentClassification = saved;
                        updateUI();
                    }
                }
            });
        }

        function setClassification(level) {
            currentClassification = level;
            
            Office.context.mailbox.item.loadCustomPropertiesAsync(function(result) {
                if (result.status === Office.AsyncResultStatus.Succeeded) {
                    const props = result.value;
                    props.set("MazeShield_Classification", level);
                    props.saveAsync(function(saveResult) {
                        if (saveResult.status === Office.AsyncResultStatus.Succeeded) {
                            // Ajouter aussi dans le subject ou body pour visibilit√©
                            addClassificationHeader(level);
                            updateUI();
                            showStatus("Classification set: " + level);
                        }
                    });
                }
            });
        }

        function addClassificationHeader(level) {
            // Ajouter un header custom (visible dans les propri√©t√©s)
            Office.context.mailbox.item.internetHeaders.setAsync(
                { "X-MazeShield-Classification": level },
                function(result) {
                    console.log("Header set:", result.status);
                }
            );
        }

        function loadRecipients() {
            const list = document.getElementById("recipientsList");
            const allRecipients = [];
            let pending = 3;

            function done() {
                pending--;
                if (pending === 0) {
                    displayRecipients(allRecipients);
                }
            }

            Office.context.mailbox.item.to.getAsync(function(r) {
                if (r.status === Office.AsyncResultStatus.Succeeded) {
                    allRecipients.push(...r.value.map(x => ({ ...x, type: "To" })));
                }
                done();
            });

            Office.context.mailbox.item.cc.getAsync(function(r) {
                if (r.status === Office.AsyncResultStatus.Succeeded) {
                    allRecipients.push(...r.value.map(x => ({ ...x, type: "Cc" })));
                }
                done();
            });

            Office.context.mailbox.item.bcc.getAsync(function(r) {
                if (r.status === Office.AsyncResultStatus.Succeeded) {
                    allRecipients.push(...r.value.map(x => ({ ...x, type: "Bcc" })));
                }
                done();
            });
        }

        function displayRecipients(recipients) {
            const list = document.getElementById("recipientsList");
            hasExternalRecipients = false;

            if (recipients.length === 0) {
                list.innerHTML = '<div class="no-recipients">No recipients yet</div>';
                updateWarning();
                return;
            }

            let html = "";
            for (const r of recipients) {
                const email = r.emailAddress.toLowerCase();
                const domain = email.split("@")[1] || "";
                const isInternal = INTERNAL_DOMAINS.some(d => domain.toLowerCase() === d.toLowerCase());
                
                if (!isInternal) hasExternalRecipients = true;

                html += `
                    <div class="recipient ${isInternal ? 'internal' : 'external'}">
                        <span class="badge ${isInternal ? 'internal' : 'external'}">
                            ${isInternal ? '‚úì INT' : '‚ö† EXT'}
                        </span>
                        <span style="flex:1;overflow:hidden;text-overflow:ellipsis;">
                            ${r.displayName || email}
                        </span>
                    </div>
                `;
            }
            list.innerHTML = html;
            updateWarning();
        }

        function updateUI() {
            // Update selected button
            document.querySelectorAll(".class-btn").forEach(btn => {
                btn.classList.toggle("selected", btn.dataset.class === currentClassification);
            });

            // Update current class display
            const display = document.getElementById("currentClass");
            if (currentClassification) {
                display.textContent = "Current: " + currentClassification;
                display.className = "current-class status success";
            } else {
                display.textContent = "No classification set";
                display.className = "current-class status info";
            }

            updateWarning();
        }

        function updateWarning() {
            const banner = document.getElementById("warningBanner");
            const isSensitive = SENSITIVE.includes(currentClassification);
            
            if (isSensitive && hasExternalRecipients) {
                banner.classList.add("visible");
            } else {
                banner.classList.remove("visible");
            }
        }

        function showStatus(msg) {
            const el = document.getElementById("statusMsg");
            el.textContent = msg;
            el.style.display = "block";
            setTimeout(() => { el.style.display = "none"; }, 3000);
        }
    </script>
</body>
</html>
