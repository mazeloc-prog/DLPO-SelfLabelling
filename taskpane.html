<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MazeShield Classification</title>
    <script src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
            max-width: 350px;
            margin: 0 auto;
        }
        .header {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h1 { font-size: 18px; margin-bottom: 5px; }
        .header p { font-size: 12px; opacity: 0.8; }
        .header .user-info { 
            font-size: 11px; 
            opacity: 0.9; 
            margin-top: 8px; 
            padding: 4px 10px; 
            background: rgba(255,255,255,0.15); 
            border-radius: 12px; 
            display: inline-block; 
        }
        .lang-selector {
            position: absolute;
            top: 10px;
            right: 10px;
        }
        .lang-selector select {
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .content { padding: 20px; }
        
        .current-label {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        .current-label-title { 
            font-size: 11px; 
            color: #666; 
            margin-bottom: 8px; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
        }
        .current-label-value {
            font-size: 16px;
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
        }
        .current-label-value.public { background: #d1fae5; color: #065f46; }
        .current-label-value.internal { background: #dbeafe; color: #1e40af; }
        .current-label-value.confidential { background: #fef3c7; color: #92400e; }
        .current-label-value.restricted { background: #fee2e2; color: #991b1b; }
        
        .section-title { 
            font-size: 11px; 
            color: #666; 
            margin-bottom: 10px; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
        }
        
        .labels-grid { display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; }
        .label-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .label-btn:hover { border-color: #667eea; background: #f8f9ff; }
        .label-btn.active { border-color: #667eea; background: #eff1ff; }
        .label-btn .dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }
        .label-btn .dot.public { background: #10b981; }
        .label-btn .dot.internal { background: #3b82f6; }
        .label-btn .dot.confidential { background: #f59e0b; }
        .label-btn .dot.restricted { background: #ef4444; }
        .label-btn .info { flex: 1; text-align: left; }
        .label-btn .name { font-weight: 600; font-size: 14px; color: #333; }
        .label-btn .desc { font-size: 11px; color: #666; }
        .label-btn .check { 
            width: 20px; 
            height: 20px; 
            border-radius: 50%; 
            border: 2px solid #e0e0e0; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-size: 12px;
            color: white;
        }
        .label-btn.active .check { background: #667eea; border-color: #667eea; }
        
        .options {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .options label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: #333;
            margin-bottom: 8px;
            cursor: pointer;
        }
        .options label:last-child { margin-bottom: 0; }
        .options input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #667eea;
        }
        
        .status {
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-size: 13px;
            margin-bottom: 15px;
            display: none;
        }
        .status.success { display: block; background: #d1fae5; color: #065f46; }
        .status.error { display: block; background: #fee2e2; color: #991b1b; }
        .status.info { display: block; background: #dbeafe; color: #1e40af; }
        
        .footer {
            text-align: center;
            padding: 15px;
            font-size: 11px;
            color: #999;
            border-top: 1px solid #eee;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 320px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .modal h3 { font-size: 16px; margin-bottom: 8px; color: #333; }
        .modal p { font-size: 13px; color: #666; margin-bottom: 16px; }
        .modal .warning { 
            background: #fef3c7; 
            border: 1px solid #f59e0b; 
            border-radius: 8px; 
            padding: 12px; 
            margin-bottom: 16px;
            font-size: 12px;
            color: #92400e;
        }
        .modal .options-list { margin-bottom: 16px; }
        .modal .options-list label {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .modal .options-list label:hover { background: #f8f9fa; }
        .modal .options-list input[type="radio"] { margin-top: 2px; }
        .modal .options-list .option-text { font-size: 13px; color: #333; }
        .modal textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 13px;
            resize: vertical;
            min-height: 60px;
            margin-bottom: 16px;
            display: none;
        }
        .modal textarea.visible { display: block; }
        .modal .buttons { display: flex; gap: 10px; }
        .modal button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .modal .btn-cancel { background: #e0e0e0; color: #333; }
        .modal .btn-cancel:hover { background: #d0d0d0; }
        .modal .btn-confirm { background: #667eea; color: white; }
        .modal .btn-confirm:hover { background: #5a6fd6; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header" style="position: relative;">
            <div class="lang-selector">
                <select id="langSelect" onchange="changeLanguage(this.value)">
                    <option value="en">EN</option>
                    <option value="fr">FR</option>
                    <option value="de">DE</option>
                    <option value="es">ES</option>
                    <option value="ar">AR</option>
                </select>
            </div>
            <h1>üõ°Ô∏è MazeShield</h1>
            <p id="headerSubtitle">Document Classification</p>
            <div class="user-info" id="userInfo">Loading...</div>
        </div>
        
        <div class="content">
            <div class="current-label">
                <div class="current-label-title" id="currentLabelTitle">Current Classification</div>
                <div class="current-label-value" id="currentLabel">Not classified</div>
            </div>
            
            <div class="section-title" id="chooseLabelTitle">Choose a label</div>
            <div class="labels-grid" id="labelsGrid"></div>
            
            <div class="options">
                <div class="section-title" id="optionsTitle">Options</div>
                <label><input type="checkbox" id="addHeader" checked> <span id="optHeader">Add header</span></label>
                <label><input type="checkbox" id="addFooter" checked> <span id="optFooter">Add footer</span></label>
                <label><input type="checkbox" id="addWatermark"> <span id="optWatermark">Add watermark</span></label>
            </div>
            
            <div class="status" id="status"></div>
        </div>
        
        <div class="footer">MazeShield v2.1 - Email Fix</div>
    </div>

    <!-- Modal Justification -->
    <div class="modal-overlay" id="justificationModal">
        <div class="modal">
            <h3 id="modalTitle">‚ö†Ô∏è Justification Required</h3>
            <p id="modalDesc">You are lowering the classification level. Please provide a justification:</p>
            <div class="warning" id="modalWarning">
                <strong id="modalFrom">From:</strong> <span id="fromLabel">-</span><br>
                <strong id="modalTo">To:</strong> <span id="toLabel">-</span>
            </div>
            <div class="options-list">
                <label><input type="radio" name="justification" value="manager_approved"> <span class="option-text" id="justOpt1">My manager approved this change</span></label>
                <label><input type="radio" name="justification" value="data_removed"> <span class="option-text" id="justOpt2">Sensitive data has been removed</span></label>
                <label><input type="radio" name="justification" value="classification_error"> <span class="option-text" id="justOpt3">Initial classification was incorrect</span></label>
                <label><input type="radio" name="justification" value="other"> <span class="option-text" id="justOpt4">Other reason</span></label>
            </div>
            <textarea id="otherReason" placeholder="Please specify..."></textarea>
            <div class="buttons">
                <button class="btn-cancel" onclick="closeModal()" id="btnCancel">Cancel</button>
                <button class="btn-confirm" onclick="confirmJustification()" id="btnConfirm">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // ============== CONFIGURATION ==============
        const LABELS = [
            { id: 'public', priority: 1, color: '#10b981' },
            { id: 'internal', priority: 2, color: '#3b82f6' },
            { id: 'confidential', priority: 3, color: '#f59e0b' },
            { id: 'restricted', priority: 4, color: '#ef4444' }
        ];

        const AUDIT_URL = 'https://dlpo-audit-api.azurewebsites.net/api/log-event';

        // ============== i18n ==============
        const TRANSLATIONS = {
            en: {
                headerSubtitle: 'Document Classification',
                currentLabelTitle: 'Current Classification',
                notClassified: 'Not classified',
                chooseLabelTitle: 'Choose a label',
                optionsTitle: 'Options',
                optHeader: 'Add header',
                optFooter: 'Add footer',
                optWatermark: 'Add watermark',
                modalTitle: '‚ö†Ô∏è Justification Required',
                modalDesc: 'You are lowering the classification level. Please provide a justification:',
                modalFrom: 'From:',
                modalTo: 'To:',
                justOpt1: 'My manager approved this change',
                justOpt2: 'Sensitive data has been removed',
                justOpt3: 'Initial classification was incorrect',
                justOpt4: 'Other reason',
                btnCancel: 'Cancel',
                btnConfirm: 'Confirm',
                successApplied: 'Classification applied!',
                labels: {
                    public: { name: 'Public', desc: 'Can be shared freely' },
                    internal: { name: 'Internal', desc: 'Internal use only' },
                    confidential: { name: 'Confidential', desc: 'Restricted access' },
                    restricted: { name: 'Restricted', desc: 'Highly sensitive' }
                }
            },
            fr: {
                headerSubtitle: 'Classification des documents',
                currentLabelTitle: 'Classification actuelle',
                notClassified: 'Non classifi√©',
                chooseLabelTitle: 'Choisir un label',
                optionsTitle: 'Options',
                optHeader: 'Ajouter en-t√™te',
                optFooter: 'Ajouter pied de page',
                optWatermark: 'Ajouter filigrane',
                modalTitle: '‚ö†Ô∏è Justification requise',
                modalDesc: 'Vous abaissez le niveau de classification. Veuillez justifier :',
                modalFrom: 'De :',
                modalTo: 'Vers :',
                justOpt1: 'Mon manager a approuv√© ce changement',
                justOpt2: 'Les donn√©es sensibles ont √©t√© retir√©es',
                justOpt3: 'La classification initiale √©tait incorrecte',
                justOpt4: 'Autre raison',
                btnCancel: 'Annuler',
                btnConfirm: 'Confirmer',
                successApplied: 'Classification appliqu√©e !',
                labels: {
                    public: { name: 'Public', desc: 'Peut √™tre partag√© librement' },
                    internal: { name: 'Interne', desc: 'Usage interne uniquement' },
                    confidential: { name: 'Confidentiel', desc: 'Acc√®s restreint' },
                    restricted: { name: 'Restreint', desc: 'Tr√®s sensible' }
                }
            },
            de: {
                headerSubtitle: 'Dokumentenklassifizierung',
                currentLabelTitle: 'Aktuelle Klassifizierung',
                notClassified: 'Nicht klassifiziert',
                chooseLabelTitle: 'Label ausw√§hlen',
                optionsTitle: 'Optionen',
                optHeader: 'Kopfzeile hinzuf√ºgen',
                optFooter: 'Fu√üzeile hinzuf√ºgen',
                optWatermark: 'Wasserzeichen hinzuf√ºgen',
                modalTitle: '‚ö†Ô∏è Begr√ºndung erforderlich',
                modalDesc: 'Sie senken die Klassifizierungsstufe. Bitte begr√ºnden Sie:',
                modalFrom: 'Von:',
                modalTo: 'Nach:',
                justOpt1: 'Mein Vorgesetzter hat diese √Ñnderung genehmigt',
                justOpt2: 'Sensible Daten wurden entfernt',
                justOpt3: 'Die urspr√ºngliche Klassifizierung war falsch',
                justOpt4: 'Anderer Grund',
                btnCancel: 'Abbrechen',
                btnConfirm: 'Best√§tigen',
                successApplied: 'Klassifizierung angewendet!',
                labels: {
                    public: { name: '√ñffentlich', desc: 'Kann frei geteilt werden' },
                    internal: { name: 'Intern', desc: 'Nur f√ºr internen Gebrauch' },
                    confidential: { name: 'Vertraulich', desc: 'Eingeschr√§nkter Zugang' },
                    restricted: { name: 'Streng vertraulich', desc: 'Hochsensibel' }
                }
            },
            es: {
                headerSubtitle: 'Clasificaci√≥n de documentos',
                currentLabelTitle: 'Clasificaci√≥n actual',
                notClassified: 'Sin clasificar',
                chooseLabelTitle: 'Elegir etiqueta',
                optionsTitle: 'Opciones',
                optHeader: 'A√±adir encabezado',
                optFooter: 'A√±adir pie de p√°gina',
                optWatermark: 'A√±adir marca de agua',
                modalTitle: '‚ö†Ô∏è Justificaci√≥n requerida',
                modalDesc: 'Est√° reduciendo el nivel de clasificaci√≥n. Por favor justifique:',
                modalFrom: 'De:',
                modalTo: 'A:',
                justOpt1: 'Mi gerente aprob√≥ este cambio',
                justOpt2: 'Los datos sensibles han sido eliminados',
                justOpt3: 'La clasificaci√≥n inicial era incorrecta',
                justOpt4: 'Otra raz√≥n',
                btnCancel: 'Cancelar',
                btnConfirm: 'Confirmar',
                successApplied: '¬°Clasificaci√≥n aplicada!',
                labels: {
                    public: { name: 'P√∫blico', desc: 'Se puede compartir libremente' },
                    internal: { name: 'Interno', desc: 'Solo uso interno' },
                    confidential: { name: 'Confidencial', desc: 'Acceso restringido' },
                    restricted: { name: 'Restringido', desc: 'Altamente sensible' }
                }
            },
            ar: {
                headerSubtitle: 'ÿ™ÿµŸÜŸäŸÅ ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØÿßÿ™',
                currentLabelTitle: 'ÿßŸÑÿ™ÿµŸÜŸäŸÅ ÿßŸÑÿ≠ÿßŸÑŸä',
                notClassified: 'ÿ∫Ÿäÿ± ŸÖÿµŸÜŸÅ',
                chooseLabelTitle: 'ÿßÿÆÿ™ÿ± ÿ™ÿµŸÜŸäŸÅ',
                optionsTitle: 'ÿÆŸäÿßÿ±ÿßÿ™',
                optHeader: 'ÿ•ÿ∂ÿßŸÅÿ© ÿ±ÿ£ÿ≥',
                optFooter: 'ÿ•ÿ∂ÿßŸÅÿ© ÿ™ÿ∞ŸäŸäŸÑ',
                optWatermark: 'ÿ•ÿ∂ÿßŸÅÿ© ÿπŸÑÿßŸÖÿ© ŸÖÿßÿ¶Ÿäÿ©',
                modalTitle: '‚ö†Ô∏è ŸÖÿ∑ŸÑŸàÿ® ÿ™ÿ®ÿ±Ÿäÿ±',
                modalDesc: 'ÿ£ŸÜÿ™ ÿ™ÿÆŸÅÿ∂ ŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿ™ÿµŸÜŸäŸÅ. Ÿäÿ±ÿ¨Ÿâ ÿ™ŸÇÿØŸäŸÖ ÿ™ÿ®ÿ±Ÿäÿ±:',
                modalFrom: 'ŸÖŸÜ:',
                modalTo: 'ÿ•ŸÑŸâ:',
                justOpt1: 'ŸàÿßŸÅŸÇ ŸÖÿØŸäÿ±Ÿä ÿπŸÑŸâ Ÿáÿ∞ÿß ÿßŸÑÿ™ÿ∫ŸäŸäÿ±',
                justOpt2: 'ÿ™ŸÖÿ™ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿ≥ÿßÿ≥ÿ©',
                justOpt3: 'ŸÉÿßŸÜ ÿßŸÑÿ™ÿµŸÜŸäŸÅ ÿßŸÑÿ£ŸàŸÑŸä ÿÆÿßÿ∑ÿ¶Ÿãÿß',
                justOpt4: 'ÿ≥ÿ®ÿ® ÿ¢ÿÆÿ±',
                btnCancel: 'ÿ•ŸÑÿ∫ÿßÿ°',
                btnConfirm: 'ÿ™ÿ£ŸÉŸäÿØ',
                successApplied: 'ÿ™ŸÖ ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ™ÿµŸÜŸäŸÅ!',
                labels: {
                    public: { name: 'ÿπÿßŸÖ', desc: 'ŸäŸÖŸÉŸÜ ŸÖÿ¥ÿßÿ±ŸÉÿ™Ÿá ÿ®ÿ≠ÿ±Ÿäÿ©' },
                    internal: { name: 'ÿØÿßÿÆŸÑŸä', desc: 'ŸÑŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿØÿßÿÆŸÑŸä ŸÅŸÇÿ∑' },
                    confidential: { name: 'ÿ≥ÿ±Ÿä', desc: 'ŸàÿµŸàŸÑ ŸÖŸÇŸäÿØ' },
                    restricted: { name: 'ŸÖŸÇŸäÿØ', desc: 'ÿ≠ÿ≥ÿßÿ≥ ŸÑŸÑÿ∫ÿßŸäÿ©' }
                }
            }
        };

        let currentLang = 'en';
        let currentUserEmail = 'unknown';
        let currentLabelId = null;
        let currentLabelPriority = 0;
        let pendingLabel = null;

        // ============== OFFICE.JS INIT ==============
        Office.onReady(async (info) => {
            console.log('Office.js ready:', info.host);
            
            const browserLang = navigator.language.substring(0, 2);
            if (TRANSLATIONS[browserLang]) {
                currentLang = browserLang;
                document.getElementById('langSelect').value = currentLang;
            }
            
            await getUserEmail();
            applyTranslations();
            renderLabels();
            await loadCurrentLabel();
        });

        // ============== SSO ==============
        async function getUserEmail() {
            try {
                const tokenResponse = await OfficeRuntime.auth.getAccessToken({ allowSignInPrompt: false });
                const payload = JSON.parse(atob(tokenResponse.split('.')[1]));
                currentUserEmail = payload.preferred_username || payload.upn || payload.email || 'unknown';
            } catch (e) {
                console.log('SSO failed, trying mailbox...', e);
                try {
                    if (Office.context.mailbox && Office.context.mailbox.userProfile) {
                        currentUserEmail = Office.context.mailbox.userProfile.emailAddress;
                    }
                } catch (e2) {
                    console.log('Mailbox fallback failed', e2);
                }
            }
            document.getElementById('userInfo').textContent = 'üë§ ' + currentUserEmail;
        }

        // ============== LANGUAGE ==============
        function changeLanguage(lang) {
            currentLang = lang;
            applyTranslations();
            renderLabels();
            updateCurrentLabelDisplay();
        }

        function applyTranslations() {
            const t = TRANSLATIONS[currentLang];
            document.getElementById('headerSubtitle').textContent = t.headerSubtitle;
            document.getElementById('currentLabelTitle').textContent = t.currentLabelTitle;
            document.getElementById('chooseLabelTitle').textContent = t.chooseLabelTitle;
            document.getElementById('optionsTitle').textContent = t.optionsTitle;
            document.getElementById('optHeader').textContent = t.optHeader;
            document.getElementById('optFooter').textContent = t.optFooter;
            document.getElementById('optWatermark').textContent = t.optWatermark;
            document.getElementById('modalTitle').textContent = t.modalTitle;
            document.getElementById('modalDesc').textContent = t.modalDesc;
            document.getElementById('modalFrom').textContent = t.modalFrom;
            document.getElementById('modalTo').textContent = t.modalTo;
            document.getElementById('justOpt1').textContent = t.justOpt1;
            document.getElementById('justOpt2').textContent = t.justOpt2;
            document.getElementById('justOpt3').textContent = t.justOpt3;
            document.getElementById('justOpt4').textContent = t.justOpt4;
            document.getElementById('btnCancel').textContent = t.btnCancel;
            document.getElementById('btnConfirm').textContent = t.btnConfirm;
        }

        // ============== RENDER LABELS ==============
        function renderLabels() {
            const t = TRANSLATIONS[currentLang];
            const grid = document.getElementById('labelsGrid');
            grid.innerHTML = LABELS.map(label => `
                <div class="label-btn ${currentLabelId === label.id ? 'active' : ''}" onclick="selectLabel('${label.id}')">
                    <div class="dot ${label.id}"></div>
                    <div class="info">
                        <div class="name">${t.labels[label.id].name}</div>
                        <div class="desc">${t.labels[label.id].desc}</div>
                    </div>
                    <div class="check">${currentLabelId === label.id ? '‚úì' : ''}</div>
                </div>
            `).join('');
        }

        // ============== SELECT LABEL ==============
        function selectLabel(labelId) {
            const label = LABELS.find(l => l.id === labelId);
            
            if (currentLabelPriority > 0 && label.priority < currentLabelPriority) {
                pendingLabel = label;
                showJustificationModal(currentLabelId, labelId);
                return;
            }
            
            applyLabel(label, null);
        }

        // ============== JUSTIFICATION MODAL ==============
        function showJustificationModal(fromLabel, toLabel) {
            const t = TRANSLATIONS[currentLang];
            document.getElementById('fromLabel').textContent = t.labels[fromLabel].name;
            document.getElementById('toLabel').textContent = t.labels[toLabel].name;
            document.getElementById('justificationModal').classList.add('active');
            
            document.querySelectorAll('input[name="justification"]').forEach(r => r.checked = false);
            document.getElementById('otherReason').value = '';
            document.getElementById('otherReason').classList.remove('visible');
            
            document.querySelectorAll('input[name="justification"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    const textarea = document.getElementById('otherReason');
                    if (radio.value === 'other' && radio.checked) {
                        textarea.classList.add('visible');
                    } else {
                        textarea.classList.remove('visible');
                    }
                });
            });
        }

        function closeModal() {
            document.getElementById('justificationModal').classList.remove('active');
            pendingLabel = null;
        }

        function confirmJustification() {
            const selected = document.querySelector('input[name="justification"]:checked');
            if (!selected) {
                alert('Please select a justification');
                return;
            }
            
            if (!pendingLabel) {
                console.error('pendingLabel is null');
                closeModal();
                return;
            }
            
            const t = TRANSLATIONS[currentLang];
            let justificationText = '';
            switch(selected.value) {
                case 'manager_approved': justificationText = t.justOpt1; break;
                case 'data_removed': justificationText = t.justOpt2; break;
                case 'classification_error': justificationText = t.justOpt3; break;
                case 'other': justificationText = document.getElementById('otherReason').value || 'Other'; break;
            }
            
            const justification = {
                code: selected.value,
                text: justificationText,
                from: currentLabelId,
                to: pendingLabel.id,
                timestamp: new Date().toISOString()
            };
            
            const labelToApply = pendingLabel;
            closeModal();
            applyLabel(labelToApply, justification);
        }

        // ============== APPLY LABEL ==============
        async function applyLabel(label, justification) {
            try {
                showStatus('info', 'Applying...');
                
                const host = Office.context.host;
                const addHeader = document.getElementById('addHeader').checked;
                const addFooter = document.getElementById('addFooter').checked;
                const addWatermark = document.getElementById('addWatermark').checked;
                
                const t = TRANSLATIONS[currentLang];
                const labelName = t.labels[label.id].name.toUpperCase();
                
                if (host === Office.HostType.Word) {
                    await applyToWord(label, labelName, addHeader, addFooter, addWatermark, justification);
                } else if (host === Office.HostType.Excel) {
                    await applyToExcel(label, labelName, addHeader, addFooter, justification);
                } else if (host === Office.HostType.PowerPoint) {
                    await applyToPowerPoint(label, labelName, justification);
                }
                
                currentLabelId = label.id;
                currentLabelPriority = label.priority;
                renderLabels();
                updateCurrentLabelDisplay();
                
                // ‚úÖ ENVOI AUDIT LOG CORRIG√â
                await sendAuditLog(label, justification);
                
                showStatus('success', t.successApplied);
                setTimeout(() => hideStatus(), 3000);
                
            } catch (error) {
                console.error('Error applying label:', error);
                showStatus('error', 'Error: ' + error.message);
            }
        }

        // ============== WORD ==============
        async function applyToWord(label, labelName, addHeader, addFooter, addWatermark, justification) {
            await Word.run(async (context) => {
                const doc = context.document;
                
                doc.properties.customProperties.add('_DLPO_Classification', label.id);
                doc.properties.customProperties.add('_DLPO_ClassifiedAt', new Date().toISOString());
                doc.properties.customProperties.add('_DLPO_ClassifiedBy', currentUserEmail);
                
                if (justification) {
                    doc.properties.customProperties.add('_DLPO_DowngradedFrom', justification.from);
                    doc.properties.customProperties.add('_DLPO_DowngradedAt', justification.timestamp);
                    doc.properties.customProperties.add('_DLPO_DowngradeJustification', justification.code);
                    doc.properties.customProperties.add('_DLPO_DowngradeReason', justification.text);
                }
                
                if (addHeader) {
                    const header = doc.sections.getFirst().getHeader('Primary');
                    header.clear();
                    const para = header.insertParagraph(`[${labelName}]`, 'Start');
                    para.font.bold = true;
                    para.font.color = label.color;
                    para.alignment = 'Centered';
                }
                
                if (addFooter) {
                    const footer = doc.sections.getFirst().getFooter('Primary');
                    footer.clear();
                    const para = footer.insertParagraph(`Classification: ${labelName}`, 'Start');
                    para.font.size = 10;
                    para.font.color = '#666666';
                    para.alignment = 'Centered';
                }
                
                await context.sync();
            });
        }

        // ============== EXCEL ==============
        async function applyToExcel(label, labelName, addHeader, addFooter, justification) {
            await Excel.run(async (context) => {
                const workbook = context.workbook;
                
                workbook.properties.custom.add('_DLPO_Classification', label.id);
                workbook.properties.custom.add('_DLPO_ClassifiedAt', new Date().toISOString());
                workbook.properties.custom.add('_DLPO_ClassifiedBy', currentUserEmail);
                
                if (justification) {
                    workbook.properties.custom.add('_DLPO_DowngradedFrom', justification.from);
                    workbook.properties.custom.add('_DLPO_DowngradedAt', justification.timestamp);
                    workbook.properties.custom.add('_DLPO_DowngradeJustification', justification.code);
                    workbook.properties.custom.add('_DLPO_DowngradeReason', justification.text);
                }
                
                const sheet = workbook.worksheets.getActiveWorksheet();
                const pageLayout = sheet.pageLayout;
                
                if (addHeader) {
                    pageLayout.centerHeader = `&B[${labelName}]`;
                }
                if (addFooter) {
                    pageLayout.centerFooter = `Classification: ${labelName}`;
                }
                
                await context.sync();
            });
        }

        // ============== POWERPOINT ==============
        async function applyToPowerPoint(label, labelName, justification) {
            await PowerPoint.run(async (context) => {
                const presentation = context.presentation;
                
                presentation.tags.add('_DLPO_Classification', label.id);
                presentation.tags.add('_DLPO_ClassifiedAt', new Date().toISOString());
                presentation.tags.add('_DLPO_ClassifiedBy', currentUserEmail);
                
                if (justification) {
                    presentation.tags.add('_DLPO_DowngradedFrom', justification.from);
                    presentation.tags.add('_DLPO_DowngradedAt', justification.timestamp);
                    presentation.tags.add('_DLPO_DowngradeJustification', justification.code);
                    presentation.tags.add('_DLPO_DowngradeReason', justification.text);
                }
                
                await context.sync();
            });
        }

        // ============== LOAD CURRENT LABEL ==============
        async function loadCurrentLabel() {
            try {
                const host = Office.context.host;
                let label = null;
                
                if (host === Office.HostType.Word) {
                    await Word.run(async (context) => {
                        const props = context.document.properties.customProperties;
                        props.load('items');
                        await context.sync();
                        for (let item of props.items) {
                            if (item.key === '_DLPO_Classification') {
                                label = item.value;
                                break;
                            }
                        }
                    });
                } else if (host === Office.HostType.Excel) {
                    await Excel.run(async (context) => {
                        const props = context.workbook.properties.custom;
                        props.load('items');
                        await context.sync();
                        for (let item of props.items) {
                            if (item.key === '_DLPO_Classification') {
                                label = item.value;
                                break;
                            }
                        }
                    });
                } else if (host === Office.HostType.PowerPoint) {
                    await PowerPoint.run(async (context) => {
                        const tags = context.presentation.tags;
                        tags.load('items');
                        await context.sync();
                        for (let item of tags.items) {
                            if (item.key === '_DLPO_Classification') {
                                label = item.value;
                                break;
                            }
                        }
                    });
                }
                
                if (label) {
                    currentLabelId = label;
                    const labelObj = LABELS.find(l => l.id === label);
                    if (labelObj) currentLabelPriority = labelObj.priority;
                    renderLabels();
                    updateCurrentLabelDisplay();
                }
            } catch (e) {
                console.log('Error loading label:', e);
            }
        }

        function updateCurrentLabelDisplay() {
            const t = TRANSLATIONS[currentLang];
            const el = document.getElementById('currentLabel');
            
            if (currentLabelId) {
                el.textContent = t.labels[currentLabelId].name;
                el.className = 'current-label-value ' + currentLabelId;
            } else {
                el.textContent = t.notClassified;
                el.className = 'current-label-value';
            }
        }

        // ============== AUDIT LOG - CORRIG√â POUR EMAIL ==============
        async function sendAuditLog(label, justification) {
            try {
                const t = TRANSLATIONS[currentLang];
                const docUrl = Office.context.document?.url || 'unknown';
                const docName = docUrl.split('/').pop() || docUrl;
                
                // ‚úÖ FORMAT CORRIG√â - Champs √† la racine pour Azure Function
                const payload = {
                    // Infos de base
                    TenantId: 'mazeloc',
                    User: currentUserEmail,
                    DocumentName: docName,
                    DocumentUrl: docUrl,
                    App: Office.context.host,
                    Timestamp: new Date().toISOString(),
                    
                    // Classification
                    Label: label.id,
                    LabelName: t.labels[label.id].name,
                    
                    // ‚úÖ IMPORTANT: Action et champs justification √† la RACINE
                    Action: justification ? 'LABEL_DOWNGRADE' : 'CLASSIFY',
                    PreviousLabel: justification ? justification.from : null,
                    
                    // ‚úÖ Champs sp√©cifiques pour l'email (Azure Function les attend)
                    JustificationFrom: justification ? justification.from : null,
                    JustificationTo: justification ? justification.to : null,
                    JustificationCode: justification ? justification.code : null,
                    JustificationText: justification ? justification.text : null,
                    JustificationTimestamp: justification ? justification.timestamp : null
                };
                
                console.log('üì§ Sending audit log:', payload);
                
                const response = await fetch(AUDIT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                console.log('üì• Audit log response:', result);
                
                if (justification) {
                    console.log('üìß Email should be sent for LABEL_DOWNGRADE');
                }
                
            } catch (e) {
                console.error('‚ùå Audit log failed:', e);
            }
        }

        // ============== STATUS ==============
        function showStatus(type, message) {
            const el = document.getElementById('status');
            el.className = 'status ' + type;
            el.textContent = message;
        }

        function hideStatus() {
            document.getElementById('status').className = 'status';
        }
    </script>
</body>
</html>
