<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DLPO Classification</title>
    <script src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { max-width: 400px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; color: white; margin-bottom: 30px; padding-top: 20px; }
        .header h1 { font-size: 28px; margin-bottom: 5px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .header p { opacity: 0.9; font-size: 14px; }
        .user-info { background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 20px; display: inline-block; margin-top: 10px; font-size: 12px; }
        .card { background: white; border-radius: 16px; padding: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .section-title { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: #666; margin-bottom: 15px; font-weight: 600; }
        .current-label { background: #f8f9fa; border-radius: 12px; padding: 15px; margin-bottom: 25px; text-align: center; }
        .current-label-value { font-size: 18px; font-weight: 700; margin-top: 5px; }
        .current-label-value.public { color: #10b981; }
        .current-label-value.internal { color: #3b82f6; }
        .current-label-value.confidential { color: #f59e0b; }
        .current-label-value.restricted { color: #ef4444; }
        .labels-grid { display: grid; gap: 12px; margin-bottom: 25px; }
        .label-btn { display: flex; align-items: center; padding: 16px; border: 2px solid #e5e7eb; border-radius: 12px; background: white; cursor: pointer; transition: all 0.2s; }
        .label-btn:hover { border-color: #667eea; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102,126,234,0.3); }
        .label-btn.active { border-color: #667eea; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .label-btn.active .label-icon { background: rgba(255,255,255,0.3); }
        .label-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 18px; }
        .label-icon.public { background: #d1fae5; }
        .label-icon.internal { background: #dbeafe; }
        .label-icon.confidential { background: #fef3c7; }
        .label-icon.restricted { background: #fee2e2; }
        .label-info h3 { font-size: 16px; margin-bottom: 3px; }
        .label-info p { font-size: 12px; color: #666; }
        .label-btn.active .label-info p { color: rgba(255,255,255,0.8); }
        .status { padding: 12px; border-radius: 8px; margin-top: 15px; text-align: center; font-size: 14px; display: none; }
        .status.success { display: block; background: #d1fae5; color: #065f46; }
        .status.error { display: block; background: #fee2e2; color: #991b1b; }
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .loading-overlay.show { display: flex; }
        .spinner { width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Modal Justification */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 2000; }
        .modal-overlay.show { display: flex; }
        .modal { background: white; border-radius: 16px; padding: 30px; max-width: 400px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal h2 { color: #dc2626; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .modal p { color: #666; margin-bottom: 20px; font-size: 14px; }
        .justification-options { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .justification-option { display: flex; align-items: center; padding: 12px 15px; border: 2px solid #e5e7eb; border-radius: 10px; cursor: pointer; transition: all 0.2s; }
        .justification-option:hover { border-color: #667eea; background: #f8f9ff; }
        .justification-option.selected { border-color: #667eea; background: #667eea; color: white; }
        .justification-option input { display: none; }
        .justification-option .radio-circle { width: 20px; height: 20px; border: 2px solid #ccc; border-radius: 50%; margin-right: 12px; display: flex; align-items: center; justify-content: center; }
        .justification-option.selected .radio-circle { border-color: white; background: white; }
        .justification-option.selected .radio-circle::after { content: ''; width: 10px; height: 10px; background: #667eea; border-radius: 50%; }
        .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; }
        .btn { padding: 12px 24px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; border: none; transition: all 0.2s; }
        .btn-cancel { background: #f3f4f6; color: #374151; }
        .btn-cancel:hover { background: #e5e7eb; }
        .btn-confirm { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-confirm:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102,126,234,0.4); }
        .btn-confirm:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .downgrade-info { background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 12px; margin-bottom: 15px; font-size: 13px; }
        .downgrade-info strong { color: #92400e; }

        /* Language selector */
        .lang-selector { position: absolute; top: 10px; right: 10px; }
        .lang-selector select { padding: 5px 10px; border-radius: 5px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.2); color: white; font-size: 12px; cursor: pointer; }
        .lang-selector select option { color: #333; }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div></div>
    
    <div class="container">
        <div class="header" style="position: relative;">
            <div class="lang-selector">
                <select id="langSelect" onchange="changeLanguage(this.value)">
                    <option value="en">EN</option>
                    <option value="fr">FR</option>
                </select>
            </div>
            <h1>üõ°Ô∏è MazeShield</h1>
            <p id="headerSubtitle">Document Classification</p>
            <div class="user-info" id="userInfo">Loading...</div>
        </div>
        
        <div class="card">
            <div class="current-label">
                <div class="section-title" id="currentLabelTitle">Current Classification</div>
                <div class="current-label-value" id="currentLabel">Not classified</div>
            </div>
            
            <div class="section-title" id="chooseLabelTitle">Choose a classification</div>
            <div class="labels-grid" id="labelsGrid">
                <div class="label-btn" data-label="Public">
                    <div class="label-icon public">üåê</div>
                    <div class="label-info"><h3>Public</h3><p id="descPublic">Public information</p></div>
                </div>
                <div class="label-btn" data-label="Internal">
                    <div class="label-icon internal">üè¢</div>
                    <div class="label-info"><h3>Internal</h3><p id="descInternal">Internal use only</p></div>
                </div>
                <div class="label-btn" data-label="Confidential">
                    <div class="label-icon confidential">üîí</div>
                    <div class="label-info"><h3>Confidential</h3><p id="descConfidential">Confidential data</p></div>
                </div>
                <div class="label-btn" data-label="Restricted">
                    <div class="label-icon restricted">‚õî</div>
                    <div class="label-info"><h3>Restricted</h3><p id="descRestricted">Highly restricted</p></div>
                </div>
            </div>
            
            <div class="status" id="status"></div>
        </div>
    </div>

    <!-- Modal Justification -->
    <div class="modal-overlay" id="justificationModal">
        <div class="modal">
            <h2>‚ö†Ô∏è <span id="modalTitle">Justification Required</span></h2>
            <p id="modalDesc">You are lowering the classification level. Please provide a reason:</p>
            <div class="downgrade-info" id="downgradeInfo">
                <strong id="fromLabel">From:</strong> <span id="fromValue">-</span> ‚Üí <strong id="toLabel">To:</strong> <span id="toValue">-</span>
            </div>
            <div class="justification-options">
                <div class="justification-option" data-value="manager_approved">
                    <div class="radio-circle"></div>
                    <span id="justOpt1">My manager approved this change</span>
                </div>
                <div class="justification-option" data-value="data_removed">
                    <div class="radio-circle"></div>
                    <span id="justOpt2">Sensitive data has been removed</span>
                </div>
                <div class="justification-option" data-value="classification_error">
                    <div class="radio-circle"></div>
                    <span id="justOpt3">Initial classification was incorrect</span>
                </div>
                <div class="justification-option" data-value="other">
                    <div class="radio-circle"></div>
                    <span id="justOpt4">Other reason</span>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-cancel" id="cancelJustification">Cancel</button>
                <button class="btn btn-confirm" id="confirmJustification" disabled>Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // ============== CONFIGURATION ==============
        const AUDIT_API_URL = 'https://dlpo-audit-api-fddddvbncrbfc6b5.francecentral-01.azurewebsites.net/api/log-event';
        
        const labelPriorities = { 'Public': 1, 'Internal': 2, 'Confidential': 3, 'Restricted': 4 };
        
        // ============== i18n ==============
        const TRANSLATIONS = {
            en: {
                headerSubtitle: 'Document Classification',
                currentLabelTitle: 'Current Classification',
                notClassified: 'Not classified',
                chooseLabelTitle: 'Choose a classification',
                descPublic: 'Public information',
                descInternal: 'Internal use only',
                descConfidential: 'Confidential data',
                descRestricted: 'Highly restricted',
                modalTitle: 'Justification Required',
                modalDesc: 'You are lowering the classification level. Please provide a reason:',
                fromLabel: 'From:',
                toLabel: 'To:',
                justOpt1: 'My manager approved this change',
                justOpt2: 'Sensitive data has been removed',
                justOpt3: 'Initial classification was incorrect',
                justOpt4: 'Other reason',
                cancel: 'Cancel',
                confirm: 'Confirm',
                success: 'Classification applied: {label}',
                successDowngrade: 'Downgrade confirmed: {label}',
                error: 'Error',
                notConnected: 'Not connected'
            },
            fr: {
                headerSubtitle: 'Classification de document',
                currentLabelTitle: 'Classification actuelle',
                notClassified: 'Non classifi√©',
                chooseLabelTitle: 'Choisir une classification',
                descPublic: 'Information publique',
                descInternal: 'Usage interne uniquement',
                descConfidential: 'Donn√©es confidentielles',
                descRestricted: 'Hautement restreint',
                modalTitle: 'Justification requise',
                modalDesc: 'Vous abaissez le niveau de classification. Veuillez fournir une raison:',
                fromLabel: 'De:',
                toLabel: 'Vers:',
                justOpt1: 'Mon manager a approuv√© ce changement',
                justOpt2: 'Les donn√©es sensibles ont √©t√© supprim√©es',
                justOpt3: 'La classification initiale √©tait incorrecte',
                justOpt4: 'Autre raison',
                cancel: 'Annuler',
                confirm: 'Confirmer',
                success: 'Classification appliqu√©e: {label}',
                successDowngrade: 'D√©classification confirm√©e: {label}',
                error: 'Erreur',
                notConnected: 'Non connect√©'
            }
        };

        // ============== STATE ==============
        let currentLang = 'en';
        let currentUserEmail = 'unknown';
        let currentLabelValue = null;
        let currentLabelPriority = 0;
        let selectedJustification = null;
        let pendingDowngrade = null;

        // ============== INIT ==============
        Office.onReady(async (info) => {
            console.log('Office.js ready:', info.host);
            
            // Event listeners
            document.querySelectorAll('.label-btn').forEach(btn => {
                btn.addEventListener('click', () => selectLabel(btn.dataset.label));
            });
            document.querySelectorAll('.justification-option').forEach(opt => {
                opt.addEventListener('click', () => selectJustification(opt));
            });
            document.getElementById('cancelJustification').addEventListener('click', closeJustificationModal);
            document.getElementById('confirmJustification').addEventListener('click', confirmJustification);
            
            // Get user via SSO
            try {
                await getUserWithSSO();
            } catch (e) {
                console.error('SSO error:', e);
                document.getElementById('userInfo').textContent = 'üë§ ' + TRANSLATIONS[currentLang].notConnected;
            }
            
            // Load current label
            await loadCurrentLabel();
        });

        // ============== SSO ==============
        async function getUserWithSSO() {
            try {
                const token = await OfficeRuntime.auth.getAccessToken({ allowSignInPrompt: true });
                const payload = JSON.parse(atob(token.split('.')[1]));
                currentUserEmail = payload.preferred_username || payload.upn || payload.email || 'unknown';
                document.getElementById('userInfo').textContent = 'üë§ ' + currentUserEmail;
            } catch (error) {
                // Fallback: extract from document URL
                const docUrl = Office.context.document?.url || '';
                if (docUrl.includes('/personal/')) {
                    const match = docUrl.match(/\/personal\/([^\/]+)/);
                    if (match) {
                        const raw = match[1];
                        currentUserEmail = raw.replace(/_/g, '.').replace(/\.onmicrosoft\./, '@onmicrosoft.');
                    }
                }
                document.getElementById('userInfo').textContent = 'üë§ ' + currentUserEmail;
            }
        }

        // ============== LANGUAGE ==============
        function changeLanguage(lang) {
            currentLang = lang;
            const t = TRANSLATIONS[lang];
            document.getElementById('headerSubtitle').textContent = t.headerSubtitle;
            document.getElementById('currentLabelTitle').textContent = t.currentLabelTitle;
            document.getElementById('chooseLabelTitle').textContent = t.chooseLabelTitle;
            document.getElementById('descPublic').textContent = t.descPublic;
            document.getElementById('descInternal').textContent = t.descInternal;
            document.getElementById('descConfidential').textContent = t.descConfidential;
            document.getElementById('descRestricted').textContent = t.descRestricted;
            document.getElementById('modalTitle').textContent = t.modalTitle;
            document.getElementById('modalDesc').textContent = t.modalDesc;
            document.getElementById('fromLabel').textContent = t.fromLabel;
            document.getElementById('toLabel').textContent = t.toLabel;
            document.getElementById('justOpt1').textContent = t.justOpt1;
            document.getElementById('justOpt2').textContent = t.justOpt2;
            document.getElementById('justOpt3').textContent = t.justOpt3;
            document.getElementById('justOpt4').textContent = t.justOpt4;
            document.getElementById('cancelJustification').textContent = t.cancel;
            document.getElementById('confirmJustification').textContent = t.confirm;
            if (!currentLabelValue) {
                document.getElementById('currentLabel').textContent = t.notClassified;
            }
        }

        // ============== LABEL SELECTION ==============
        function selectLabel(label) {
            const newPriority = labelPriorities[label];
            
            // Check if downgrade
            if (currentLabelValue && currentLabelPriority > newPriority) {
                // Show justification modal
                pendingDowngrade = { from: currentLabelValue, to: label };
                document.getElementById('fromValue').textContent = currentLabelValue;
                document.getElementById('toValue').textContent = label;
                document.getElementById('justificationModal').classList.add('show');
                return;
            }
            
            // Direct apply (upgrade or first classification)
            applyLabel(label, null);
        }

        function selectJustification(opt) {
            document.querySelectorAll('.justification-option').forEach(o => o.classList.remove('selected'));
            opt.classList.add('selected');
            selectedJustification = opt.dataset.value;
            document.getElementById('confirmJustification').disabled = false;
        }

        function closeJustificationModal() {
            document.getElementById('justificationModal').classList.remove('show');
            selectedJustification = null;
            pendingDowngrade = null;
            document.querySelectorAll('.justification-option').forEach(o => o.classList.remove('selected'));
            document.getElementById('confirmJustification').disabled = true;
        }

        function confirmJustification() {
            if (!selectedJustification || !pendingDowngrade) return;
            
            const justification = {
                code: selectedJustification,
                text: document.querySelector(`.justification-option[data-value="${selectedJustification}"] span`).textContent,
                from: pendingDowngrade.from,
                to: pendingDowngrade.to,
                timestamp: new Date().toISOString()
            };
            
            closeJustificationModal();
            applyLabel(pendingDowngrade.to, justification);
        }

        // ============== APPLY LABEL ==============
        async function applyLabel(label, justification) {
            const t = TRANSLATIONS[currentLang];
            document.getElementById('loadingOverlay').classList.add('show');
            hideStatus();
            
            try {
                const host = Office.context.host;
                
                if (host === Office.HostType.Word) {
                    await applyLabelWord(label, justification);
                } else if (host === Office.HostType.Excel) {
                    await applyLabelExcel(label, justification);
                } else if (host === Office.HostType.PowerPoint) {
                    await applyLabelPowerPoint(label, justification);
                }
                
                // Update state
                currentLabelValue = label;
                currentLabelPriority = labelPriorities[label];
                updateUI(label);
                
                // Send audit log
                const action = justification ? 'LABEL_DOWNGRADE' : 'LABEL_APPLIED';
                await sendAuditLog(action, label, justification);
                
                // Success message
                const msg = justification ? t.successDowngrade.replace('{label}', label) : t.success.replace('{label}', label);
                showStatus('success', '‚úì ' + msg);
                
            } catch (error) {
                console.error('Error:', error);
                showStatus('error', '‚úó ' + t.error + ': ' + error.message);
            } finally {
                document.getElementById('loadingOverlay').classList.remove('show');
            }
        }

        // ============== WORD ==============
        async function applyLabelWord(label, justification) {
            await Word.run(async (context) => {
                const props = context.document.properties.customProperties;
                props.load('items');
                await context.sync();
                
                // Delete old props
                for (let item of props.items) {
                    if (item.key.startsWith('_DLPO_')) item.delete();
                }
                await context.sync();
                
                // Add new props
                props.add('_DLPO_Classification', label);
                props.add('_DLPO_ClassifiedAt', new Date().toISOString());
                props.add('_DLPO_ClassifiedBy', currentUserEmail);
                
                if (justification) {
                    props.add('_DLPO_DowngradedFrom', justification.from);
                    props.add('_DLPO_DowngradedAt', justification.timestamp);
                    props.add('_DLPO_DowngradeJustification', justification.code);
                    props.add('_DLPO_DowngradeReason', justification.text);
                }
                
                await context.sync();
            });
        }

        // ============== EXCEL ==============
        async function applyLabelExcel(label, justification) {
            await Excel.run(async (context) => {
                const props = context.workbook.properties.custom;
                props.add('_DLPO_Classification', label);
                props.add('_DLPO_ClassifiedAt', new Date().toISOString());
                props.add('_DLPO_ClassifiedBy', currentUserEmail);
                if (justification) {
                    props.add('_DLPO_DowngradedFrom', justification.from);
                    props.add('_DLPO_DowngradeJustification', justification.code);
                }
                await context.sync();
            });
        }

        // ============== POWERPOINT ==============
        async function applyLabelPowerPoint(label, justification) {
            await PowerPoint.run(async (context) => {
                const tags = context.presentation.tags;
                tags.add('_DLPO_Classification', label);
                tags.add('_DLPO_ClassifiedAt', new Date().toISOString());
                tags.add('_DLPO_ClassifiedBy', currentUserEmail);
                if (justification) {
                    tags.add('_DLPO_DowngradedFrom', justification.from);
                    tags.add('_DLPO_DowngradeJustification', justification.code);
                }
                await context.sync();
            });
        }

        // ============== LOAD CURRENT LABEL ==============
        async function loadCurrentLabel() {
            try {
                const host = Office.context.host;
                let label = null;
                
                if (host === Office.HostType.Word) {
                    await Word.run(async (context) => {
                        const props = context.document.properties.customProperties;
                        props.load('items');
                        await context.sync();
                        for (let item of props.items) {
                            if (item.key === '_DLPO_Classification') {
                                label = item.value;
                                break;
                            }
                        }
                    });
                }
                
                if (label) {
                    currentLabelValue = label;
                    currentLabelPriority = labelPriorities[label] || 0;
                    updateUI(label);
                }
            } catch (e) {
                console.error('Load label error:', e);
            }
        }

        // ============== UPDATE UI ==============
        function updateUI(label) {
            document.getElementById('currentLabel').textContent = label;
            document.getElementById('currentLabel').className = 'current-label-value ' + label.toLowerCase();
            
            document.querySelectorAll('.label-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.label === label);
            });
        }

        // ============== AUDIT LOG ==============
        async function sendAuditLog(action, label, justification = null) {
            try {
                const logData = {
                    tenantId: 'mazeloc',
                    action: action,
                    label: label,
                    previousLabel: currentLabelValue,
                    justification: justification,
                    user: currentUserEmail,
                    document: {
                        name: Office.context.document?.url || 'unknown',
                        app: Office.context.host
                    },
                    timestamp: new Date().toISOString()
                };
                
                console.log('üì§ Sending audit log:', logData);
                
                const response = await fetch(AUDIT_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(logData)
                });
                
                const result = await response.json();
                console.log('üì• Audit log response:', result);
                
                if (action === 'LABEL_DOWNGRADE') {
                    console.log('üìß Email should be sent for LABEL_DOWNGRADE');
                }
                
            } catch (error) {
                console.error('‚ùå Audit log error:', error);
            }
        }

        // ============== STATUS ==============
        function showStatus(type, message) {
            const el = document.getElementById('status');
            el.className = 'status ' + type;
            el.textContent = message;
            setTimeout(() => hideStatus(), 5000);
        }

        function hideStatus() {
            document.getElementById('status').className = 'status';
            document.getElementById('status').textContent = '';
        }
    </script>
</body>
</html>
