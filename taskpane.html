<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DLPO Classification</title>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #f5f5f5; min-height: 100vh; }
        
        .container { max-width: 400px; margin: 0 auto; background: white; min-height: 100vh; }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h1 { font-size: 18px; font-weight: 600; }
        .header .subtitle { font-size: 12px; opacity: 0.9; margin-top: 5px; }
        .header .user-info { font-size: 11px; opacity: 0.8; margin-top: 8px; padding: 5px 10px; background: rgba(255,255,255,0.2); border-radius: 12px; display: inline-block; }
        
        .content { padding: 20px; }
        
        .current-label {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        .current-label-title { font-size: 12px; color: #666; margin-bottom: 8px; }
        .current-label-value {
            font-size: 16px;
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
        }
        
        .section-title { font-size: 14px; font-weight: 600; color: #333; margin-bottom: 12px; }
        
        .labels-grid { display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; }
        .label-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .label-btn:hover { border-color: #667eea; background: #f8f9ff; }
        .label-btn.active { border-color: #667eea; background: #f0f4ff; }
        .label-dot { width: 12px; height: 12px; border-radius: 50%; }
        .label-btn span { flex: 1; font-weight: 500; }
        .label-btn .check { display: none; color: #667eea; font-weight: bold; }
        .label-btn.active .check { display: block; }
        
        .public .label-dot, .public { --color: #10B981; }
        .internal .label-dot, .internal { --color: #3B82F6; }
        .confidential .label-dot, .confidential { --color: #F59E0B; }
        .restricted .label-dot, .restricted { --color: #EF4444; }
        .label-dot { background: var(--color); }
        .current-label-value.public { background: #D1FAE5; color: #065F46; }
        .current-label-value.internal { background: #DBEAFE; color: #1E40AF; }
        .current-label-value.confidential { background: #FEF3C7; color: #92400E; }
        .current-label-value.restricted { background: #FEE2E2; color: #991B1B; }
        
        .options { margin-bottom: 20px; }
        .option-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .option-item:last-child { border-bottom: none; }
        .option-item input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .option-item label { flex: 1; font-size: 14px; cursor: pointer; }
        
        .apply-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .apply-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4); }
        .apply-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        
        .status {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-size: 13px;
            display: none;
        }
        .status.success { display: block; background: #D1FAE5; color: #065F46; }
        .status.error { display: block; background: #FEE2E2; color: #991B1B; }
        .status.warning { display: block; background: #FEF3C7; color: #92400E; }
        
        .footer {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            font-size: 11px;
            color: #999;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            flex-direction: column;
            gap: 15px;
        }
        .loading-overlay.show { display: flex; }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e0e0e0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Modal Justification */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-overlay.show { display: flex; }
        .modal {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 340px;
            overflow: hidden;
            animation: modalIn 0.3s ease;
        }
        @keyframes modalIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .modal-header {
            background: #FEF3C7;
            padding: 20px;
            text-align: center;
        }
        .modal-header .icon { font-size: 32px; margin-bottom: 10px; }
        .modal-header h2 { font-size: 16px; color: #92400E; }
        .modal-body { padding: 20px; }
        .downgrade-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .downgrade-info .arrow { color: #666; }
        .justification-options { display: flex; flex-direction: column; gap: 8px; }
        .justification-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .justification-option:hover { border-color: #667eea; }
        .justification-option.selected { border-color: #667eea; background: #f0f4ff; }
        .justification-option input { display: none; }
        .justification-option .radio {
            width: 18px;
            height: 18px;
            border: 2px solid #ccc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .justification-option.selected .radio {
            border-color: #667eea;
            background: #667eea;
        }
        .justification-option.selected .radio::after {
            content: '';
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
        }
        .other-reason {
            margin-top: 10px;
            display: none;
        }
        .other-reason.show { display: block; }
        .other-reason textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            resize: none;
            height: 80px;
            font-family: inherit;
        }
        .modal-footer {
            display: flex;
            gap: 10px;
            padding: 20px;
            border-top: 1px solid #eee;
        }
        .modal-footer button {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-cancel {
            background: #f0f0f0;
            border: none;
            color: #666;
        }
        .btn-confirm {
            background: #667eea;
            border: none;
            color: white;
        }
        .btn-confirm:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div>Chargement...</div>
    </div>

    <div class="container">
        <div class="header">
            <h1>üîí DLPO Classification</h1>
            <div class="subtitle">Protection des donn√©es</div>
            <div class="user-info" id="userInfo">Chargement...</div>
        </div>
        
        <div class="content">
            <div class="current-label">
                <div class="current-label-title">Label actuel</div>
                <div class="current-label-value" id="currentLabel">Chargement...</div>
            </div>
            
            <div class="section-title">Choisir un label</div>
            <div class="labels-grid">
                <button class="label-btn public" data-label="Public" data-priority="1">
                    <div class="label-dot"></div>
                    <span>Public</span>
                    <div class="check">‚úì</div>
                </button>
                <button class="label-btn internal" data-label="Internal" data-priority="2">
                    <div class="label-dot"></div>
                    <span>Internal</span>
                    <div class="check">‚úì</div>
                </button>
                <button class="label-btn confidential" data-label="Confidential" data-priority="3">
                    <div class="label-dot"></div>
                    <span>Confidential</span>
                    <div class="check">‚úì</div>
                </button>
                <button class="label-btn restricted" data-label="Restricted" data-priority="4">
                    <div class="label-dot"></div>
                    <span>Restricted</span>
                    <div class="check">‚úì</div>
                </button>
            </div>
            
            <div class="options">
                <div class="section-title">Options de marquage</div>
                <div class="option-item">
                    <input type="checkbox" id="optHeader">
                    <label for="optHeader">Ajouter dans l'en-t√™te</label>
                </div>
                <div class="option-item">
                    <input type="checkbox" id="optFooter" checked>
                    <label for="optFooter">Ajouter dans le pied de page</label>
                </div>
                <div class="option-item">
                    <input type="checkbox" id="optWatermark">
                    <label for="optWatermark">Ajouter un filigrane</label>
                </div>
            </div>
            
            <button class="apply-btn" id="applyBtn" disabled>Appliquer le label</button>
            
            <div class="status" id="status"></div>
        </div>
        
        <div class="footer">DLPO Classification v2.0 - SSO</div>
    </div>
    
    <!-- Modal Justification -->
    <div class="modal-overlay" id="justificationModal">
        <div class="modal">
            <div class="modal-header">
                <div class="icon">‚ö†Ô∏è</div>
                <h2>Justification requise</h2>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px; color: #666; font-size: 13px;">
                    Vous abaissez le niveau de classification. Veuillez justifier :
                </p>
                <div class="downgrade-info">
                    <span id="fromLabel">-</span>
                    <span class="arrow">‚Üí</span>
                    <span id="toLabel">-</span>
                </div>
                <div class="justification-options">
                    <label class="justification-option" data-code="manager_approved">
                        <input type="radio" name="justification">
                        <div class="radio"></div>
                        <span>Approuv√© par mon manager</span>
                    </label>
                    <label class="justification-option" data-code="data_removed">
                        <input type="radio" name="justification">
                        <div class="radio"></div>
                        <span>Donn√©es sensibles retir√©es</span>
                    </label>
                    <label class="justification-option" data-code="classification_error">
                        <input type="radio" name="justification">
                        <div class="radio"></div>
                        <span>Erreur de classification initiale</span>
                    </label>
                    <label class="justification-option" data-code="other">
                        <input type="radio" name="justification">
                        <div class="radio"></div>
                        <span>Autre raison</span>
                    </label>
                </div>
                <div class="other-reason" id="otherReason">
                    <textarea id="otherReasonText" placeholder="Pr√©cisez la raison..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" id="cancelJustification">Annuler</button>
                <button class="btn-confirm" id="confirmJustification" disabled>Confirmer</button>
            </div>
        </div>
    </div>

    <script>
        // === CONFIG ===
        const AUDIT_API_URL = 'https://dlpo-audit-api.azurewebsites.net/api/log-event';
        
        // === STATE ===
        let currentUserEmail = 'unknown';
        let currentUserName = 'unknown';
        let selectedLabel = null;
        let currentLabelValue = null;
        let currentLabelPriority = 0;
        let pendingDowngrade = null;
        
        const labelPriorities = { 'Public': 1, 'Internal': 2, 'Confidential': 3, 'Restricted': 4 };
        const labelColors = { 'Public': 'public', 'Internal': 'internal', 'Confidential': 'confidential', 'Restricted': 'restricted' };
        
        // === OFFICE INIT ===
        Office.onReady(async (info) => {
            console.log('Office ready:', info.host);
            
            // Get user via SSO
            await getUserWithSSO();
            
            // Setup UI
            setupEventListeners();
            await loadCurrentLabel();
        });
        
        // === SSO ===
        async function getUserWithSSO() {
            try {
                console.log('Getting SSO token...');
                const token = await OfficeRuntime.auth.getAccessToken({ allowSignInPrompt: true });
                console.log('Token received');
                
                // Decode JWT token (simple base64 decode)
                const payload = JSON.parse(atob(token.split('.')[1]));
                console.log('Token payload:', payload);
                
                currentUserEmail = payload.preferred_username || payload.upn || payload.email || 'unknown';
                currentUserName = payload.name || currentUserEmail.split('@')[0];
                
                document.getElementById('userInfo').textContent = 'üë§ ' + currentUserEmail;
                console.log('User:', currentUserEmail);
                
            } catch (error) {
                console.error('SSO Error:', error);
                
                // Fallback: try to extract from document URL
                const docUrl = Office.context.document?.url || '';
                if (docUrl.includes('/personal/')) {
                    const match = docUrl.match(/\/personal\/([^\/]+)/);
                    if (match) {
                        currentUserEmail = match[1].replace(/_/g, '.').replace(/\.onmicrosoft\./, '@onmicrosoft.');
                    }
                }
                
                document.getElementById('userInfo').textContent = 'üë§ ' + (currentUserEmail !== 'unknown' ? currentUserEmail : 'Non connect√©');
            }
        }
        
        // === EVENT LISTENERS ===
        function setupEventListeners() {
            // Label buttons
            document.querySelectorAll('.label-btn').forEach(btn => {
                btn.addEventListener('click', () => selectLabel(btn));
            });
            
            // Apply button
            document.getElementById('applyBtn').addEventListener('click', handleApplyClick);
            
            // Justification modal
            document.querySelectorAll('.justification-option').forEach(opt => {
                opt.addEventListener('click', () => selectJustification(opt));
            });
            
            document.getElementById('cancelJustification').addEventListener('click', closeJustificationModal);
            document.getElementById('confirmJustification').addEventListener('click', confirmJustification);
        }
        
        function selectLabel(btn) {
            document.querySelectorAll('.label-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedLabel = btn.dataset.label;
            document.getElementById('applyBtn').disabled = false;
            hideStatus();
        }
        
        function handleApplyClick() {
            if (!selectedLabel) return;
            
            const newPriority = labelPriorities[selectedLabel];
            
            // Check if downgrade
            if (currentLabelPriority > 0 && newPriority < currentLabelPriority) {
                showJustificationModal(currentLabelValue, selectedLabel);
            } else {
                applyLabel(selectedLabel, null);
            }
        }
        
        // === JUSTIFICATION MODAL ===
        function showJustificationModal(fromLabel, toLabel) {
            pendingDowngrade = { from: fromLabel, to: toLabel };
            document.getElementById('fromLabel').textContent = fromLabel;
            document.getElementById('fromLabel').className = labelColors[fromLabel];
            document.getElementById('toLabel').textContent = toLabel;
            document.getElementById('toLabel').className = labelColors[toLabel];
            
            // Reset selections
            document.querySelectorAll('.justification-option').forEach(o => o.classList.remove('selected'));
            document.getElementById('otherReason').classList.remove('show');
            document.getElementById('otherReasonText').value = '';
            document.getElementById('confirmJustification').disabled = true;
            
            document.getElementById('justificationModal').classList.add('show');
        }
        
        function closeJustificationModal() {
            document.getElementById('justificationModal').classList.remove('show');
            pendingDowngrade = null;
        }
        
        function selectJustification(opt) {
            document.querySelectorAll('.justification-option').forEach(o => o.classList.remove('selected'));
            opt.classList.add('selected');
            
            if (opt.dataset.code === 'other') {
                document.getElementById('otherReason').classList.add('show');
            } else {
                document.getElementById('otherReason').classList.remove('show');
            }
            
            document.getElementById('confirmJustification').disabled = false;
        }
        
        function confirmJustification() {
            const selected = document.querySelector('.justification-option.selected');
            if (!selected || !pendingDowngrade) return;
            
            const code = selected.dataset.code;
            let text = selected.querySelector('span').textContent;
            
            if (code === 'other') {
                text = document.getElementById('otherReasonText').value || 'Autre raison';
            }
            
            const justification = {
                code: code,
                text: text,
                from: pendingDowngrade.from,
                to: pendingDowngrade.to,
                timestamp: new Date().toISOString()
            };
            
            closeJustificationModal();
            applyLabel(pendingDowngrade.to, justification);
        }
        
        // === APPLY LABEL ===
        async function applyLabel(label, justification) {
            document.getElementById('loadingOverlay').classList.add('show');
            
            try {
                const host = Office.context.host;
                
                if (host === Office.HostType.Word) {
                    await applyLabelWord(label, justification);
                } else if (host === Office.HostType.Excel) {
                    await applyLabelExcel(label, justification);
                } else if (host === Office.HostType.PowerPoint) {
                    await applyLabelPowerPoint(label, justification);
                }
                
                // Update UI
                updateCurrentLabelDisplay(label);
                
                // Send audit log
                await sendAuditLog(justification ? 'LABEL_DOWNGRADE' : 'LABEL_APPLIED', label, justification);
                
                showStatus('success', '‚úì Label "' + label + '" appliqu√©');
                
            } catch (error) {
                console.error('Error:', error);
                showStatus('error', '‚úó Erreur: ' + error.message);
            } finally {
                document.getElementById('loadingOverlay').classList.remove('show');
            }
        }
        
        // === WORD ===
        async function applyLabelWord(label, justification) {
            await Word.run(async (context) => {
                const properties = context.document.properties.customProperties;
                properties.load('items');
                await context.sync();
                
                // Delete old properties
                const keysToDelete = ['_DLPO_Classification', '_DLPO_ClassifiedAt', '_DLPO_ClassifiedBy',
                    '_DLPO_DowngradedFrom', '_DLPO_DowngradedAt', '_DLPO_DowngradeJustification', '_DLPO_DowngradeReason'];
                for (let item of properties.items) {
                    if (keysToDelete.includes(item.key)) {
                        item.delete();
                    }
                }
                await context.sync();
                
                // Add new properties
                properties.add('_DLPO_Classification', label);
                properties.add('_DLPO_ClassifiedAt', new Date().toISOString());
                properties.add('_DLPO_ClassifiedBy', currentUserEmail);
                
                if (justification) {
                    properties.add('_DLPO_DowngradedFrom', justification.from);
                    properties.add('_DLPO_DowngradedAt', justification.timestamp);
                    properties.add('_DLPO_DowngradeJustification', justification.code);
                    properties.add('_DLPO_DowngradeReason', justification.text);
                }
                
                await context.sync();
                
                // Header
                if (document.getElementById('optHeader').checked) {
                    const sections = context.document.sections;
                    sections.load('items');
                    await context.sync();
                    for (let i = 0; i < sections.items.length; i++) {
                        const header = sections.items[i].getHeader('Primary');
                        const para = header.insertParagraph('Classification: ' + label, 'Start');
                        para.alignment = Word.Alignment.centered;
                        const colors = { 'Public': '#10B981', 'Internal': '#3B82F6', 'Confidential': '#F59E0B', 'Restricted': '#EF4444' };
                        para.font.color = colors[label] || '#000000';
                        para.font.bold = true;
                    }
                    await context.sync();
                }
                
                // Footer
                if (document.getElementById('optFooter').checked) {
                    const sections = context.document.sections;
                    sections.load('items');
                    await context.sync();
                    for (let i = 0; i < sections.items.length; i++) {
                        const footer = sections.items[i].getFooter('Primary');
                        const para = footer.insertParagraph('Classification: ' + label, 'End');
                        para.alignment = Word.Alignment.centered;
                        const colors = { 'Public': '#10B981', 'Internal': '#3B82F6', 'Confidential': '#F59E0B', 'Restricted': '#EF4444' };
                        para.font.color = colors[label] || '#000000';
                        para.font.bold = true;
                    }
                    await context.sync();
                }
                
                // Watermark
                if (document.getElementById('optWatermark').checked) {
                    const body = context.document.body;
                    const watermark = body.insertParagraph(label.toUpperCase(), 'Start');
                    watermark.font.color = '#E0E0E0';
                    watermark.font.size = 48;
                    watermark.alignment = Word.Alignment.centered;
                    await context.sync();
                }
            });
        }
        
        // === EXCEL ===
        async function applyLabelExcel(label, justification) {
            await Excel.run(async (context) => {
                const properties = context.workbook.properties.custom;
                properties.load('items');
                await context.sync();
                
                const keysToDelete = ['_DLPO_Classification', '_DLPO_ClassifiedAt', '_DLPO_ClassifiedBy',
                    '_DLPO_DowngradedFrom', '_DLPO_DowngradedAt', '_DLPO_DowngradeJustification', '_DLPO_DowngradeReason'];
                for (let item of properties.items) {
                    if (keysToDelete.includes(item.key)) {
                        item.delete();
                    }
                }
                await context.sync();
                
                properties.add('_DLPO_Classification', label);
                properties.add('_DLPO_ClassifiedAt', new Date().toISOString());
                properties.add('_DLPO_ClassifiedBy', currentUserEmail);
                
                if (justification) {
                    properties.add('_DLPO_DowngradedFrom', justification.from);
                    properties.add('_DLPO_DowngradedAt', justification.timestamp);
                    properties.add('_DLPO_DowngradeJustification', justification.code);
                    properties.add('_DLPO_DowngradeReason', justification.text);
                }
                
                await context.sync();
            });
        }
        
        // === POWERPOINT ===
        async function applyLabelPowerPoint(label, justification) {
            await PowerPoint.run(async (context) => {
                const presentation = context.presentation;
                
                presentation.tags.add('_DLPO_Classification', label);
                presentation.tags.add('_DLPO_ClassifiedAt', new Date().toISOString());
                presentation.tags.add('_DLPO_ClassifiedBy', currentUserEmail);
                
                if (justification) {
                    presentation.tags.add('_DLPO_DowngradedFrom', justification.from);
                    presentation.tags.add('_DLPO_DowngradedAt', justification.timestamp);
                    presentation.tags.add('_DLPO_DowngradeJustification', justification.code);
                    presentation.tags.add('_DLPO_DowngradeReason', justification.text);
                }
                
                await context.sync();
            });
        }
        
        // === LOAD CURRENT LABEL ===
        async function loadCurrentLabel() {
            try {
                const host = Office.context.host;
                let label = null;
                
                if (host === Office.HostType.Word) {
                    await Word.run(async (context) => {
                        const properties = context.document.properties.customProperties;
                        properties.load('items');
                        await context.sync();
                        for (let item of properties.items) {
                            if (item.key === '_DLPO_Classification') {
                                label = item.value;
                                break;
                            }
                        }
                    });
                } else if (host === Office.HostType.Excel) {
                    await Excel.run(async (context) => {
                        const properties = context.workbook.properties.custom;
                        properties.load('items');
                        await context.sync();
                        for (let item of properties.items) {
                            if (item.key === '_DLPO_Classification') {
                                label = item.value;
                                break;
                            }
                        }
                    });
                } else if (host === Office.HostType.PowerPoint) {
                    await PowerPoint.run(async (context) => {
                        const tags = context.presentation.tags;
                        tags.load('items');
                        await context.sync();
                        for (let item of tags.items) {
                            if (item.key === '_DLPO_Classification' || item.key === '_dlpo_classification') {
                                label = item.value;
                                break;
                            }
                        }
                    });
                }
                
                if (label && labelPriorities[label]) {
                    updateCurrentLabelDisplay(label);
                } else {
                    document.getElementById('currentLabel').textContent = 'Non classifi√©';
                    document.getElementById('currentLabel').className = 'current-label-value';
                    currentLabelValue = null;
                    currentLabelPriority = 0;
                }
                
            } catch (error) {
                console.error('Error loading label:', error);
                document.getElementById('currentLabel').textContent = 'Non classifi√©';
                currentLabelValue = null;
                currentLabelPriority = 0;
            }
        }
        
        function updateCurrentLabelDisplay(label) {
            const el = document.getElementById('currentLabel');
            el.textContent = label;
            el.className = 'current-label-value ' + labelColors[label];
            currentLabelValue = label;
            currentLabelPriority = labelPriorities[label] || 0;
            
            document.querySelectorAll('.label-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.label === label) {
                    btn.classList.add('active');
                }
            });
            
            selectedLabel = label;
        }
        
        // === AUDIT LOG ===
        async function sendAuditLog(action, label, justification) {
            try {
                const logData = {
                    tenantId: 'mazeloc',
                    action: action,
                    label: label,
                    previousLabel: currentLabelValue,
                    user: currentUserEmail,
                    document: {
                        name: Office.context.document?.url || 'unknown',
                        app: Office.context.host
                    },
                    justification: justification
                };
                
                console.log('Sending audit log:', logData);
                
                const response = await fetch(AUDIT_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(logData)
                });
                
                if (response.ok) {
                    console.log('Audit log sent successfully');
                } else {
                    console.error('Failed to send audit log:', response.status);
                }
            } catch (error) {
                console.error('Error sending audit log:', error);
            }
        }
        
        // === UI HELPERS ===
        function showStatus(type, message) {
            const status = document.getElementById('status');
            status.className = 'status ' + type;
            status.textContent = message;
        }
        
        function hideStatus() {
            document.getElementById('status').className = 'status';
        }
    </script>
</body>
</html>
