<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MazeShield</title>
    <script src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js"></script>
    <script src="drm-client.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', sans-serif; background: #f5f5f5; min-height: 100vh; }
        
        .container { display: flex; flex-direction: column; min-height: 100vh; }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        .header h1 { font-size: 22px; margin-bottom: 4px; }
        .header p { font-size: 12px; opacity: 0.9; }
        .user-info { 
            background: rgba(255,255,255,0.2); 
            padding: 6px 12px; 
            border-radius: 15px; 
            font-size: 11px; 
            margin-top: 10px;
            display: inline-block;
        }
        .lang-selector { position: absolute; top: 10px; right: 10px; }
        .lang-selector select {
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .lang-selector select option { color: #333; }
        
        .content { flex: 1; padding: 20px; }
        
        .current-label {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .current-label-title { font-size: 11px; color: #666; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .current-label-value { font-size: 16px; font-weight: 600; padding: 8px 16px; border-radius: 20px; display: inline-block; }
        .current-label-value.public { background: #d1fae5; color: #065f46; }
        .current-label-value.internal { background: #dbeafe; color: #1e40af; }
        .current-label-value.confidential { background: #fef3c7; color: #92400e; }
        .current-label-value.restricted { background: #fee2e2; color: #991b1b; }
        
        .section-title { font-size: 11px; color: #666; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
        
        .labels-grid { display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; }
        .label-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .label-btn:hover { border-color: #667eea; background: #f8f9ff; }
        .label-btn.active { border-color: #667eea; background: #eff1ff; }
        .label-btn .dot { width: 16px; height: 16px; border-radius: 50%; }
        .label-btn .dot.public { background: #10b981; }
        .label-btn .dot.internal { background: #3b82f6; }
        .label-btn .dot.confidential { background: #f59e0b; }
        .label-btn .dot.restricted { background: #ef4444; }
        .label-btn .info { flex: 1; text-align: left; }
        .label-btn .name { font-weight: 600; font-size: 14px; color: #333; }
        .label-btn .desc { font-size: 11px; color: #666; }
        .label-btn .check { width: 20px; height: 20px; border-radius: 50%; border: 2px solid #e0e0e0; display: flex; align-items: center; justify-content: center; font-size: 12px; color: white; }
        .label-btn.active .check { background: #667eea; border-color: #667eea; }
        
        .options { background: white; border-radius: 12px; padding: 15px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .options label { display: flex; align-items: center; gap: 10px; font-size: 13px; color: #333; margin-bottom: 8px; cursor: pointer; }
        .options label:last-child { margin-bottom: 0; }
        .options input[type="checkbox"] { width: 18px; height: 18px; accent-color: #667eea; }
        
        /* DRM Section */
        .drm-section {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .drm-section .section-title { color: #a0aec0; }
        .drm-btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .drm-btn.protect {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .drm-btn.protect:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
        .drm-btn.revoke {
            background: #ef4444;
            color: white;
            margin-top: 10px;
        }
        .drm-btn.revoke:hover { background: #dc2626; }
        .drm-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        .drm-status {
            margin-top: 12px;
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            display: none;
        }
        .drm-status.protected { display: block; background: rgba(16, 185, 129, 0.2); color: #10b981; border: 1px solid #10b981; }
        .drm-status.info { display: block; background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid #3b82f6; }
        
        .status { padding: 12px; border-radius: 8px; text-align: center; font-size: 13px; margin-bottom: 15px; display: none; }
        .status.success { display: block; background: #d1fae5; color: #065f46; }
        .status.error { display: block; background: #fee2e2; color: #991b1b; }
        .status.info { display: block; background: #dbeafe; color: #1e40af; }
        
        .footer { text-align: center; padding: 15px; font-size: 11px; color: #999; border-top: 1px solid #eee; background: white; }

        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal { background: white; border-radius: 16px; padding: 24px; max-width: 320px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .modal h3 { font-size: 16px; margin-bottom: 8px; color: #333; }
        .modal p { font-size: 13px; color: #666; margin-bottom: 16px; }
        .modal .warning { background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 12px; margin-bottom: 16px; font-size: 12px; color: #92400e; }
        .modal .options-list { margin-bottom: 16px; }
        .modal .options-list label { display: flex; align-items: flex-start; gap: 10px; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; }
        .modal .options-list label:hover { background: #f8f9fa; }
        .modal .options-list input[type="radio"] { margin-top: 2px; }
        .modal .options-list .option-text { font-size: 13px; color: #333; }
        .modal textarea { width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 13px; resize: vertical; min-height: 60px; margin-bottom: 16px; display: none; }
        .modal textarea.visible { display: block; }
        .modal input[type="text"] { width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 13px; margin-bottom: 10px; }
        .modal .buttons { display: flex; gap: 10px; }
        .modal button { flex: 1; padding: 12px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .modal .btn-cancel { background: #e0e0e0; color: #333; }
        .modal .btn-cancel:hover { background: #d0d0d0; }
        .modal .btn-confirm { background: #667eea; color: white; }
        .modal .btn-confirm:hover { background: #5a6fd6; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="lang-selector">
                <select id="langSelect" onchange="changeLanguage(this.value)">
                    <option value="en">EN</option>
                    <option value="fr">FR</option>
                    <option value="de">DE</option>
                    <option value="es">ES</option>
                    <option value="ar">AR</option>
                </select>
            </div>
            <h1>üõ°Ô∏è MazeShield</h1>
            <p id="headerSubtitle">Document Classification</p>
            <div class="user-info" id="userInfo">Loading...</div>
        </div>
        
        <div class="content">
            <div class="current-label">
                <div class="current-label-title" id="currentLabelTitle">Current Classification</div>
                <div class="current-label-value" id="currentLabel">Not classified</div>
            </div>
            
            <div class="section-title" id="chooseLabelTitle">Choose a label</div>
            <div class="labels-grid" id="labelsGrid"></div>
            
            <div class="options">
                <div class="section-title" id="optionsTitle">Options</div>
                <label><input type="checkbox" id="addHeader" checked> <span id="optHeader">Add header</span></label>
                <label><input type="checkbox" id="addFooter" checked> <span id="optFooter">Add footer</span></label>
                <label><input type="checkbox" id="addWatermark"> <span id="optWatermark">Add watermark</span></label>
            </div>
            
            <!-- DRM Section -->
            <div class="drm-section">
                <div class="section-title">üîê DRM Protection</div>
                <button class="drm-btn protect" id="btnProtectDRM" onclick="openDRMModal()">
                    üîí Protect with DRM
                </button>
                <button class="drm-btn revoke" id="btnRevokeDRM" onclick="revokeDocumentDRM()" style="display:none;">
                    üö´ Revoke Access
                </button>
                <div class="drm-status" id="drmStatus"></div>
            </div>
            
            <div class="status" id="status"></div>
        </div>
        
        <div class="footer">MazeShield v2.3 + DRM</div>
    </div>

    <!-- Modal Justification (existing) -->
    <div class="modal-overlay" id="justificationModal">
        <div class="modal">
            <h3 id="modalTitle">‚ö†Ô∏è Justification Required</h3>
            <p id="modalDesc">You are lowering the classification level. Please provide a justification:</p>
            <div class="warning" id="modalWarning">
                <strong id="modalFrom">From:</strong> <span id="fromLabel">-</span><br>
                <strong id="modalTo">To:</strong> <span id="toLabel">-</span>
            </div>
            <div class="options-list">
                <label><input type="radio" name="justification" value="manager_approved"> <span class="option-text" id="justOpt1">My manager approved this change</span></label>
                <label><input type="radio" name="justification" value="data_removed"> <span class="option-text" id="justOpt2">Sensitive data has been removed</span></label>
                <label><input type="radio" name="justification" value="classification_error"> <span class="option-text" id="justOpt3">Initial classification was incorrect</span></label>
                <label><input type="radio" name="justification" value="other"> <span class="option-text" id="justOpt4">Other reason</span></label>
            </div>
            <textarea id="otherReason" placeholder="Please specify..."></textarea>
            <div class="buttons">
                <button class="btn-cancel" onclick="closeModal()" id="btnCancel">Cancel</button>
                <button class="btn-confirm" onclick="confirmJustification()" id="btnConfirm">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Modal DRM Protection -->
    <div class="modal-overlay" id="drmModal">
        <div class="modal">
            <h3>üîê DRM Protection Settings</h3>
            <p>Configure who can access this document:</p>
            
            <div style="margin-bottom: 15px;">
                <label style="display:block; font-size:12px; color:#666; margin-bottom:5px;">Allowed Domains (comma separated)</label>
                <input type="text" id="drmDomains" placeholder="e.g. kpmg.com, acme.com">
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display:block; font-size:12px; color:#666; margin-bottom:5px;">Allowed Emails (comma separated)</label>
                <input type="text" id="drmEmails" placeholder="e.g. bob@external.com">
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display:block; font-size:12px; color:#666; margin-bottom:5px;">Rights</label>
                <label style="font-size:13px;"><input type="checkbox" id="drmRightView" checked> View</label>
                <label style="font-size:13px; margin-left:10px;"><input type="checkbox" id="drmRightPrint"> Print</label>
                <label style="font-size:13px; margin-left:10px;"><input type="checkbox" id="drmRightEdit"> Edit</label>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display:block; font-size:12px; color:#666; margin-bottom:5px;">Expiration (optional)</label>
                <input type="date" id="drmExpiry">
            </div>
            
            <div class="buttons">
                <button class="btn-cancel" onclick="closeDRMModal()">Cancel</button>
                <button class="btn-confirm" onclick="applyDRMProtection()">üîí Protect</button>
            </div>
        </div>
    </div>

    <script>
        // ============== CONFIGURATION ==============
        const AUDIT_URL = 'https://dlpo-audit-api-fddddvbncrbfc6b5.francecentral-01.azurewebsites.net/api/log-event';
        const DRM_API_BASE = 'https://fn-mazeshield-drm.azurewebsites.net/api';
        
        const LABELS = [
            { id: 'public', priority: 1, color: '#10b981' },
            { id: 'internal', priority: 2, color: '#3b82f6' },
            { id: 'confidential', priority: 3, color: '#f59e0b' },
            { id: 'restricted', priority: 4, color: '#ef4444' }
        ];

        // ============== i18n ==============
        const TRANSLATIONS = {
            en: {
                headerSubtitle: 'Document Classification',
                currentLabelTitle: 'Current Classification',
                notClassified: 'Not classified',
                chooseLabelTitle: 'Choose a label',
                optionsTitle: 'Options',
                optHeader: 'Add header',
                optFooter: 'Add footer',
                optWatermark: 'Add watermark',
                modalTitle: '‚ö†Ô∏è Justification Required',
                modalDesc: 'You are lowering the classification level. Please provide a justification:',
                modalFrom: 'From:',
                modalTo: 'To:',
                justOpt1: 'My manager approved this change',
                justOpt2: 'Sensitive data has been removed',
                justOpt3: 'Initial classification was incorrect',
                justOpt4: 'Other reason',
                btnCancel: 'Cancel',
                btnConfirm: 'Confirm',
                successApplied: 'Classification applied!',
                labels: {
                    public: { name: 'Public', desc: 'Can be shared freely' },
                    internal: { name: 'Internal', desc: 'Internal use only' },
                    confidential: { name: 'Confidential', desc: 'Restricted access' },
                    restricted: { name: 'Restricted', desc: 'Highly sensitive' }
                }
            },
            fr: {
                headerSubtitle: 'Classification de documents',
                currentLabelTitle: 'Classification actuelle',
                notClassified: 'Non classifi√©',
                chooseLabelTitle: 'Choisir un label',
                optionsTitle: 'Options',
                optHeader: 'Ajouter en-t√™te',
                optFooter: 'Ajouter pied de page',
                optWatermark: 'Ajouter filigrane',
                modalTitle: '‚ö†Ô∏è Justification requise',
                modalDesc: 'Vous abaissez le niveau de classification. Veuillez justifier:',
                modalFrom: 'De:',
                modalTo: 'Vers:',
                justOpt1: 'Mon manager a approuv√© ce changement',
                justOpt2: 'Les donn√©es sensibles ont √©t√© supprim√©es',
                justOpt3: 'La classification initiale √©tait incorrecte',
                justOpt4: 'Autre raison',
                btnCancel: 'Annuler',
                btnConfirm: 'Confirmer',
                successApplied: 'Classification appliqu√©e!',
                labels: {
                    public: { name: 'Public', desc: 'Peut √™tre partag√© librement' },
                    internal: { name: 'Interne', desc: 'Usage interne uniquement' },
                    confidential: { name: 'Confidentiel', desc: 'Acc√®s restreint' },
                    restricted: { name: 'Restreint', desc: 'Hautement sensible' }
                }
            },
            de: {
                headerSubtitle: 'Dokumentenklassifizierung',
                currentLabelTitle: 'Aktuelle Klassifizierung',
                notClassified: 'Nicht klassifiziert',
                chooseLabelTitle: 'Label w√§hlen',
                optionsTitle: 'Optionen',
                optHeader: 'Kopfzeile hinzuf√ºgen',
                optFooter: 'Fu√üzeile hinzuf√ºgen',
                optWatermark: 'Wasserzeichen hinzuf√ºgen',
                modalTitle: '‚ö†Ô∏è Begr√ºndung erforderlich',
                modalDesc: 'Sie senken die Klassifizierungsstufe. Bitte begr√ºnden Sie:',
                modalFrom: 'Von:',
                modalTo: 'Nach:',
                justOpt1: 'Mein Vorgesetzter hat diese √Ñnderung genehmigt',
                justOpt2: 'Sensible Daten wurden entfernt',
                justOpt3: 'Die urspr√ºngliche Klassifizierung war falsch',
                justOpt4: 'Anderer Grund',
                btnCancel: 'Abbrechen',
                btnConfirm: 'Best√§tigen',
                successApplied: 'Klassifizierung angewendet!',
                labels: {
                    public: { name: '√ñffentlich', desc: 'Kann frei geteilt werden' },
                    internal: { name: 'Intern', desc: 'Nur f√ºr internen Gebrauch' },
                    confidential: { name: 'Vertraulich', desc: 'Eingeschr√§nkter Zugang' },
                    restricted: { name: 'Streng vertraulich', desc: 'Hochsensibel' }
                }
            },
            es: {
                headerSubtitle: 'Clasificaci√≥n de documentos',
                currentLabelTitle: 'Clasificaci√≥n actual',
                notClassified: 'Sin clasificar',
                chooseLabelTitle: 'Elegir etiqueta',
                optionsTitle: 'Opciones',
                optHeader: 'A√±adir encabezado',
                optFooter: 'A√±adir pie de p√°gina',
                optWatermark: 'A√±adir marca de agua',
                modalTitle: '‚ö†Ô∏è Justificaci√≥n requerida',
                modalDesc: 'Est√° reduciendo el nivel de clasificaci√≥n. Por favor justifique:',
                modalFrom: 'De:',
                modalTo: 'A:',
                justOpt1: 'Mi gerente aprob√≥ este cambio',
                justOpt2: 'Los datos sensibles han sido eliminados',
                justOpt3: 'La clasificaci√≥n inicial era incorrecta',
                justOpt4: 'Otra raz√≥n',
                btnCancel: 'Cancelar',
                btnConfirm: 'Confirmar',
                successApplied: '¬°Clasificaci√≥n aplicada!',
                labels: {
                    public: { name: 'P√∫blico', desc: 'Se puede compartir libremente' },
                    internal: { name: 'Interno', desc: 'Solo uso interno' },
                    confidential: { name: 'Confidencial', desc: 'Acceso restringido' },
                    restricted: { name: 'Restringido', desc: 'Altamente sensible' }
                }
            },
            ar: {
                headerSubtitle: 'ÿ™ÿµŸÜŸäŸÅ ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØÿßÿ™',
                currentLabelTitle: 'ÿßŸÑÿ™ÿµŸÜŸäŸÅ ÿßŸÑÿ≠ÿßŸÑŸä',
                notClassified: 'ÿ∫Ÿäÿ± ŸÖÿµŸÜŸÅ',
                chooseLabelTitle: 'ÿßÿÆÿ™ÿ± ÿ™ÿµŸÜŸäŸÅ',
                optionsTitle: 'ÿÆŸäÿßÿ±ÿßÿ™',
                optHeader: 'ÿ•ÿ∂ÿßŸÅÿ© ÿ±ÿ£ÿ≥',
                optFooter: 'ÿ•ÿ∂ÿßŸÅÿ© ÿ™ÿ∞ŸäŸäŸÑ',
                optWatermark: 'ÿ•ÿ∂ÿßŸÅÿ© ÿπŸÑÿßŸÖÿ© ŸÖÿßÿ¶Ÿäÿ©',
                modalTitle: '‚ö†Ô∏è ŸÖÿ∑ŸÑŸàÿ® ÿ™ÿ®ÿ±Ÿäÿ±',
                modalDesc: 'ÿ£ŸÜÿ™ ÿ™ÿÆŸÅÿ∂ ŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿ™ÿµŸÜŸäŸÅ. Ÿäÿ±ÿ¨Ÿâ ÿ™ŸÇÿØŸäŸÖ ÿ™ÿ®ÿ±Ÿäÿ±:',
                modalFrom: 'ŸÖŸÜ:',
                modalTo: 'ÿ•ŸÑŸâ:',
                justOpt1: 'ŸàÿßŸÅŸÇ ŸÖÿØŸäÿ±Ÿä ÿπŸÑŸâ Ÿáÿ∞ÿß ÿßŸÑÿ™ÿ∫ŸäŸäÿ±',
                justOpt2: 'ÿ™ŸÖÿ™ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿ≥ÿßÿ≥ÿ©',
                justOpt3: 'ŸÉÿßŸÜ ÿßŸÑÿ™ÿµŸÜŸäŸÅ ÿßŸÑÿ£ŸàŸÑŸä ÿÆÿßÿ∑ÿ¶Ÿãÿß',
                justOpt4: 'ÿ≥ÿ®ÿ® ÿ¢ÿÆÿ±',
                btnCancel: 'ÿ•ŸÑÿ∫ÿßÿ°',
                btnConfirm: 'ÿ™ÿ£ŸÉŸäÿØ',
                successApplied: 'ÿ™ŸÖ ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ™ÿµŸÜŸäŸÅ!',
                labels: {
                    public: { name: 'ÿπÿßŸÖ', desc: 'ŸäŸÖŸÉŸÜ ŸÖÿ¥ÿßÿ±ŸÉÿ™Ÿá ÿ®ÿ≠ÿ±Ÿäÿ©' },
                    internal: { name: 'ÿØÿßÿÆŸÑŸä', desc: 'ŸÑŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿØÿßÿÆŸÑŸä ŸÅŸÇÿ∑' },
                    confidential: { name: 'ÿ≥ÿ±Ÿä', desc: 'ŸàÿµŸàŸÑ ŸÖŸÇŸäÿØ' },
                    restricted: { name: 'ŸÖŸÇŸäÿØ', desc: 'ÿ≠ÿ≥ÿßÿ≥ ŸÑŸÑÿ∫ÿßŸäÿ©' }
                }
            }
        };

        // ============== STATE ==============
        let currentLang = 'en';
        let currentUserEmail = 'unknown';
        let currentLabelId = null;
        let currentLabelPriority = 0;
        let pendingLabel = null;
        let currentDocId = null; // DRM Document ID

        // ============== INIT ==============
        Office.onReady(async (info) => {
            console.log('Office.js ready:', info.host);
            await initUser();
            applyTranslations();
            renderLabels();
            await loadCurrentLabel();
            await checkDRMStatus();
            
            document.querySelectorAll('input[name="justification"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    const textarea = document.getElementById('otherReason');
                    textarea.classList.toggle('visible', radio.value === 'other' && radio.checked);
                });
            });
        });

        // ============== USER ==============
        async function initUser() {
            try {
                const token = await OfficeRuntime.auth.getAccessToken({ allowSignInPrompt: true });
                const payload = JSON.parse(atob(token.split('.')[1]));
                currentUserEmail = payload.preferred_username || payload.upn || payload.email || 'unknown';
            } catch (e) {
                console.log('SSO failed, using fallback');
                const docUrl = Office.context.document?.url || '';
                if (docUrl.includes('/personal/')) {
                    const match = docUrl.match(/\/personal\/([^\/]+)/);
                    if (match) currentUserEmail = match[1].replace(/_/g, '.').replace(/\.onmicrosoft\./, '@onmicrosoft.');
                }
            }
            document.getElementById('userInfo').textContent = 'üë§ ' + currentUserEmail;
        }

        // ============== LANGUAGE ==============
        function changeLanguage(lang) {
            currentLang = lang;
            applyTranslations();
            renderLabels();
            updateCurrentLabelDisplay();
        }

        function applyTranslations() {
            const t = TRANSLATIONS[currentLang];
            document.getElementById('headerSubtitle').textContent = t.headerSubtitle;
            document.getElementById('currentLabelTitle').textContent = t.currentLabelTitle;
            document.getElementById('chooseLabelTitle').textContent = t.chooseLabelTitle;
            document.getElementById('optionsTitle').textContent = t.optionsTitle;
            document.getElementById('optHeader').textContent = t.optHeader;
            document.getElementById('optFooter').textContent = t.optFooter;
            document.getElementById('optWatermark').textContent = t.optWatermark;
            document.getElementById('modalTitle').textContent = t.modalTitle;
            document.getElementById('modalDesc').textContent = t.modalDesc;
            document.getElementById('modalFrom').textContent = t.modalFrom;
            document.getElementById('modalTo').textContent = t.modalTo;
            document.getElementById('justOpt1').textContent = t.justOpt1;
            document.getElementById('justOpt2').textContent = t.justOpt2;
            document.getElementById('justOpt3').textContent = t.justOpt3;
            document.getElementById('justOpt4').textContent = t.justOpt4;
            document.getElementById('btnCancel').textContent = t.btnCancel;
            document.getElementById('btnConfirm').textContent = t.btnConfirm;
        }

        // ============== RENDER LABELS ==============
        function renderLabels() {
            const t = TRANSLATIONS[currentLang];
            const grid = document.getElementById('labelsGrid');
            grid.innerHTML = LABELS.map(label => `
                <div class="label-btn ${currentLabelId === label.id ? 'active' : ''}" onclick="selectLabel('${label.id}')">
                    <div class="dot ${label.id}"></div>
                    <div class="info">
                        <div class="name">${t.labels[label.id].name}</div>
                        <div class="desc">${t.labels[label.id].desc}</div>
                    </div>
                    <div class="check">${currentLabelId === label.id ? '‚úì' : ''}</div>
                </div>
            `).join('');
        }

        function updateCurrentLabelDisplay() {
            const t = TRANSLATIONS[currentLang];
            const el = document.getElementById('currentLabel');
            if (currentLabelId) {
                el.textContent = t.labels[currentLabelId].name;
                el.className = 'current-label-value ' + currentLabelId;
            } else {
                el.textContent = t.notClassified;
                el.className = 'current-label-value';
            }
        }

        // ============== SELECT LABEL ==============
        function selectLabel(labelId) {
            const label = LABELS.find(l => l.id === labelId);
            
            if (currentLabelPriority > 0 && label.priority < currentLabelPriority) {
                pendingLabel = label;
                const t = TRANSLATIONS[currentLang];
                document.getElementById('fromLabel').textContent = t.labels[currentLabelId].name;
                document.getElementById('toLabel').textContent = t.labels[labelId].name;
                document.getElementById('justificationModal').classList.add('active');
                document.querySelectorAll('input[name="justification"]').forEach(r => r.checked = false);
                document.getElementById('otherReason').value = '';
                document.getElementById('otherReason').classList.remove('visible');
                return;
            }
            
            applyLabel(label, null);
        }

        function closeModal() {
            document.getElementById('justificationModal').classList.remove('active');
            pendingLabel = null;
        }

        function confirmJustification() {
            const selected = document.querySelector('input[name="justification"]:checked');
            if (!selected) { alert('Please select a justification'); return; }
            if (!pendingLabel) { closeModal(); return; }
            
            const t = TRANSLATIONS[currentLang];
            let justificationText = '';
            switch(selected.value) {
                case 'manager_approved': justificationText = t.justOpt1; break;
                case 'data_removed': justificationText = t.justOpt2; break;
                case 'classification_error': justificationText = t.justOpt3; break;
                case 'other': justificationText = document.getElementById('otherReason').value || 'Other'; break;
            }
            
            const justification = { code: selected.value, text: justificationText, from: currentLabelId, to: pendingLabel.id, timestamp: new Date().toISOString() };
            const labelToApply = pendingLabel;
            closeModal();
            applyLabel(labelToApply, justification);
        }

        // ============== APPLY LABEL (existing code) ==============
        async function applyLabel(label, justification) {
            try {
                showStatus('info', 'Applying...');
                const host = Office.context.host;
                const t = TRANSLATIONS[currentLang];
                const labelName = t.labels[label.id].name.toUpperCase();
                
                if (host === Office.HostType.Word) await applyToWord(label, labelName, justification);
                else if (host === Office.HostType.Excel) await applyToExcel(label, labelName, justification);
                else if (host === Office.HostType.PowerPoint) await applyToPowerPoint(label, labelName, justification);
                
                currentLabelId = label.id;
                currentLabelPriority = label.priority;
                renderLabels();
                updateCurrentLabelDisplay();
                await sendAuditLog(label, justification);
                showStatus('success', t.successApplied);
                setTimeout(hideStatus, 3000);
            } catch (error) {
                console.error('Error:', error);
                showStatus('error', 'Error: ' + error.message);
            }
        }

        async function applyToWord(label, labelName, justification) {
            await Word.run(async (context) => {
                const props = context.document.properties.customProperties;
                props.load('items');
                await context.sync();
                for (let item of props.items) { if (item.key.startsWith('_DLPO_')) item.delete(); }
                await context.sync();
                props.add('_DLPO_Classification', label.id);
                props.add('_DLPO_ClassifiedAt', new Date().toISOString());
                props.add('_DLPO_ClassifiedBy', currentUserEmail);
                if (justification) {
                    props.add('_DLPO_DowngradedFrom', justification.from);
                    props.add('_DLPO_DowngradedAt', justification.timestamp);
                    props.add('_DLPO_DowngradeJustification', justification.code);
                    props.add('_DLPO_DowngradeReason', justification.text);
                }
                if (document.getElementById('addHeader').checked) {
                    const header = context.document.sections.getFirst().getHeader('Primary');
                    header.clear();
                    const para = header.insertParagraph(`[${labelName}]`, 'Start');
                    para.font.bold = true; para.font.color = label.color; para.alignment = 'Centered';
                }
                if (document.getElementById('addFooter').checked) {
                    const footer = context.document.sections.getFirst().getFooter('Primary');
                    footer.clear();
                    const para = footer.insertParagraph(`Classification: ${labelName}`, 'Start');
                    para.font.size = 10; para.font.color = '#666666'; para.alignment = 'Centered';
                }
                await context.sync();
            });
        }

        async function applyToExcel(label, labelName, justification) {
            await Excel.run(async (context) => {
                const props = context.workbook.properties.custom;
                props.add('_DLPO_Classification', label.id);
                props.add('_DLPO_ClassifiedAt', new Date().toISOString());
                props.add('_DLPO_ClassifiedBy', currentUserEmail);
                if (justification) { props.add('_DLPO_DowngradedFrom', justification.from); props.add('_DLPO_DowngradeJustification', justification.code); }
                await context.sync();
            });
        }

        async function applyToPowerPoint(label, labelName, justification) {
            await PowerPoint.run(async (context) => {
                const tags = context.presentation.tags;
                tags.add('_DLPO_Classification', label.id);
                tags.add('_DLPO_ClassifiedAt', new Date().toISOString());
                tags.add('_DLPO_ClassifiedBy', currentUserEmail);
                if (justification) { tags.add('_DLPO_DowngradedFrom', justification.from); tags.add('_DLPO_DowngradeJustification', justification.code); }
                await context.sync();
            });
        }

        async function loadCurrentLabel() {
            try {
                const host = Office.context.host;
                let labelId = null;
                if (host === Office.HostType.Word) {
                    await Word.run(async (context) => {
                        const props = context.document.properties.customProperties;
                        props.load('items');
                        await context.sync();
                        for (let item of props.items) { if (item.key === '_DLPO_Classification') { labelId = item.value; break; } }
                    });
                }
                if (labelId) {
                    currentLabelId = labelId;
                    const labelObj = LABELS.find(l => l.id === labelId);
                    if (labelObj) currentLabelPriority = labelObj.priority;
                    renderLabels();
                    updateCurrentLabelDisplay();
                }
            } catch (e) { console.log('Error loading label:', e); }
        }

        async function sendAuditLog(label, justification) {
            try {
                const payload = {
                    tenantId: 'mazeloc', action: justification ? 'LABEL_DOWNGRADE' : 'LABEL_APPLIED',
                    label: label.id, previousLabel: justification ? justification.from : null,
                    user: currentUserEmail, document: { name: Office.context.document?.url || 'unknown', app: Office.context.host },
                    justification: justification, timestamp: new Date().toISOString()
                };
                await fetch(AUDIT_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            } catch (e) { console.error('Audit log failed:', e); }
        }

        // ============== DRM FUNCTIONS ==============
        function openDRMModal() {
            if (!currentLabelId) {
                alert('Please apply a classification first!');
                return;
            }
            document.getElementById('drmModal').classList.add('active');
        }

        function closeDRMModal() {
            document.getElementById('drmModal').classList.remove('active');
        }

        async function applyDRMProtection() {
            try {
                showStatus('info', 'üîê Applying DRM protection...');
                
                const domains = document.getElementById('drmDomains').value.split(',').map(d => d.trim()).filter(d => d);
                const emails = document.getElementById('drmEmails').value.split(',').map(e => e.trim()).filter(e => e);
                const expiry = document.getElementById('drmExpiry').value || null;
                
                const rights = [];
                if (document.getElementById('drmRightView').checked) rights.push('VIEW');
                if (document.getElementById('drmRightPrint').checked) rights.push('PRINT');
                if (document.getElementById('drmRightEdit').checked) rights.push('EDIT');
                
                if (domains.length === 0 && emails.length === 0) {
                    alert('Please specify at least one allowed domain or email');
                    return;
                }

                // Generate a random DEK (32 bytes for AES-256)
                const dekArray = new Uint8Array(32);
                window.crypto.getRandomValues(dekArray);
                const dekBase64 = btoa(String.fromCharCode(...dekArray));

                const docName = Office.context.document?.url || 'document';
                
                const response = await fetch(`${DRM_API_BASE}/keys/protect`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        dek: dekBase64,
                        documentName: docName,
                        classification: currentLabelId.toUpperCase(),
                        tenantId: 'mazeloc',
                        userEmail: currentUserEmail,
                        policy: {
                            allowedDomains: domains,
                            allowedEmails: emails,
                            rights: rights,
                            expiry: expiry
                        }
                    })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'DRM protection failed');
                }

                const result = await response.json();
                currentDocId = result.docId;
                
                // Store docId in document properties
                await storeDocIdInDocument(result.docId);
                
                closeDRMModal();
                updateDRMStatus(true, result.docId);
                showStatus('success', 'üîê DRM Protection applied!');
                setTimeout(hideStatus, 3000);
                
            } catch (error) {
                console.error('DRM Error:', error);
                showStatus('error', 'DRM Error: ' + error.message);
            }
        }

        async function storeDocIdInDocument(docId) {
            const host = Office.context.host;
            if (host === Office.HostType.Word) {
                await Word.run(async (context) => {
                    const props = context.document.properties.customProperties;
                    props.add('_DLPO_DRM_DocId', docId);
                    props.add('_DLPO_DRM_Protected', 'true');
                    props.add('_DLPO_DRM_ProtectedAt', new Date().toISOString());
                    props.add('_DLPO_DRM_ProtectedBy', currentUserEmail);
                    await context.sync();
                });
            }
        }

        async function checkDRMStatus() {
            try {
                const host = Office.context.host;
                if (host === Office.HostType.Word) {
                    await Word.run(async (context) => {
                        const props = context.document.properties.customProperties;
                        props.load('items');
                        await context.sync();
                        for (let item of props.items) {
                            if (item.key === '_DLPO_DRM_DocId') {
                                currentDocId = item.value;
                                updateDRMStatus(true, item.value);
                                break;
                            }
                        }
                    });
                }
            } catch (e) { console.log('Error checking DRM:', e); }
        }

        function updateDRMStatus(isProtected, docId) {
            const statusEl = document.getElementById('drmStatus');
            const protectBtn = document.getElementById('btnProtectDRM');
            const revokeBtn = document.getElementById('btnRevokeDRM');
            
            if (isProtected) {
                statusEl.className = 'drm-status protected';
                statusEl.innerHTML = `‚úÖ Protected<br><small>ID: ${docId.substring(0, 20)}...</small>`;
                protectBtn.disabled = true;
                protectBtn.textContent = '‚úÖ Already Protected';
                revokeBtn.style.display = 'block';
            } else {
                statusEl.className = 'drm-status';
                protectBtn.disabled = false;
                protectBtn.textContent = 'üîí Protect with DRM';
                revokeBtn.style.display = 'none';
            }
        }

        async function revokeDocumentDRM() {
            if (!currentDocId) { alert('No DRM protection found'); return; }
            if (!confirm('Are you sure you want to revoke access to this document? No one will be able to open it anymore.')) return;
            
            try {
                showStatus('info', 'üö´ Revoking access...');
                
                const response = await fetch(`${DRM_API_BASE}/keys/revoke`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        docId: currentDocId,
                        tenantId: 'mazeloc',
                        userEmail: currentUserEmail
                    })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Revocation failed');
                }

                showStatus('success', 'üö´ Access revoked!');
                document.getElementById('drmStatus').className = 'drm-status info';
                document.getElementById('drmStatus').innerHTML = 'üö´ Access REVOKED';
                document.getElementById('btnRevokeDRM').style.display = 'none';
                
            } catch (error) {
                console.error('Revoke Error:', error);
                showStatus('error', 'Error: ' + error.message);
            }
        }

        // ============== STATUS ==============
        function showStatus(type, message) {
            const el = document.getElementById('status');
            el.className = 'status ' + type;
            el.textContent = message;
        }

        function hideStatus() {
            document.getElementById('status').className = 'status';
        }
    </script>
</body>
</html>
