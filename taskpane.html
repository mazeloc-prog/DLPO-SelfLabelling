<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DLPO Classification</title>
    <script src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
            max-width: 350px;
            margin: 0 auto;
        }
        .header {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h1 { font-size: 18px; margin-bottom: 5px; }
        .header p { font-size: 12px; opacity: 0.8; }
        .header .user-info { font-size: 11px; opacity: 0.9; margin-top: 8px; padding: 4px 10px; background: rgba(255,255,255,0.15); border-radius: 12px; display: inline-block; }
        .content { padding: 20px; }
        
        .current-label {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        .current-label-title { font-size: 11px; color: #666; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .current-label-value {
            font-size: 16px;
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
        }
        
        .section-title { font-size: 11px; color: #666; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
        
        .labels-grid { display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; }
        .label-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .label-btn:hover { border-color: #667eea; transform: translateX(5px); }
        .label-btn.active { border-color: #667eea; background: #f0f4ff; }
        .label-dot { width: 12px; height: 12px; border-radius: 50%; }
        .label-btn span { flex: 1; font-weight: 500; }
        .label-btn .check { display: none; color: #667eea; font-weight: bold; }
        .label-btn.active .check { display: block; }
        
        .public .label-dot, .public { --color: #10B981; }
        .internal .label-dot, .internal { --color: #3B82F6; }
        .confidential .label-dot, .confidential { --color: #F59E0B; }
        .restricted .label-dot, .restricted { --color: #EF4444; }
        .label-dot { background: var(--color); }
        .current-label-value.public { background: #D1FAE5; color: #065F46; }
        .current-label-value.internal { background: #DBEAFE; color: #1E40AF; }
        .current-label-value.confidential { background: #FEF3C7; color: #92400E; }
        .current-label-value.restricted { background: #FEE2E2; color: #991B1B; }
        
        .options { margin-bottom: 20px; }
        .option-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .option-item:last-child { border-bottom: none; }
        .option-item input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .option-item label { flex: 1; font-size: 14px; cursor: pointer; }
        
        .status {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-size: 13px;
            display: none;
        }
        .status.success { display: block; background: #D1FAE5; color: #065F46; }
        .status.error { display: block; background: #FEE2E2; color: #991B1B; }
        .status.warning { display: block; background: #FEF3C7; color: #92400E; }
        
        .footer {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            font-size: 11px;
            color: #999;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 500;
        }
        .loading-overlay.show { display: flex; }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e0e0e0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Modal Justification */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-overlay.show { display: flex; }
        .modal {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 340px;
            overflow: hidden;
            animation: modalIn 0.3s ease;
        }
        @keyframes modalIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .modal-header {
            background: #FEF3C7;
            padding: 20px;
            text-align: center;
        }
        .modal-header .icon { font-size: 32px; margin-bottom: 10px; }
        .modal-header h2 { font-size: 16px; color: #92400E; }
        .modal-body { padding: 20px; }
        .downgrade-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .downgrade-info .arrow { color: #666; }
        .justification-options { display: flex; flex-direction: column; gap: 8px; }
        .justification-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .justification-option:hover { border-color: #F59E0B; }
        .justification-option.selected { border-color: #F59E0B; background: #FEF3C7; }
        .justification-option input { display: none; }
        .justification-option .radio {
            width: 18px;
            height: 18px;
            border: 2px solid #ccc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .justification-option.selected .radio { border-color: #F59E0B; }
        .justification-option.selected .radio::after {
            content: '';
            width: 10px;
            height: 10px;
            background: #F59E0B;
            border-radius: 50%;
        }
        .other-reason {
            display: none;
            margin-top: 10px;
        }
        .other-reason.show { display: block; }
        .other-reason textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            resize: none;
            font-family: inherit;
        }
        .modal-footer {
            display: flex;
            gap: 10px;
            padding: 20px;
            border-top: 1px solid #eee;
        }
        .modal-btn {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .modal-btn.cancel { background: #f0f0f0; border: none; color: #666; }
        .modal-btn.cancel:hover { background: #e0e0e0; }
        .modal-btn.confirm { background: #F59E0B; border: none; color: white; }
        .modal-btn.confirm:hover { background: #D97706; }
        .modal-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="container">
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-spinner"></div>
        </div>
        <div class="header">
            <h1 id="headerTitle">ðŸ·ï¸ Classification</h1>
            <p id="headerSubtitle">SÃ©lectionnez le niveau de sensibilitÃ©</p>
            <div class="user-info" id="userInfo">ðŸ‘¤ Chargement...</div>
        </div>
        
        <div class="content">
            <div class="current-label">
                <div class="current-label-title" id="currentLabelTitle">Label actuel</div>
                <div class="current-label-value" id="currentLabel">Chargement...</div>
            </div>
            
            <div class="section-title" id="chooseLabelTitle">Choisir un label</div>
            <div class="labels-grid">
                <button class="label-btn public" data-label="Public" data-priority="1">
                    <div class="label-dot"></div>
                    <span id="labelPublic">Public</span>
                    <div class="check">âœ“</div>
                </button>
                <button class="label-btn internal" data-label="Internal" data-priority="2">
                    <div class="label-dot"></div>
                    <span id="labelInternal">Internal</span>
                    <div class="check">âœ“</div>
                </button>
                <button class="label-btn confidential" data-label="Confidential" data-priority="3">
                    <div class="label-dot"></div>
                    <span id="labelConfidential">Confidential</span>
                    <div class="check">âœ“</div>
                </button>
                <button class="label-btn restricted" data-label="Restricted" data-priority="4">
                    <div class="label-dot"></div>
                    <span id="labelRestricted">Restricted</span>
                    <div class="check">âœ“</div>
                </button>
            </div>
            
            <div class="options">
                <div class="section-title" id="optionsTitle">Options de marquage</div>
                <div class="option-item">
                    <input type="checkbox" id="optHeader">
                    <label for="optHeader" id="optHeaderLabel">Ajouter dans l'en-tÃªte</label>
                </div>
                <div class="option-item">
                    <input type="checkbox" id="optFooter" checked>
                    <label for="optFooter" id="optFooterLabel">Ajouter dans le pied de page</label>
                </div>
                <div class="option-item">
                    <input type="checkbox" id="optWatermark">
                    <label for="optWatermark" id="optWatermarkLabel">Ajouter un filigrane</label>
                </div>
            </div>
            
            <div class="status" id="status"></div>
        </div>
        
        <div class="footer">DLPO Classification v2.2 - i18n</div>
    </div>
    
    <!-- Modal Justification -->
    <div class="modal-overlay" id="justificationModal">
        <div class="modal">
            <div class="modal-header">
                <div class="icon">âš ï¸</div>
                <h2 id="modalTitle">Justification requise</h2>
            </div>
            <div class="modal-body">
                <p id="modalDesc" style="margin-bottom: 15px; font-size: 13px; color: #666;">Vous abaissez le niveau de classification :</p>
                <div class="downgrade-info">
                    <span id="fromLabel" class="current-label-value restricted">Restricted</span>
                    <span class="arrow">â†’</span>
                    <span id="toLabel" class="current-label-value public">Public</span>
                </div>
                <p id="modalAsk" style="margin-bottom: 10px; font-size: 13px; color: #666;">Veuillez indiquer la raison :</p>
                <div class="justification-options">
                    <label class="justification-option" data-value="manager_approved">
                        <input type="radio" name="justification">
                        <div class="radio"></div>
                        <span id="justifManagerApproved">ApprouvÃ© par mon manager</span>
                    </label>
                    <label class="justification-option" data-value="data_removed">
                        <input type="radio" name="justification">
                        <div class="radio"></div>
                        <span id="justifDataRemoved">DonnÃ©es sensibles retirÃ©es</span>
                    </label>
                    <label class="justification-option" data-value="classification_error">
                        <input type="radio" name="justification">
                        <div class="radio"></div>
                        <span id="justifClassificationError">Erreur de classification initiale</span>
                    </label>
                    <label class="justification-option" data-value="other">
                        <input type="radio" name="justification">
                        <div class="radio"></div>
                        <span id="justifOther">Autre raison</span>
                    </label>
                </div>
                <div class="other-reason" id="otherReason">
                    <textarea id="otherReasonText" rows="3" placeholder="PrÃ©cisez la raison..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" id="cancelJustification">Annuler</button>
                <button class="modal-btn confirm" id="confirmJustification" disabled>Confirmer</button>
            </div>
        </div>
    </div>

    <script>
        // === VARIABLES GLOBALES ===
        let selectedLabel = null;
        let currentLabelValue = null;
        let currentLabelPriority = 0;
        let pendingDowngrade = null;
        let currentUserEmail = 'unknown';
        let t = {}; // Traductions
        
        // URL de l'API Azure Function pour les logs
        const AUDIT_API_URL = 'https://dlpo-audit-api-fddddvbncrbfc6b5.francecentral-01.azurewebsites.net/api/log-event';
        
        // === i18n - TRADUCTIONS ===
        const translations = {
            'fr': {
                title: 'ðŸ·ï¸ Classification',
                subtitle: 'SÃ©lectionnez le niveau de sensibilitÃ©',
                currentLabel: 'Label actuel',
                notClassified: 'Non classifiÃ©',
                chooseLabel: 'Choisir un label',
                public: 'Public',
                internal: 'Interne',
                confidential: 'Confidentiel',
                restricted: 'Restreint',
                markingOptions: 'Options de marquage',
                addHeader: "Ajouter dans l'en-tÃªte",
                addFooter: 'Ajouter dans le pied de page',
                addWatermark: 'Ajouter un filigrane',
                success: 'Label "{label}" appliquÃ© avec succÃ¨s !',
                successDowngrade: 'Label "{label}" appliquÃ© avec succÃ¨s ! (downgrade justifiÃ©)',
                error: 'Erreur',
                justificationRequired: 'Justification requise',
                justificationDesc: 'Vous abaissez le niveau de classification :',
                justificationAsk: 'Veuillez indiquer la raison :',
                managerApproved: 'ApprouvÃ© par mon manager',
                dataRemoved: 'DonnÃ©es sensibles retirÃ©es',
                classificationError: 'Erreur de classification initiale',
                otherReason: 'Autre raison',
                otherReasonPlaceholder: 'PrÃ©cisez la raison...',
                cancel: 'Annuler',
                confirm: 'Confirmer',
                loading: 'Chargement...',
                notConnected: 'Non connectÃ©',
                pleaseSpecify: 'Veuillez prÃ©ciser la raison'
            },
            'en': {
                title: 'ðŸ·ï¸ Classification',
                subtitle: 'Select sensitivity level',
                currentLabel: 'Current label',
                notClassified: 'Not classified',
                chooseLabel: 'Choose a label',
                public: 'Public',
                internal: 'Internal',
                confidential: 'Confidential',
                restricted: 'Restricted',
                markingOptions: 'Marking options',
                addHeader: 'Add to header',
                addFooter: 'Add to footer',
                addWatermark: 'Add watermark',
                success: 'Label "{label}" applied successfully!',
                successDowngrade: 'Label "{label}" applied successfully! (downgrade justified)',
                error: 'Error',
                justificationRequired: 'Justification required',
                justificationDesc: 'You are lowering the classification level:',
                justificationAsk: 'Please provide a reason:',
                managerApproved: 'Approved by my manager',
                dataRemoved: 'Sensitive data removed',
                classificationError: 'Initial classification error',
                otherReason: 'Other reason',
                otherReasonPlaceholder: 'Specify the reason...',
                cancel: 'Cancel',
                confirm: 'Confirm',
                loading: 'Loading...',
                notConnected: 'Not connected',
                pleaseSpecify: 'Please specify the reason'
            },
            'de': {
                title: 'ðŸ·ï¸ Klassifizierung',
                subtitle: 'SensibilitÃ¤tsstufe auswÃ¤hlen',
                currentLabel: 'Aktuelles Label',
                notClassified: 'Nicht klassifiziert',
                chooseLabel: 'Label auswÃ¤hlen',
                public: 'Ã–ffentlich',
                internal: 'Intern',
                confidential: 'Vertraulich',
                restricted: 'EingeschrÃ¤nkt',
                markingOptions: 'Markierungsoptionen',
                addHeader: 'Zur Kopfzeile hinzufÃ¼gen',
                addFooter: 'Zur FuÃŸzeile hinzufÃ¼gen',
                addWatermark: 'Wasserzeichen hinzufÃ¼gen',
                success: 'Label "{label}" erfolgreich angewendet!',
                successDowngrade: 'Label "{label}" erfolgreich angewendet! (Herabstufung begrÃ¼ndet)',
                error: 'Fehler',
                justificationRequired: 'BegrÃ¼ndung erforderlich',
                justificationDesc: 'Sie senken die Klassifizierungsstufe:',
                justificationAsk: 'Bitte geben Sie einen Grund an:',
                managerApproved: 'Von meinem Manager genehmigt',
                dataRemoved: 'Sensible Daten entfernt',
                classificationError: 'UrsprÃ¼nglicher Klassifizierungsfehler',
                otherReason: 'Anderer Grund',
                otherReasonPlaceholder: 'Grund angeben...',
                cancel: 'Abbrechen',
                confirm: 'BestÃ¤tigen',
                loading: 'Laden...',
                notConnected: 'Nicht verbunden',
                pleaseSpecify: 'Bitte geben Sie den Grund an'
            },
            'es': {
                title: 'ðŸ·ï¸ ClasificaciÃ³n',
                subtitle: 'Seleccione el nivel de sensibilidad',
                currentLabel: 'Etiqueta actual',
                notClassified: 'No clasificado',
                chooseLabel: 'Elegir etiqueta',
                public: 'PÃºblico',
                internal: 'Interno',
                confidential: 'Confidencial',
                restricted: 'Restringido',
                markingOptions: 'Opciones de marcado',
                addHeader: 'Agregar al encabezado',
                addFooter: 'Agregar al pie de pÃ¡gina',
                addWatermark: 'Agregar marca de agua',
                success: 'Â¡Etiqueta "{label}" aplicada con Ã©xito!',
                successDowngrade: 'Â¡Etiqueta "{label}" aplicada con Ã©xito! (degradaciÃ³n justificada)',
                error: 'Error',
                justificationRequired: 'JustificaciÃ³n requerida',
                justificationDesc: 'EstÃ¡ bajando el nivel de clasificaciÃ³n:',
                justificationAsk: 'Por favor indique el motivo:',
                managerApproved: 'Aprobado por mi gerente',
                dataRemoved: 'Datos sensibles eliminados',
                classificationError: 'Error de clasificaciÃ³n inicial',
                otherReason: 'Otra razÃ³n',
                otherReasonPlaceholder: 'Especifique la razÃ³n...',
                cancel: 'Cancelar',
                confirm: 'Confirmar',
                loading: 'Cargando...',
                notConnected: 'No conectado',
                pleaseSpecify: 'Por favor especifique la razÃ³n'
            },
            'it': {
                title: 'ðŸ·ï¸ Classificazione',
                subtitle: 'Seleziona il livello di sensibilitÃ ',
                currentLabel: 'Etichetta attuale',
                notClassified: 'Non classificato',
                chooseLabel: 'Scegli etichetta',
                public: 'Pubblico',
                internal: 'Interno',
                confidential: 'Riservato',
                restricted: 'Limitato',
                markingOptions: 'Opzioni di marcatura',
                addHeader: "Aggiungi all'intestazione",
                addFooter: 'Aggiungi al piÃ¨ di pagina',
                addWatermark: 'Aggiungi filigrana',
                success: 'Etichetta "{label}" applicata con successo!',
                successDowngrade: 'Etichetta "{label}" applicata con successo! (declassamento giustificato)',
                error: 'Errore',
                justificationRequired: 'Giustificazione richiesta',
                justificationDesc: 'Stai abbassando il livello di classificazione:',
                justificationAsk: 'Indica il motivo:',
                managerApproved: 'Approvato dal mio manager',
                dataRemoved: 'Dati sensibili rimossi',
                classificationError: 'Errore di classificazione iniziale',
                otherReason: 'Altro motivo',
                otherReasonPlaceholder: 'Specifica il motivo...',
                cancel: 'Annulla',
                confirm: 'Conferma',
                loading: 'Caricamento...',
                notConnected: 'Non connesso',
                pleaseSpecify: 'Specifica il motivo'
            },
            'pt': {
                title: 'ðŸ·ï¸ ClassificaÃ§Ã£o',
                subtitle: 'Selecione o nÃ­vel de sensibilidade',
                currentLabel: 'RÃ³tulo atual',
                notClassified: 'NÃ£o classificado',
                chooseLabel: 'Escolher rÃ³tulo',
                public: 'PÃºblico',
                internal: 'Interno',
                confidential: 'Confidencial',
                restricted: 'Restrito',
                markingOptions: 'OpÃ§Ãµes de marcaÃ§Ã£o',
                addHeader: 'Adicionar ao cabeÃ§alho',
                addFooter: 'Adicionar ao rodapÃ©',
                addWatermark: 'Adicionar marca d\'Ã¡gua',
                success: 'RÃ³tulo "{label}" aplicado com sucesso!',
                successDowngrade: 'RÃ³tulo "{label}" aplicado com sucesso! (rebaixamento justificado)',
                error: 'Erro',
                justificationRequired: 'Justificativa necessÃ¡ria',
                justificationDesc: 'VocÃª estÃ¡ reduzindo o nÃ­vel de classificaÃ§Ã£o:',
                justificationAsk: 'Por favor, indique o motivo:',
                managerApproved: 'Aprovado pelo meu gerente',
                dataRemoved: 'Dados sensÃ­veis removidos',
                classificationError: 'Erro de classificaÃ§Ã£o inicial',
                otherReason: 'Outro motivo',
                otherReasonPlaceholder: 'Especifique o motivo...',
                cancel: 'Cancelar',
                confirm: 'Confirmar',
                loading: 'Carregando...',
                notConnected: 'NÃ£o conectado',
                pleaseSpecify: 'Por favor, especifique o motivo'
            },
            'nl': {
                title: 'ðŸ·ï¸ Classificatie',
                subtitle: 'Selecteer gevoeligheidsniveau',
                currentLabel: 'Huidig label',
                notClassified: 'Niet geclassificeerd',
                chooseLabel: 'Kies label',
                public: 'Openbaar',
                internal: 'Intern',
                confidential: 'Vertrouwelijk',
                restricted: 'Beperkt',
                markingOptions: 'Markeringsopties',
                addHeader: 'Toevoegen aan koptekst',
                addFooter: 'Toevoegen aan voettekst',
                addWatermark: 'Watermerk toevoegen',
                success: 'Label "{label}" succesvol toegepast!',
                successDowngrade: 'Label "{label}" succesvol toegepast! (verlaging gerechtvaardigd)',
                error: 'Fout',
                justificationRequired: 'Rechtvaardiging vereist',
                justificationDesc: 'U verlaagt het classificatieniveau:',
                justificationAsk: 'Geef de reden aan:',
                managerApproved: 'Goedgekeurd door mijn manager',
                dataRemoved: 'Gevoelige gegevens verwijderd',
                classificationError: 'InitiÃ«le classificatiefout',
                otherReason: 'Andere reden',
                otherReasonPlaceholder: 'Specificeer de reden...',
                cancel: 'Annuleren',
                confirm: 'Bevestigen',
                loading: 'Laden...',
                notConnected: 'Niet verbonden',
                pleaseSpecify: 'Geef de reden op'
            },
            'ar': {
                title: 'ðŸ·ï¸ Ø§Ù„ØªØµÙ†ÙŠÙ',
                subtitle: 'Ø­Ø¯Ø¯ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ©',
                currentLabel: 'Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø­Ø§Ù„ÙŠ',
                notClassified: 'ØºÙŠØ± Ù…ØµÙ†Ù',
                chooseLabel: 'Ø§Ø®ØªØ± ØªØµÙ†ÙŠÙ',
                public: 'Ø¹Ø§Ù…',
                internal: 'Ø¯Ø§Ø®Ù„ÙŠ',
                confidential: 'Ø³Ø±ÙŠ',
                restricted: 'Ù…Ù‚ÙŠØ¯',
                markingOptions: 'Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª',
                addHeader: 'Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø£Ø³',
                addFooter: 'Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„ØªØ°ÙŠÙŠÙ„',
                addWatermark: 'Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ø§Ù…Ø© Ù…Ø§Ø¦ÙŠØ©',
                success: 'ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØµÙ†ÙŠÙ "{label}" Ø¨Ù†Ø¬Ø§Ø­!',
                successDowngrade: 'ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØµÙ†ÙŠÙ "{label}" Ø¨Ù†Ø¬Ø§Ø­! (ØªØ®ÙÙŠØ¶ Ù…Ø¨Ø±Ø±)',
                error: 'Ø®Ø·Ø£',
                justificationRequired: 'Ø§Ù„ØªØ¨Ø±ÙŠØ± Ù…Ø·Ù„ÙˆØ¨',
                justificationDesc: 'Ø£Ù†Øª ØªØ®ÙØ¶ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØµÙ†ÙŠÙ:',
                justificationAsk: 'ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø¨Ø¨:',
                managerApproved: 'ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡ Ù…Ø¯ÙŠØ±ÙŠ',
                dataRemoved: 'ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø©',
                classificationError: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø£ÙˆÙ„ÙŠ',
                otherReason: 'Ø³Ø¨Ø¨ Ø¢Ø®Ø±',
                otherReasonPlaceholder: 'Ø­Ø¯Ø¯ Ø§Ù„Ø³Ø¨Ø¨...',
                cancel: 'Ø¥Ù„ØºØ§Ø¡',
                confirm: 'ØªØ£ÙƒÙŠØ¯',
                loading: 'Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„...',
                notConnected: 'ØºÙŠØ± Ù…ØªØµÙ„',
                pleaseSpecify: 'ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø¨Ø¨'
            }
        };
        
        // Fonction pour dÃ©tecter et appliquer la langue
        function initLanguage() {
            const lang = (Office.context.displayLanguage || navigator.language || 'en').substring(0, 2).toLowerCase();
            t = translations[lang] || translations['en'];
            console.log('Language detected:', lang, '-> using:', translations[lang] ? lang : 'en (fallback)');
            applyTranslations();
        }
        
        // Appliquer les traductions Ã  l'interface
        function applyTranslations() {
            // Header
            const headerTitle = document.getElementById('headerTitle');
            const headerSubtitle = document.getElementById('headerSubtitle');
            if (headerTitle) headerTitle.textContent = t.title;
            if (headerSubtitle) headerSubtitle.textContent = t.subtitle;
            
            // Current label
            const currentLabelTitle = document.getElementById('currentLabelTitle');
            if (currentLabelTitle) currentLabelTitle.textContent = t.currentLabel;
            
            // Choose label title
            const chooseLabelTitle = document.getElementById('chooseLabelTitle');
            if (chooseLabelTitle) chooseLabelTitle.textContent = t.chooseLabel;
            
            // Labels
            const labelPublic = document.getElementById('labelPublic');
            const labelInternal = document.getElementById('labelInternal');
            const labelConfidential = document.getElementById('labelConfidential');
            const labelRestricted = document.getElementById('labelRestricted');
            if (labelPublic) labelPublic.textContent = t.public;
            if (labelInternal) labelInternal.textContent = t.internal;
            if (labelConfidential) labelConfidential.textContent = t.confidential;
            if (labelRestricted) labelRestricted.textContent = t.restricted;
            
            // Options
            const optionsTitle = document.getElementById('optionsTitle');
            const optHeaderLabel = document.getElementById('optHeaderLabel');
            const optFooterLabel = document.getElementById('optFooterLabel');
            const optWatermarkLabel = document.getElementById('optWatermarkLabel');
            if (optionsTitle) optionsTitle.textContent = t.markingOptions;
            if (optHeaderLabel) optHeaderLabel.textContent = t.addHeader;
            if (optFooterLabel) optFooterLabel.textContent = t.addFooter;
            if (optWatermarkLabel) optWatermarkLabel.textContent = t.addWatermark;
            
            // Modal
            const modalTitle = document.getElementById('modalTitle');
            const modalDesc = document.getElementById('modalDesc');
            const modalAsk = document.getElementById('modalAsk');
            const justifManagerApproved = document.getElementById('justifManagerApproved');
            const justifDataRemoved = document.getElementById('justifDataRemoved');
            const justifClassificationError = document.getElementById('justifClassificationError');
            const justifOther = document.getElementById('justifOther');
            const otherReasonText = document.getElementById('otherReasonText');
            const cancelJustification = document.getElementById('cancelJustification');
            const confirmJustification = document.getElementById('confirmJustification');
            
            if (modalTitle) modalTitle.textContent = t.justificationRequired;
            if (modalDesc) modalDesc.textContent = t.justificationDesc;
            if (modalAsk) modalAsk.textContent = t.justificationAsk;
            if (justifManagerApproved) justifManagerApproved.textContent = t.managerApproved;
            if (justifDataRemoved) justifDataRemoved.textContent = t.dataRemoved;
            if (justifClassificationError) justifClassificationError.textContent = t.classificationError;
            if (justifOther) justifOther.textContent = t.otherReason;
            if (otherReasonText) otherReasonText.placeholder = t.otherReasonPlaceholder;
            if (cancelJustification) cancelJustification.textContent = t.cancel;
            if (confirmJustification) confirmJustification.textContent = t.confirm;
        }
        
        const labelPriorities = {
            'Public': 1,
            'Internal': 2,
            'Confidential': 3,
            'Restricted': 4
        };
        
        const labelColors = {
            'Public': 'public',
            'Internal': 'internal',
            'Confidential': 'confidential',
            'Restricted': 'restricted'
        };

        // === INITIALISATION OFFICE ===
        Office.onReady(async (info) => {
            console.log('Office.onReady - Host:', info.host);
            
            // Initialiser la langue EN PREMIER
            initLanguage();
            
            // Event listeners pour les boutons de label
            document.querySelectorAll('.label-btn').forEach(btn => {
                btn.addEventListener('click', () => selectLabel(btn));
            });
            
            // Event listeners pour la modal de justification
            document.querySelectorAll('.justification-option').forEach(opt => {
                opt.addEventListener('click', () => selectJustification(opt));
            });
            document.getElementById('cancelJustification').addEventListener('click', closeJustificationModal);
            document.getElementById('confirmJustification').addEventListener('click', confirmJustification);
            
            // AJOUT SSO : RÃ©cupÃ©rer l'utilisateur (peut Ã©chouer, pas grave)
            try {
                await getUserWithSSO();
            } catch (e) {
                console.error('SSO init error:', e);
                document.getElementById('userInfo').textContent = 'ðŸ‘¤ ' + t.notConnected;
            }
            
            // Charger le label actuel
            try {
                await loadCurrentLabel();
            } catch (e) {
                console.error('Load label error:', e);
                document.getElementById('currentLabel').textContent = t.notClassified;
                document.getElementById('currentLabel').className = 'current-label-value';
            }
        });

        // === AJOUT SSO : Fonction pour rÃ©cupÃ©rer l'utilisateur ===
        async function getUserWithSSO() {
            try {
                console.log('Getting SSO token...');
                const token = await OfficeRuntime.auth.getAccessToken({ allowSignInPrompt: true });
                console.log('Token received');
                
                // DÃ©coder le JWT token (simple base64 decode)
                const payload = JSON.parse(atob(token.split('.')[1]));
                console.log('Token payload:', payload);
                
                currentUserEmail = payload.preferred_username || payload.upn || payload.email || 'unknown';
                
                document.getElementById('userInfo').textContent = 'ðŸ‘¤ ' + currentUserEmail;
                console.log('User:', currentUserEmail);
                
            } catch (error) {
                console.error('SSO Error:', error);
                
                // Fallback 1: SharePoint Online URL
                const docUrl = Office.context.document?.url || '';
                
                if (docUrl.includes('/personal/')) {
                    // SharePoint Online: https://tenant-my.sharepoint.com/personal/user_domain_com/...
                    const match = docUrl.match(/\/personal\/([^\/]+)/);
                    if (match) {
                        const raw = match[1];
                        if (raw.includes('_onmicrosoft_')) {
                            const domainMatch = raw.match(/^(.+)_([^_]+_onmicrosoft_[^_]+)$/);
                            if (domainMatch) {
                                currentUserEmail = domainMatch[1].replace(/_/g, '.') + '@' + domainMatch[2].replace(/_/g, '.');
                            }
                        } else if (raw.match(/_[^_]+_com$/)) {
                            const domainMatch = raw.match(/^(.+)_([^_]+_com)$/);
                            if (domainMatch) {
                                currentUserEmail = domainMatch[1].replace(/_/g, '.') + '@' + domainMatch[2].replace(/_/g, '.');
                            }
                        }
                    }
                }
                
                // Fallback 2: Windows Desktop path (C:\Users\USERNAME\...)
                if (currentUserEmail === 'unknown' && docUrl.includes('\\Users\\')) {
                    const match = docUrl.match(/\\Users\\([^\\]+)\\/i);
                    if (match) {
                        currentUserEmail = match[1] + '@desktop';
                    }
                }
                
                // Fallback 3: Mac path (/Users/USERNAME/...)
                if (currentUserEmail === 'unknown' && docUrl.includes('/Users/')) {
                    const match = docUrl.match(/\/Users\/([^\/]+)\//);
                    if (match) {
                        currentUserEmail = match[1] + '@desktop';
                    }
                }
                
                document.getElementById('userInfo').textContent = 'ðŸ‘¤ ' + (currentUserEmail !== 'unknown' ? currentUserEmail : t.notConnected);
            }
        }

        // === FONCTIONS EXISTANTES (INCHANGÃ‰ES) ===
        function selectLabel(btn) {
            const newLabel = btn.dataset.label;
            const newPriority = labelPriorities[newLabel];
            
            // Si c'est le mÃªme label, ne rien faire
            if (newLabel === currentLabelValue) {
                return;
            }
            
            document.querySelectorAll('.label-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedLabel = newLabel;
            hideStatus();
            
            console.log('selectLabel - current:', currentLabelValue, 'priority:', currentLabelPriority, 'new:', newLabel, 'newPriority:', newPriority);
            
            // VÃ©rifier si c'est un downgrade
            if (currentLabelValue && currentLabelPriority > 0 && newPriority < currentLabelPriority) {
                // C'est un downgrade - demander justification
                console.log('Downgrade dÃ©tectÃ©, affichage modal');
                showJustificationModal(currentLabelValue, newLabel);
            } else {
                // Pas un downgrade - appliquer directement
                console.log('Pas de downgrade, application directe');
                applyLabel(newLabel, null);
            }
        }

        function showJustificationModal(fromLabel, toLabel) {
            pendingDowngrade = { from: fromLabel, to: toLabel };
            
            // Mettre Ã  jour l'affichage de la modal
            const fromEl = document.getElementById('fromLabel');
            const toEl = document.getElementById('toLabel');
            
            fromEl.textContent = fromLabel;
            fromEl.className = 'current-label-value ' + labelColors[fromLabel];
            
            toEl.textContent = toLabel;
            toEl.className = 'current-label-value ' + labelColors[toLabel];
            
            // Reset des sÃ©lections
            document.querySelectorAll('.justification-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.getElementById('otherReason').classList.remove('show');
            document.getElementById('otherReasonText').value = '';
            document.getElementById('confirmJustification').disabled = true;
            
            // Afficher la modal
            document.getElementById('justificationModal').classList.add('show');
        }

        function closeJustificationModal() {
            document.getElementById('justificationModal').classList.remove('show');
            pendingDowngrade = null;
        }

        function selectJustification(opt) {
            document.querySelectorAll('.justification-option').forEach(o => o.classList.remove('selected'));
            opt.classList.add('selected');
            
            const value = opt.dataset.value;
            if (value === 'other') {
                document.getElementById('otherReason').classList.add('show');
            } else {
                document.getElementById('otherReason').classList.remove('show');
            }
            
            document.getElementById('confirmJustification').disabled = false;
        }

        function confirmJustification() {
            const selectedOption = document.querySelector('.justification-option.selected');
            if (!selectedOption || !pendingDowngrade) return;
            
            const justificationCode = selectedOption.dataset.value;
            let justificationText = selectedOption.querySelector('span').textContent;
            
                if (justificationCode === 'other') {
                const otherText = document.getElementById('otherReasonText').value.trim();
                if (!otherText) {
                    alert(t.pleaseSpecify);
                    return;
                }
                justificationText = otherText;
            }
            
            const justification = {
                code: justificationCode,
                text: justificationText,
                from: pendingDowngrade.from,
                to: pendingDowngrade.to,
                timestamp: new Date().toISOString()
            };
            
            // IMPORTANT: Sauvegarder le label cible AVANT de fermer la modal
            const targetLabel = pendingDowngrade.to;
            
            // Fermer la modal
            closeJustificationModal();
            
            // Appliquer le label avec la justification
            applyLabel(targetLabel, justification);
        }

        async function applyLabel(label, justification) {
            console.log('applyLabel appelÃ© avec:', label, justification);
            
            // Afficher le loading
            document.getElementById('loadingOverlay').classList.add('show');
            
            try {
                const host = Office.context.host;
                console.log('Host dÃ©tectÃ©:', host);
                
                if (host === Office.HostType.Word) {
                    await applyLabelWord(label, justification);
                } else if (host === Office.HostType.Excel) {
                    await applyLabelExcel(label, justification);
                } else if (host === Office.HostType.PowerPoint) {
                    await applyLabelPowerPoint(label, justification);
                } else {
                    throw new Error('Application non supportÃ©e: ' + host);
                }
                
                // Mettre Ã  jour l'affichage
                updateCurrentLabelDisplay(label);
                
                // AJOUT : Envoyer le log Ã  Azure
                const action = justification ? 'LABEL_DOWNGRADE' : 'LABEL_APPLIED';
                await sendAuditLog(action, label, justification);
                
                // Message de succÃ¨s
                const isDowngrade = justification !== null;
                const msg = isDowngrade ? t.successDowngrade.replace('{label}', label) : t.success.replace('{label}', label);
                showStatus('success', 'âœ“ ' + msg);
                
            } catch (error) {
                console.error('Erreur:', error);
                showStatus('error', 'âœ— ' + t.error + ': ' + error.message);
            } finally {
                document.getElementById('loadingOverlay').classList.remove('show');
            }
        }

        async function applyLabelWord(label, justification) {
            await Word.run(async (context) => {
                const properties = context.document.properties.customProperties;
                properties.load('items');
                await context.sync();
                
                // Supprimer les anciennes propriÃ©tÃ©s DLPO si elles existent
                const keysToDelete = ['_DLPO_Classification', '_DLPO_ClassifiedAt', '_DLPO_ClassifiedBy', 
                                      '_DLPO_DowngradedFrom', '_DLPO_DowngradedAt', '_DLPO_DowngradeJustification', '_DLPO_DowngradeReason'];
                for (let item of properties.items) {
                    if (keysToDelete.includes(item.key)) {
                        item.delete();
                    }
                }
                await context.sync();
                
                // Ajouter les nouvelles propriÃ©tÃ©s
                properties.add('_DLPO_Classification', label);
                properties.add('_DLPO_ClassifiedAt', new Date().toISOString());
                properties.add('_DLPO_ClassifiedBy', currentUserEmail);  // â† MODIFIÃ‰: utilise SSO
                
                // PropriÃ©tÃ©s de justification si downgrade
                if (justification) {
                    properties.add('_DLPO_DowngradedFrom', justification.from);
                    properties.add('_DLPO_DowngradedAt', justification.timestamp);
                    properties.add('_DLPO_DowngradeJustification', justification.code);
                    properties.add('_DLPO_DowngradeReason', justification.text);
                }
                
                await context.sync();
                
                // Header
                if (document.getElementById('optHeader').checked) {
                    const sections = context.document.sections;
                    sections.load('items');
                    await context.sync();
                    
                    for (let i = 0; i < sections.items.length; i++) {
                        const header = sections.items[i].getHeader('Primary');
                        const para = header.insertParagraph(`Classification: ${label}`, 'Start');
                        para.alignment = Word.Alignment.centered;
                        const colors = { 'Public': '#10B981', 'Internal': '#3B82F6', 'Confidential': '#F59E0B', 'Restricted': '#EF4444' };
                        para.font.color = colors[label] || '#000000';
                        para.font.bold = true;
                    }
                    await context.sync();
                }
                
                // Footer
                if (document.getElementById('optFooter').checked) {
                    const sections = context.document.sections;
                    sections.load('items');
                    await context.sync();
                    
                    for (let i = 0; i < sections.items.length; i++) {
                        const footer = sections.items[i].getFooter('Primary');
                        const para = footer.insertParagraph(`Classification: ${label}`, 'End');
                        para.alignment = Word.Alignment.centered;
                        const colors = { 'Public': '#10B981', 'Internal': '#3B82F6', 'Confidential': '#F59E0B', 'Restricted': '#EF4444' };
                        para.font.color = colors[label] || '#000000';
                        para.font.bold = true;
                    }
                    await context.sync();
                }
                
                // Watermark
                if (document.getElementById('optWatermark').checked) {
                    const body = context.document.body;
                    const watermark = body.insertParagraph(label.toUpperCase(), 'Start');
                    watermark.font.color = '#E0E0E0';
                    watermark.font.size = 48;
                    watermark.alignment = Word.Alignment.centered;
                    await context.sync();
                }
            });
        }

        async function applyLabelExcel(label, justification) {
            await Excel.run(async (context) => {
                const properties = context.workbook.properties.custom;
                properties.load('items');
                await context.sync();
                
                // Supprimer les anciennes propriÃ©tÃ©s
                const keysToDelete = ['_DLPO_Classification', '_DLPO_ClassifiedAt', '_DLPO_ClassifiedBy',
                                      '_DLPO_DowngradedFrom', '_DLPO_DowngradedAt', '_DLPO_DowngradeJustification', '_DLPO_DowngradeReason'];
                for (let item of properties.items) {
                    if (keysToDelete.includes(item.key)) {
                        item.delete();
                    }
                }
                await context.sync();
                
                // Ajouter les nouvelles
                properties.add('_DLPO_Classification', label);
                properties.add('_DLPO_ClassifiedAt', new Date().toISOString());
                properties.add('_DLPO_ClassifiedBy', currentUserEmail);  // â† MODIFIÃ‰: utilise SSO
                
                if (justification) {
                    properties.add('_DLPO_DowngradedFrom', justification.from);
                    properties.add('_DLPO_DowngradedAt', justification.timestamp);
                    properties.add('_DLPO_DowngradeJustification', justification.code);
                    properties.add('_DLPO_DowngradeReason', justification.text);
                }
                
                await context.sync();
            });
        }

        async function applyLabelPowerPoint(label, justification) {
            await PowerPoint.run(async (context) => {
                const presentation = context.presentation;
                
                // PowerPoint utilise les tags
                presentation.tags.add('_DLPO_Classification', label);
                presentation.tags.add('_DLPO_ClassifiedAt', new Date().toISOString());
                presentation.tags.add('_DLPO_ClassifiedBy', currentUserEmail);  // â† MODIFIÃ‰: utilise SSO
                
                if (justification) {
                    presentation.tags.add('_DLPO_DowngradedFrom', justification.from);
                    presentation.tags.add('_DLPO_DowngradedAt', justification.timestamp);
                    presentation.tags.add('_DLPO_DowngradeJustification', justification.code);
                    presentation.tags.add('_DLPO_DowngradeReason', justification.text);
                }
                
                await context.sync();
            });
        }

        async function loadCurrentLabel() {
            try {
                const host = Office.context.host;
                let label = null;
                
                if (host === Office.HostType.Word) {
                    await Word.run(async (context) => {
                        const properties = context.document.properties.customProperties;
                        properties.load('items');
                        await context.sync();
                        
                        for (let item of properties.items) {
                            if (item.key === '_DLPO_Classification') {
                                label = item.value;
                                break;
                            }
                        }
                    });
                } else if (host === Office.HostType.Excel) {
                    await Excel.run(async (context) => {
                        const properties = context.workbook.properties.custom;
                        properties.load('items');
                        await context.sync();
                        
                        for (let item of properties.items) {
                            if (item.key === '_DLPO_Classification') {
                                label = item.value;
                                break;
                            }
                        }
                    });
                } else if (host === Office.HostType.PowerPoint) {
                    await PowerPoint.run(async (context) => {
                        const tags = context.presentation.tags;
                        tags.load('items');
                        await context.sync();
                        
                        for (let item of tags.items) {
                            if (item.key === '_DLPO_Classification' || item.key === '_dlpo_classification') {
                                label = item.value;
                                break;
                            }
                        }
                    });
                }
                
                console.log('Label chargÃ©:', label);
                
                if (label && labelPriorities[label]) {
                    updateCurrentLabelDisplay(label);
                } else {
                    document.getElementById('currentLabel').textContent = t.notClassified;
                    document.getElementById('currentLabel').className = 'current-label-value';
                    currentLabelValue = null;
                    currentLabelPriority = 0;
                }
                
            } catch (error) {
                console.error('Erreur chargement label:', error);
                document.getElementById('currentLabel').textContent = t.notClassified;
                currentLabelValue = null;
                currentLabelPriority = 0;
            }
        }

        function updateCurrentLabelDisplay(label) {
            const el = document.getElementById('currentLabel');
            el.textContent = label;
            el.className = 'current-label-value ' + labelColors[label];
            currentLabelValue = label;
            currentLabelPriority = labelPriorities[label] || 0;
            
            console.log('Label mis Ã  jour:', label, 'Priority:', currentLabelPriority);
            
            // Mettre Ã  jour le bouton actif
            document.querySelectorAll('.label-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.label === label) {
                    btn.classList.add('active');
                }
            });
            
            // RÃ©initialiser selectedLabel
            selectedLabel = label;
        }

        function showStatus(type, message) {
            const status = document.getElementById('status');
            status.className = 'status ' + type;
            status.textContent = message;
        }

        function hideStatus() {
            document.getElementById('status').className = 'status';
        }
        
        // === FONCTION AUDIT LOG (utilise maintenant currentUserEmail) ===
        async function sendAuditLog(action, label, justification = null) {
            try {
                const logData = {
                    tenantId: 'mazeloc',
                    action: action,
                    label: label,
                    previousLabel: currentLabelValue,
                    justification: justification,
                    user: currentUserEmail,  // â† MODIFIÃ‰: utilise SSO
                    document: {
                        name: Office.context.document?.url || 'unknown',
                        app: Office.context.host
                    },
                    timestamp: new Date().toISOString()
                };
                
                console.log('Sending audit log:', logData);
                
                const response = await fetch(AUDIT_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(logData)
                });
                
                if (response.ok) {
                    console.log('Audit log sent successfully');
                } else {
                    console.error('Failed to send audit log:', response.status);
                }
            } catch (error) {
                console.error('Error sending audit log:', error);
                // Ne pas bloquer l'utilisateur si le log Ã©choue
            }
        }
    </script>
</body>
</html>
