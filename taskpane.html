<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MazeShield</title>
    <script src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', sans-serif; background: #f5f5f5; min-height: 100vh; }
        .container { display: flex; flex-direction: column; min-height: 100vh; }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 20px; text-align: center; position: relative;
        }
        .header h1 { font-size: 22px; margin-bottom: 4px; }
        .header p { font-size: 12px; opacity: 0.9; }
        .user-info { background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 15px; font-size: 11px; margin-top: 10px; display: inline-block; }
        .lang-selector { position: absolute; top: 10px; right: 10px; }
        .lang-selector select { padding: 4px 8px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.2); color: white; font-size: 11px; cursor: pointer; }
        .lang-selector select option { color: #333; }
        .content { flex: 1; padding: 20px; }
        .current-label { background: white; border-radius: 12px; padding: 15px; margin-bottom: 20px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .current-label-title { font-size: 11px; color: #666; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .current-label-value { font-size: 16px; font-weight: 600; padding: 8px 16px; border-radius: 20px; display: inline-block; }
        .current-label-value.public { background: #d1fae5; color: #065f46; }
        .current-label-value.internal { background: #dbeafe; color: #1e40af; }
        .current-label-value.confidential { background: #fef3c7; color: #92400e; }
        .current-label-value.restricted { background: #fee2e2; color: #991b1b; }
        .section-title { font-size: 11px; color: #666; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .labels-grid { display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; }
        .label-btn { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border: 2px solid #e0e0e0; border-radius: 12px; background: white; cursor: pointer; transition: all 0.2s; }
        .label-btn:hover { border-color: #667eea; background: #f8f9ff; }
        .label-btn.active { border-color: #667eea; background: #eff1ff; }
        .label-btn .dot { width: 16px; height: 16px; border-radius: 50%; }
        .label-btn .dot.public { background: #10b981; }
        .label-btn .dot.internal { background: #3b82f6; }
        .label-btn .dot.confidential { background: #f59e0b; }
        .label-btn .dot.restricted { background: #ef4444; }
        .label-btn .info { flex: 1; text-align: left; }
        .label-btn .name { font-weight: 600; font-size: 14px; color: #333; }
        .label-btn .desc { font-size: 11px; color: #666; }
        .label-btn .check { width: 20px; height: 20px; border-radius: 50%; border: 2px solid #e0e0e0; display: flex; align-items: center; justify-content: center; font-size: 12px; color: white; }
        .label-btn.active .check { background: #667eea; border-color: #667eea; }
        .options { background: white; border-radius: 12px; padding: 15px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .options label { display: flex; align-items: center; gap: 10px; font-size: 13px; color: #333; margin-bottom: 8px; cursor: pointer; }
        .options label:last-child { margin-bottom: 0; }
        .options input[type="checkbox"] { width: 18px; height: 18px; accent-color: #667eea; }
        /* DRM Section */
        .drm-section { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-radius: 12px; padding: 15px; margin-bottom: 20px; }
        .drm-section .section-title { color: #a0aec0; }
        .drm-btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .drm-btn.protect { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .drm-btn.protect:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(102,126,234,0.4); }
        .drm-btn.revoke { background: #ef4444; color: white; margin-top: 10px; }
        .drm-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .drm-status { margin-top: 12px; padding: 10px; border-radius: 8px; font-size: 12px; display: none; }
        .drm-status.protected { display: block; background: rgba(16,185,129,0.2); color: #10b981; border: 1px solid #10b981; }
        .status { padding: 12px; border-radius: 8px; text-align: center; font-size: 13px; margin-bottom: 15px; display: none; }
        .status.success { display: block; background: #d1fae5; color: #065f46; }
        .status.error { display: block; background: #fee2e2; color: #991b1b; }
        .status.info { display: block; background: #dbeafe; color: #1e40af; }
        .footer { text-align: center; padding: 15px; font-size: 11px; color: #999; border-top: 1px solid #eee; background: white; }
        /* Modals */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal { background: white; border-radius: 16px; padding: 24px; max-width: 340px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-height: 85vh; overflow-y: auto; }
        .modal h3 { font-size: 16px; margin-bottom: 8px; color: #333; }
        .modal p { font-size: 13px; color: #666; margin-bottom: 16px; }
        .modal .warning { background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 12px; margin-bottom: 16px; font-size: 12px; color: #92400e; }
        .modal .options-list { margin-bottom: 16px; }
        .modal .options-list label { display: flex; align-items: flex-start; gap: 10px; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 8px; cursor: pointer; }
        .modal .options-list label:hover { background: #f8f9fa; }
        .modal textarea, .modal input[type="text"] { width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 13px; margin-bottom: 12px; }
        .modal textarea { resize: vertical; min-height: 60px; display: none; }
        .modal textarea.visible { display: block; }
        .modal .buttons { display: flex; gap: 10px; }
        .modal button { flex: 1; padding: 12px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .modal .btn-cancel { background: #e0e0e0; color: #333; }
        .modal .btn-confirm { background: #667eea; color: white; }
        .modal .form-group { margin-bottom: 12px; }
        .modal .form-group label { display: block; font-size: 12px; color: #666; margin-bottom: 4px; }
        .modal .checkbox-group { display: flex; gap: 15px; flex-wrap: wrap; }
        .modal .checkbox-group label { display: flex; align-items: center; gap: 6px; font-size: 13px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="lang-selector">
                <select id="langSelect" onchange="changeLanguage(this.value)">
                    <option value="en">EN</option>
                    <option value="fr">FR</option>
                    <option value="de">DE</option>
                    <option value="es">ES</option>
                    <option value="ar">AR</option>
                </select>
            </div>
            <h1>üõ°Ô∏è MazeShield</h1>
            <p id="headerSubtitle">Document Classification</p>
            <div class="user-info" id="userInfo">Loading...</div>
        </div>
        
        <div class="content">
            <div class="current-label">
                <div class="current-label-title" id="currentLabelTitle">Current Classification</div>
                <div class="current-label-value" id="currentLabel">Not classified</div>
            </div>
            
            <div class="section-title" id="chooseLabelTitle">Choose a label</div>
            <div class="labels-grid" id="labelsGrid"></div>
            
            <div class="options">
                <div class="section-title" id="optionsTitle">Options</div>
                <label><input type="checkbox" id="addHeader" checked> <span id="optHeader">Add header</span></label>
                <label><input type="checkbox" id="addFooter" checked> <span id="optFooter">Add footer</span></label>
                <label><input type="checkbox" id="addWatermark"> <span id="optWatermark">Add watermark</span></label>
            </div>
            
            <!-- DRM Section -->
            <div class="drm-section">
                <div class="section-title">üîê DRM Protection</div>
                <button class="drm-btn protect" id="btnProtectDRM" onclick="openDRMModal()">üîí Protect with DRM</button>
                <button class="drm-btn revoke" id="btnRevokeDRM" onclick="revokeAccess()" style="display:none;">üö´ Revoke Access</button>
                <div class="drm-status" id="drmStatus"></div>
            </div>
            
            <div class="status" id="status"></div>
        </div>
        
        <div class="footer">MazeShield v2.3 + DRM</div>
    </div>

    <!-- Modal Justification -->
    <div class="modal-overlay" id="justificationModal">
        <div class="modal">
            <h3 id="modalTitle">‚ö†Ô∏è Justification Required</h3>
            <p id="modalDesc">You are lowering the classification level. Please provide a justification:</p>
            <div class="warning"><strong id="modalFrom">From:</strong> <span id="fromLabel">-</span><br><strong id="modalTo">To:</strong> <span id="toLabel">-</span></div>
            <div class="options-list">
                <label><input type="radio" name="justification" value="manager_approved"> <span class="option-text" id="justOpt1">My manager approved this change</span></label>
                <label><input type="radio" name="justification" value="data_removed"> <span class="option-text" id="justOpt2">Sensitive data has been removed</span></label>
                <label><input type="radio" name="justification" value="classification_error"> <span class="option-text" id="justOpt3">Initial classification was incorrect</span></label>
                <label><input type="radio" name="justification" value="other"> <span class="option-text" id="justOpt4">Other reason</span></label>
            </div>
            <textarea id="otherReason" placeholder="Please specify..."></textarea>
            <div class="buttons">
                <button class="btn-cancel" onclick="closeModal()" id="btnCancel">Cancel</button>
                <button class="btn-confirm" onclick="confirmJustification()" id="btnConfirm">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Modal DRM -->
    <div class="modal-overlay" id="drmModal">
        <div class="modal">
            <h3>üîê DRM Protection Settings</h3>
            <p>Configure who can access this document:</p>
            <div class="form-group">
                <label>Allowed Domains (comma separated)</label>
                <input type="text" id="drmDomains" placeholder="e.g. kpmg.com, mazeloc.com">
            </div>
            <div class="form-group">
                <label>Allowed Emails (comma separated, optional)</label>
                <input type="text" id="drmEmails" placeholder="e.g. john@external.com">
            </div>
            <div class="form-group">
                <label>Rights</label>
                <div class="checkbox-group">
                    <label><input type="checkbox" id="rightView" checked> View</label>
                    <label><input type="checkbox" id="rightPrint"> Print</label>
                    <label><input type="checkbox" id="rightEdit"> Edit</label>
                    <label><input type="checkbox" id="rightCopy"> Copy</label>
                </div>
            </div>
            <div class="form-group">
                <label>Expiration Date (optional)</label>
                <input type="date" id="drmExpiry">
            </div>
            <div class="buttons">
                <button class="btn-cancel" onclick="closeDRMModal()">Cancel</button>
                <button class="btn-confirm" onclick="protectWithDRM()">üîí Protect</button>
            </div>
        </div>
    </div>

    <script>
        // ============== CONFIG ==============
        const AUDIT_URL = 'https://dlpo-audit-api-fddddvbncrbfc6b5.francecentral-01.azurewebsites.net/api/log-event';
        const DRM_API_BASE = 'https://fn-mazeshield-drm.azurewebsites.net/api';
        
        const LABELS = [
            { id: 'public', priority: 1, color: '#10b981' },
            { id: 'internal', priority: 2, color: '#3b82f6' },
            { id: 'confidential', priority: 3, color: '#f59e0b' },
            { id: 'restricted', priority: 4, color: '#ef4444' }
        ];

        const TRANSLATIONS = {
            en: {
                headerSubtitle: 'Document Classification', currentLabelTitle: 'Current Classification', notClassified: 'Not classified',
                chooseLabelTitle: 'Choose a label', optionsTitle: 'Options', optHeader: 'Add header', optFooter: 'Add footer', optWatermark: 'Add watermark',
                modalTitle: '‚ö†Ô∏è Justification Required', modalDesc: 'You are lowering the classification level. Please provide a justification:',
                modalFrom: 'From:', modalTo: 'To:', justOpt1: 'My manager approved this change', justOpt2: 'Sensitive data has been removed',
                justOpt3: 'Initial classification was incorrect', justOpt4: 'Other reason', btnCancel: 'Cancel', btnConfirm: 'Confirm', successApplied: 'Classification applied!',
                labels: { public: { name: 'Public', desc: 'Can be shared freely' }, internal: { name: 'Internal', desc: 'Internal use only' },
                    confidential: { name: 'Confidential', desc: 'Restricted access' }, restricted: { name: 'Restricted', desc: 'Highly sensitive' } }
            },
            fr: {
                headerSubtitle: 'Classification de documents', currentLabelTitle: 'Classification actuelle', notClassified: 'Non classifi√©',
                chooseLabelTitle: 'Choisir un label', optionsTitle: 'Options', optHeader: 'Ajouter en-t√™te', optFooter: 'Ajouter pied de page', optWatermark: 'Ajouter filigrane',
                modalTitle: '‚ö†Ô∏è Justification requise', modalDesc: 'Vous abaissez le niveau de classification. Veuillez justifier:',
                modalFrom: 'De:', modalTo: 'Vers:', justOpt1: 'Mon manager a approuv√©', justOpt2: 'Donn√©es sensibles supprim√©es',
                justOpt3: 'Classification initiale incorrecte', justOpt4: 'Autre raison', btnCancel: 'Annuler', btnConfirm: 'Confirmer', successApplied: 'Classification appliqu√©e!',
                labels: { public: { name: 'Public', desc: 'Partage libre' }, internal: { name: 'Interne', desc: 'Usage interne' },
                    confidential: { name: 'Confidentiel', desc: 'Acc√®s restreint' }, restricted: { name: 'Restreint', desc: 'Hautement sensible' } }
            },
            de: {
                headerSubtitle: 'Dokumentenklassifizierung', currentLabelTitle: 'Aktuelle Klassifizierung', notClassified: 'Nicht klassifiziert',
                chooseLabelTitle: 'Label w√§hlen', optionsTitle: 'Optionen', optHeader: 'Kopfzeile', optFooter: 'Fu√üzeile', optWatermark: 'Wasserzeichen',
                modalTitle: '‚ö†Ô∏è Begr√ºndung erforderlich', modalDesc: 'Sie senken die Klassifizierungsstufe.',
                modalFrom: 'Von:', modalTo: 'Nach:', justOpt1: 'Vorgesetzter hat genehmigt', justOpt2: 'Sensible Daten entfernt',
                justOpt3: 'Urspr√ºngliche Klassifizierung falsch', justOpt4: 'Anderer Grund', btnCancel: 'Abbrechen', btnConfirm: 'Best√§tigen', successApplied: 'Klassifizierung angewendet!',
                labels: { public: { name: '√ñffentlich', desc: 'Frei teilbar' }, internal: { name: 'Intern', desc: 'Nur intern' },
                    confidential: { name: 'Vertraulich', desc: 'Eingeschr√§nkt' }, restricted: { name: 'Streng vertraulich', desc: 'Hochsensibel' } }
            },
            es: {
                headerSubtitle: 'Clasificaci√≥n de documentos', currentLabelTitle: 'Clasificaci√≥n actual', notClassified: 'Sin clasificar',
                chooseLabelTitle: 'Elegir etiqueta', optionsTitle: 'Opciones', optHeader: 'A√±adir encabezado', optFooter: 'A√±adir pie', optWatermark: 'Marca de agua',
                modalTitle: '‚ö†Ô∏è Justificaci√≥n requerida', modalDesc: 'Est√° reduciendo el nivel.',
                modalFrom: 'De:', modalTo: 'A:', justOpt1: 'Mi gerente aprob√≥', justOpt2: 'Datos sensibles eliminados',
                justOpt3: 'Clasificaci√≥n inicial incorrecta', justOpt4: 'Otra raz√≥n', btnCancel: 'Cancelar', btnConfirm: 'Confirmar', successApplied: '¬°Clasificaci√≥n aplicada!',
                labels: { public: { name: 'P√∫blico', desc: 'Compartir libre' }, internal: { name: 'Interno', desc: 'Solo interno' },
                    confidential: { name: 'Confidencial', desc: 'Acceso restringido' }, restricted: { name: 'Restringido', desc: 'Altamente sensible' } }
            },
            ar: {
                headerSubtitle: 'ÿ™ÿµŸÜŸäŸÅ ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØÿßÿ™', currentLabelTitle: 'ÿßŸÑÿ™ÿµŸÜŸäŸÅ ÿßŸÑÿ≠ÿßŸÑŸä', notClassified: 'ÿ∫Ÿäÿ± ŸÖÿµŸÜŸÅ',
                chooseLabelTitle: 'ÿßÿÆÿ™ÿ± ÿ™ÿµŸÜŸäŸÅ', optionsTitle: 'ÿÆŸäÿßÿ±ÿßÿ™', optHeader: 'ÿ•ÿ∂ÿßŸÅÿ© ÿ±ÿ£ÿ≥', optFooter: 'ÿ•ÿ∂ÿßŸÅÿ© ÿ™ÿ∞ŸäŸäŸÑ', optWatermark: 'ÿπŸÑÿßŸÖÿ© ŸÖÿßÿ¶Ÿäÿ©',
                modalTitle: '‚ö†Ô∏è ŸÖÿ∑ŸÑŸàÿ® ÿ™ÿ®ÿ±Ÿäÿ±', modalDesc: 'ÿ£ŸÜÿ™ ÿ™ÿÆŸÅÿ∂ ŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿ™ÿµŸÜŸäŸÅ.',
                modalFrom: 'ŸÖŸÜ:', modalTo: 'ÿ•ŸÑŸâ:', justOpt1: 'ŸàÿßŸÅŸÇ ŸÖÿØŸäÿ±Ÿä', justOpt2: 'ÿ™ŸÖÿ™ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™',
                justOpt3: 'ÿßŸÑÿ™ÿµŸÜŸäŸÅ ÿßŸÑÿ£ŸàŸÑŸä ÿÆÿßÿ∑ÿ¶', justOpt4: 'ÿ≥ÿ®ÿ® ÿ¢ÿÆÿ±', btnCancel: 'ÿ•ŸÑÿ∫ÿßÿ°', btnConfirm: 'ÿ™ÿ£ŸÉŸäÿØ', successApplied: 'ÿ™ŸÖ ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ™ÿµŸÜŸäŸÅ!',
                labels: { public: { name: 'ÿπÿßŸÖ', desc: 'ŸÖÿ¥ÿßÿ±ŸÉÿ© ÿ≠ÿ±ÿ©' }, internal: { name: 'ÿØÿßÿÆŸÑŸä', desc: 'ÿØÿßÿÆŸÑŸä ŸÅŸÇÿ∑' },
                    confidential: { name: 'ÿ≥ÿ±Ÿä', desc: 'ŸàÿµŸàŸÑ ŸÖŸÇŸäÿØ' }, restricted: { name: 'ŸÖŸÇŸäÿØ', desc: 'ÿ≠ÿ≥ÿßÿ≥ ŸÑŸÑÿ∫ÿßŸäÿ©' } }
            }
        };

        // ============== STATE ==============
        let currentLang = 'en', currentUserEmail = 'unknown', currentLabelId = null, currentLabelPriority = 0, pendingLabel = null;
        let currentDocId = null;

        // ============== INIT ==============
        Office.onReady(async (info) => {
            console.log('Office.js ready:', info.host);
            await initUser();
            applyTranslations();
            renderLabels();
            await loadCurrentLabel();
            await checkDRMStatus();
            document.querySelectorAll('input[name="justification"]').forEach(r => {
                r.addEventListener('change', () => {
                    document.getElementById('otherReason').classList.toggle('visible', r.value === 'other' && r.checked);
                });
            });
        });

        // ============== USER ==============
        async function initUser() {
            try {
                const token = await OfficeRuntime.auth.getAccessToken({ allowSignInPrompt: true });
                const payload = JSON.parse(atob(token.split('.')[1]));
                currentUserEmail = payload.preferred_username || payload.upn || payload.email || 'unknown';
            } catch (e) {
                console.log('SSO failed, fallback');
                const docUrl = Office.context.document?.url || '';
                if (docUrl.includes('/personal/')) {
                    const match = docUrl.match(/\/personal\/([^\/]+)/);
                    if (match) currentUserEmail = match[1].replace(/_/g, '.').replace(/\.onmicrosoft\./, '@onmicrosoft.');
                }
            }
            document.getElementById('userInfo').textContent = 'üë§ ' + currentUserEmail;
        }

        // ============== LANGUAGE ==============
        function changeLanguage(lang) { currentLang = lang; applyTranslations(); renderLabels(); updateCurrentLabelDisplay(); }
        function applyTranslations() {
            const t = TRANSLATIONS[currentLang];
            document.getElementById('headerSubtitle').textContent = t.headerSubtitle;
            document.getElementById('currentLabelTitle').textContent = t.currentLabelTitle;
            document.getElementById('chooseLabelTitle').textContent = t.chooseLabelTitle;
            document.getElementById('optionsTitle').textContent = t.optionsTitle;
            document.getElementById('optHeader').textContent = t.optHeader;
            document.getElementById('optFooter').textContent = t.optFooter;
            document.getElementById('optWatermark').textContent = t.optWatermark;
            document.getElementById('modalTitle').textContent = t.modalTitle;
            document.getElementById('modalDesc').textContent = t.modalDesc;
            document.getElementById('modalFrom').textContent = t.modalFrom;
            document.getElementById('modalTo').textContent = t.modalTo;
            document.getElementById('justOpt1').textContent = t.justOpt1;
            document.getElementById('justOpt2').textContent = t.justOpt2;
            document.getElementById('justOpt3').textContent = t.justOpt3;
            document.getElementById('justOpt4').textContent = t.justOpt4;
            document.getElementById('btnCancel').textContent = t.btnCancel;
            document.getElementById('btnConfirm').textContent = t.btnConfirm;
        }

        // ============== RENDER LABELS ==============
        function renderLabels() {
            const t = TRANSLATIONS[currentLang];
            document.getElementById('labelsGrid').innerHTML = LABELS.map(l => `
                <div class="label-btn ${currentLabelId === l.id ? 'active' : ''}" onclick="selectLabel('${l.id}')">
                    <div class="dot ${l.id}"></div>
                    <div class="info"><div class="name">${t.labels[l.id].name}</div><div class="desc">${t.labels[l.id].desc}</div></div>
                    <div class="check">${currentLabelId === l.id ? '‚úì' : ''}</div>
                </div>`).join('');
        }
        function updateCurrentLabelDisplay() {
            const t = TRANSLATIONS[currentLang], el = document.getElementById('currentLabel');
            if (currentLabelId) { el.textContent = t.labels[currentLabelId].name; el.className = 'current-label-value ' + currentLabelId; }
            else { el.textContent = t.notClassified; el.className = 'current-label-value'; }
        }

        // ============== SELECT LABEL ==============
        function selectLabel(labelId) {
            const label = LABELS.find(l => l.id === labelId);
            if (currentLabelPriority > 0 && label.priority < currentLabelPriority) {
                pendingLabel = label;
                const t = TRANSLATIONS[currentLang];
                document.getElementById('fromLabel').textContent = t.labels[currentLabelId].name;
                document.getElementById('toLabel').textContent = t.labels[labelId].name;
                document.getElementById('justificationModal').classList.add('active');
                document.querySelectorAll('input[name="justification"]').forEach(r => r.checked = false);
                document.getElementById('otherReason').value = '';
                document.getElementById('otherReason').classList.remove('visible');
                return;
            }
            applyLabel(label, null);
        }
        function closeModal() { document.getElementById('justificationModal').classList.remove('active'); pendingLabel = null; }
        function confirmJustification() {
            const selected = document.querySelector('input[name="justification"]:checked');
            if (!selected) { alert('Please select a justification'); return; }
            if (!pendingLabel) { closeModal(); return; }
            const t = TRANSLATIONS[currentLang];
            let txt = '';
            switch(selected.value) {
                case 'manager_approved': txt = t.justOpt1; break;
                case 'data_removed': txt = t.justOpt2; break;
                case 'classification_error': txt = t.justOpt3; break;
                case 'other': txt = document.getElementById('otherReason').value || 'Other'; break;
            }
            const just = { code: selected.value, text: txt, from: currentLabelId, to: pendingLabel.id, timestamp: new Date().toISOString() };
            const labelToApply = pendingLabel;
            closeModal();
            applyLabel(labelToApply, just);
        }

        // ============== APPLY LABEL ==============
        async function applyLabel(label, justification) {
            try {
                showStatus('info', 'Applying...');
                const host = Office.context.host, t = TRANSLATIONS[currentLang], labelName = t.labels[label.id].name.toUpperCase();
                if (host === Office.HostType.Word) await applyToWord(label, labelName, justification);
                else if (host === Office.HostType.Excel) await applyToExcel(label, labelName, justification);
                else if (host === Office.HostType.PowerPoint) await applyToPowerPoint(label, labelName, justification);
                currentLabelId = label.id; currentLabelPriority = label.priority;
                renderLabels(); updateCurrentLabelDisplay();
                await sendAuditLog(label, justification);
                showStatus('success', t.successApplied);
                setTimeout(hideStatus, 3000);
            } catch (error) { console.error('Error:', error); showStatus('error', 'Error: ' + error.message); }
        }

        // ============== WORD/EXCEL/PPT ==============
        async function applyToWord(label, labelName, justification) {
            await Word.run(async (ctx) => {
                const props = ctx.document.properties.customProperties; props.load('items'); await ctx.sync();
                for (let item of props.items) { if (item.key.startsWith('_DLPO_')) item.delete(); } await ctx.sync();
                props.add('_DLPO_Classification', label.id);
                props.add('_DLPO_ClassifiedAt', new Date().toISOString());
                props.add('_DLPO_ClassifiedBy', currentUserEmail);
                if (justification) { props.add('_DLPO_DowngradedFrom', justification.from); props.add('_DLPO_DowngradeJustification', justification.code); }
                if (document.getElementById('addHeader').checked) {
                    const header = ctx.document.sections.getFirst().getHeader('Primary'); header.clear();
                    const p = header.insertParagraph(`[${labelName}]`, 'Start'); p.font.bold = true; p.font.color = label.color; p.alignment = 'Centered';
                }
                if (document.getElementById('addFooter').checked) {
                    const footer = ctx.document.sections.getFirst().getFooter('Primary'); footer.clear();
                    const p = footer.insertParagraph(`Classification: ${labelName}`, 'Start'); p.font.size = 10; p.font.color = '#666666'; p.alignment = 'Centered';
                }
                await ctx.sync();
            });
        }
        async function applyToExcel(label, labelName, justification) {
            await Excel.run(async (ctx) => {
                const props = ctx.workbook.properties.custom;
                props.add('_DLPO_Classification', label.id); props.add('_DLPO_ClassifiedAt', new Date().toISOString()); props.add('_DLPO_ClassifiedBy', currentUserEmail);
                if (justification) { props.add('_DLPO_DowngradedFrom', justification.from); props.add('_DLPO_DowngradeJustification', justification.code); }
                await ctx.sync();
            });
        }
        async function applyToPowerPoint(label, labelName, justification) {
            await PowerPoint.run(async (ctx) => {
                const tags = ctx.presentation.tags;
                tags.add('_DLPO_Classification', label.id); tags.add('_DLPO_ClassifiedAt', new Date().toISOString()); tags.add('_DLPO_ClassifiedBy', currentUserEmail);
                if (justification) { tags.add('_DLPO_DowngradedFrom', justification.from); tags.add('_DLPO_DowngradeJustification', justification.code); }
                await ctx.sync();
            });
        }

        // ============== LOAD CURRENT LABEL ==============
        async function loadCurrentLabel() {
            try {
                const host = Office.context.host; let labelId = null;
                if (host === Office.HostType.Word) {
                    await Word.run(async (ctx) => {
                        const props = ctx.document.properties.customProperties; props.load('items'); await ctx.sync();
                        for (let item of props.items) { if (item.key === '_DLPO_Classification') { labelId = item.value; break; } }
                    });
                }
                if (labelId) { currentLabelId = labelId; const obj = LABELS.find(l => l.id === labelId); if (obj) currentLabelPriority = obj.priority; renderLabels(); updateCurrentLabelDisplay(); }
            } catch (e) { console.log('Error loading label:', e); }
        }

        // ============== AUDIT LOG ==============
        async function sendAuditLog(label, justification) {
            try {
                const payload = { tenantId: 'mazeloc', action: justification ? 'LABEL_DOWNGRADE' : 'LABEL_APPLIED', label: label.id,
                    previousLabel: justification ? justification.from : null, user: currentUserEmail,
                    document: { name: Office.context.document?.url || 'unknown', app: Office.context.host },
                    justification: justification ? { code: justification.code, text: justification.text, from: justification.from, to: justification.to } : null,
                    timestamp: new Date().toISOString() };
                console.log('üì§ Audit:', payload);
                const r = await fetch(AUDIT_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                console.log('üì• Audit response:', await r.json());
            } catch (e) { console.error('‚ùå Audit failed:', e); }
        }

        // ============== DRM FUNCTIONS ==============
        function openDRMModal() {
            if (!currentLabelId) { alert('Please classify the document first!'); return; }
            document.getElementById('drmDomains').value = 'mazeloc.onmicrosoft.com';
            document.getElementById('drmEmails').value = '';
            document.getElementById('drmExpiry').value = '';
            document.getElementById('rightView').checked = true;
            document.getElementById('rightPrint').checked = false;
            document.getElementById('rightEdit').checked = false;
            document.getElementById('rightCopy').checked = false;
            document.getElementById('drmModal').classList.add('active');
        }
        function closeDRMModal() { document.getElementById('drmModal').classList.remove('active'); }

        async function protectWithDRM() {
            try {
                showStatus('info', 'üîê Step 1/4: Reading document...');
                const domains = document.getElementById('drmDomains').value.split(',').map(d => d.trim()).filter(d => d);
                const emails = document.getElementById('drmEmails').value.split(',').map(e => e.trim()).filter(e => e);
                const rights = [];
                if (document.getElementById('rightView').checked) rights.push('VIEW');
                if (document.getElementById('rightPrint').checked) rights.push('PRINT');
                if (document.getElementById('rightEdit').checked) rights.push('EDIT');
                if (document.getElementById('rightCopy').checked) rights.push('COPY');
                const expiry = document.getElementById('drmExpiry').value || null;
                const docName = Office.context.document?.url?.split('/').pop() || 'document.docx';
                
                // === STEP 1: Read document content (OOXML) ===
                let originalOoxml = '';
                await Word.run(async (ctx) => {
                    const body = ctx.document.body;
                    originalOoxml = body.getOoxml();
                    await ctx.sync();
                    originalOoxml = originalOoxml.value;
                });
                console.log('üìÑ Original content size:', originalOoxml.length);
                
                // === STEP 2: Encrypt content with AES-256-GCM ===
                showStatus('info', 'üîê Step 2/4: Encrypting content...');
                const dekArray = new Uint8Array(32);
                window.crypto.getRandomValues(dekArray);
                const dekBase64 = btoa(String.fromCharCode(...dekArray));
                
                const ivArray = new Uint8Array(12);
                window.crypto.getRandomValues(ivArray);
                const ivBase64 = btoa(String.fromCharCode(...ivArray));
                
                // Import DEK as CryptoKey
                const cryptoKey = await window.crypto.subtle.importKey(
                    'raw', dekArray, { name: 'AES-GCM' }, false, ['encrypt']
                );
                
                // Encrypt the OOXML content
                const encoder = new TextEncoder();
                const contentBytes = encoder.encode(originalOoxml);
                const encryptedBuffer = await window.crypto.subtle.encrypt(
                    { name: 'AES-GCM', iv: ivArray }, cryptoKey, contentBytes
                );
                const encryptedBase64 = btoa(String.fromCharCode(...new Uint8Array(encryptedBuffer)));
                console.log('üîí Encrypted size:', encryptedBase64.length);
                
                // === STEP 3: Register with DRM server ===
                showStatus('info', 'üîê Step 3/4: Registering protection...');
                const response = await fetch(`${DRM_API_BASE}/keys/protect`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        dek: dekBase64, iv: ivBase64, tenantId: 'mazeloc',
                        documentName: docName, classification: currentLabelId.toUpperCase(),
                        userEmail: currentUserEmail,
                        policy: { allowedDomains: domains, allowedEmails: emails, rights: rights, expiry: expiry }
                    })
                });
                
                if (!response.ok) { const err = await response.json(); throw new Error(err.error || 'Protection failed'); }
                const result = await response.json();
                currentDocId = result.docId;
                
                // === STEP 4: Replace document content + store encrypted data ===
                showStatus('info', 'üîê Step 4/4: Securing document...');
                await Word.run(async (ctx) => {
                    const body = ctx.document.body;
                    const props = ctx.document.properties.customProperties;
                    
                    // Clear current content and add protection notice
                    body.clear();
                    
                    // Add protection banner
                    const title = body.insertParagraph('üîí PROTECTED BY MAZESHIELD', 'Start');
                    title.font.size = 20;
                    title.font.bold = true;
                    title.font.color = '#667eea';
                    title.alignment = 'Centered';
                    
                    body.insertParagraph('', 'End');
                    
                    const info = body.insertParagraph('This document is protected with MazeShield DRM.', 'End');
                    info.font.size = 12;
                    info.font.color = '#666666';
                    info.alignment = 'Centered';
                    
                    const info2 = body.insertParagraph('Only authorized users can view its contents.', 'End');
                    info2.font.size = 12;
                    info2.font.color = '#666666';
                    info2.alignment = 'Centered';
                    
                    body.insertParagraph('', 'End');
                    
                    const docIdPara = body.insertParagraph('Document ID: ' + currentDocId, 'End');
                    docIdPara.font.size = 9;
                    docIdPara.font.color = '#999999';
                    docIdPara.alignment = 'Centered';
                    
                    const classPara = body.insertParagraph('Classification: ' + currentLabelId.toUpperCase(), 'End');
                    classPara.font.size = 9;
                    classPara.font.color = '#999999';
                    classPara.alignment = 'Centered';
                    
                    body.insertParagraph('', 'End');
                    
                    const linkPara = body.insertParagraph('If you do not have the MazeShield add-in, contact the sender for access.', 'End');
                    linkPara.font.size = 10;
                    linkPara.font.color = '#667eea';
                    linkPara.alignment = 'Centered';
                    
                    // Store DRM metadata in custom properties
                    props.add('_DLPO_DRM_DocId', currentDocId);
                    props.add('_DLPO_DRM_Protected', 'true');
                    props.add('_DLPO_DRM_ProtectedAt', new Date().toISOString());
                    props.add('_DLPO_DRM_ProtectedBy', currentUserEmail);
                    
                    await ctx.sync();
                });
                
                // Store encrypted content in Custom XML Part
                await storeEncryptedContent(encryptedBase64);
                
                closeDRMModal();
                document.getElementById('drmStatus').className = 'drm-status protected';
                document.getElementById('drmStatus').innerHTML = `‚úÖ Protected & Encrypted<br><small>DocID: ${currentDocId}</small>`;
                document.getElementById('btnRevokeDRM').style.display = 'block';
                showStatus('success', 'üîê Document encrypted and protected!');
                setTimeout(hideStatus, 5000);
            } catch (error) {
                console.error('DRM Error:', error);
                showStatus('error', 'DRM Error: ' + error.message);
            }
        }
        
        // Store encrypted content as Custom XML Part (like MIP does)
        async function storeEncryptedContent(encryptedBase64) {
            // Split into chunks of 30KB (custom XML can hold much more than properties)
            const CHUNK_SIZE = 30000;
            const chunks = [];
            for (let i = 0; i < encryptedBase64.length; i += CHUNK_SIZE) {
                chunks.push(encryptedBase64.substring(i, i + CHUNK_SIZE));
            }
            
            const xmlContent = `<?xml version="1.0" encoding="UTF-8"?>
<MazeShieldDRM xmlns="http://mazeshield.com/drm/v1">
    <DocId>${currentDocId}</DocId>
    <Algorithm>AES-256-GCM</Algorithm>
    <ChunkCount>${chunks.length}</ChunkCount>
    ${chunks.map((chunk, i) => `<Chunk index="${i}">${chunk}</Chunk>`).join('\n    ')}
</MazeShieldDRM>`;
            
            await Word.run(async (ctx) => {
                const xmlParts = ctx.document.customXmlParts;
                xmlParts.add(xmlContent);
                await ctx.sync();
                console.log('üíæ Encrypted content stored in Custom XML Part (' + chunks.length + ' chunks)');
            });
        }
        
        // Read encrypted content from Custom XML Part
        async function readEncryptedContent() {
            return new Promise(async (resolve, reject) => {
                try {
                    await Word.run(async (ctx) => {
                        const xmlParts = ctx.document.customXmlParts;
                        const parts = xmlParts.getByNamespace('http://mazeshield.com/drm/v1');
                        parts.load('items');
                        await ctx.sync();
                        
                        if (parts.items.length === 0) { resolve(null); return; }
                        
                        const part = parts.items[0];
                        const xml = part.getXml();
                        await ctx.sync();
                        
                        // Parse XML to extract chunks
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(xml.value, 'text/xml');
                        const chunkNodes = doc.getElementsByTagName('Chunk');
                        
                        let encrypted = '';
                        for (let i = 0; i < chunkNodes.length; i++) {
                            encrypted += chunkNodes[i].textContent;
                        }
                        
                        resolve(encrypted);
                    });
                } catch (e) { reject(e); }
            });
        }

        async function revokeAccess() {
            if (!currentDocId) { alert('No DRM protection found'); return; }
            if (!confirm('Are you sure you want to revoke all access to this document?')) return;
            try {
                showStatus('info', 'üö´ Revoking access...');
                const response = await fetch(`${DRM_API_BASE}/keys/revoke`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ docId: currentDocId, tenantId: 'mazeloc', userEmail: currentUserEmail })
                });
                if (!response.ok) { const err = await response.json(); throw new Error(err.error || 'Revocation failed'); }
                document.getElementById('drmStatus').className = 'drm-status';
                document.getElementById('drmStatus').innerHTML = '';
                document.getElementById('btnRevokeDRM').style.display = 'none';
                currentDocId = null;
                showStatus('success', 'üö´ Access revoked!');
                setTimeout(hideStatus, 3000);
            } catch (error) { console.error('Revoke Error:', error); showStatus('error', 'Error: ' + error.message); }
        }

        async function checkDRMStatus() {
            try {
                if (Office.context.host === Office.HostType.Word) {
                    await Word.run(async (ctx) => {
                        const props = ctx.document.properties.customProperties; props.load('items'); await ctx.sync();
                        for (let item of props.items) {
                            if (item.key === '_DLPO_DRM_DocId') {
                                currentDocId = item.value;
                                document.getElementById('drmStatus').className = 'drm-status protected';
                                document.getElementById('drmStatus').innerHTML = `‚úÖ Protected<br><small>DocID: ${currentDocId}</small>`;
                                document.getElementById('btnRevokeDRM').style.display = 'block';
                                break;
                            }
                        }
                    });
                }
            } catch (e) { console.log('DRM status check error:', e); }
        }

        // ============== STATUS ==============
        function showStatus(type, msg) { const el = document.getElementById('status'); el.className = 'status ' + type; el.textContent = msg; }
        function hideStatus() { document.getElementById('status').className = 'status'; }
    </script>
</body>
</html>
