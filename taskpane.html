<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DLPO Classification</title>
    <script src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
            max-width: 350px;
            margin: 0 auto;
        }
        .header {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h1 { font-size: 18px; margin-bottom: 5px; }
        .header p { font-size: 12px; opacity: 0.8; }
        .content { padding: 20px; }
        
        .current-label {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        .current-label-title { font-size: 11px; color: #666; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .current-label-value {
            font-size: 16px;
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
        }
        
        .section-title { font-size: 11px; color: #666; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
        
        .labels-grid { display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; }
        .label-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .label-btn:hover { border-color: #667eea; transform: translateX(5px); }
        .label-btn.active { border-color: #667eea; background: #f0f4ff; }
        .label-dot { width: 12px; height: 12px; border-radius: 50%; }
        .label-btn span { flex: 1; font-weight: 500; }
        .label-btn .check { display: none; color: #667eea; font-weight: bold; }
        .label-btn.active .check { display: block; }
        
        .public .label-dot, .public { --color: #10B981; }
        .internal .label-dot, .internal { --color: #3B82F6; }
        .confidential .label-dot, .confidential { --color: #F59E0B; }
        .restricted .label-dot, .restricted { --color: #EF4444; }
        .label-dot { background: var(--color); }
        .current-label-value.public { background: #D1FAE5; color: #065F46; }
        .current-label-value.internal { background: #DBEAFE; color: #1E40AF; }
        .current-label-value.confidential { background: #FEF3C7; color: #92400E; }
        .current-label-value.restricted { background: #FEE2E2; color: #991B1B; }
        
        .options { margin-bottom: 20px; }
        .option-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .option-item:last-child { border-bottom: none; }
        .option-item input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .option-item label { flex: 1; font-size: 14px; cursor: pointer; }
        
        .apply-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .apply-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4); }
        .apply-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        
        .status {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-size: 13px;
            display: none;
        }
        .status.success { display: block; background: #D1FAE5; color: #065F46; }
        .status.error { display: block; background: #FEE2E2; color: #991B1B; }
        .status.warning { display: block; background: #FEF3C7; color: #92400E; }
        
        .footer {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            font-size: 11px;
            color: #999;
        }
        
        /* Modal Justification */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-overlay.show { display: flex; }
        .modal {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 340px;
            overflow: hidden;
            animation: modalIn 0.3s ease;
        }
        @keyframes modalIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .modal-header {
            background: #FEF3C7;
            padding: 20px;
            text-align: center;
        }
        .modal-header .icon { font-size: 32px; margin-bottom: 10px; }
        .modal-header h2 { font-size: 16px; color: #92400E; }
        .modal-body { padding: 20px; }
        .downgrade-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .downgrade-info .arrow { color: #666; }
        .justification-options { display: flex; flex-direction: column; gap: 8px; }
        .justification-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .justification-option:hover { border-color: #F59E0B; }
        .justification-option.selected { border-color: #F59E0B; background: #FEF3C7; }
        .justification-option input { display: none; }
        .justification-option .radio {
            width: 18px;
            height: 18px;
            border: 2px solid #ccc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .justification-option.selected .radio { border-color: #F59E0B; }
        .justification-option.selected .radio::after {
            content: '';
            width: 10px;
            height: 10px;
            background: #F59E0B;
            border-radius: 50%;
        }
        .other-reason {
            display: none;
            margin-top: 10px;
        }
        .other-reason.show { display: block; }
        .other-reason textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            resize: none;
            font-family: inherit;
        }
        .modal-footer {
            display: flex;
            gap: 10px;
            padding: 20px;
            border-top: 1px solid #eee;
        }
        .modal-btn {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .modal-btn.cancel { background: #f0f0f0; border: none; color: #666; }
        .modal-btn.cancel:hover { background: #e0e0e0; }
        .modal-btn.confirm { background: #F59E0B; border: none; color: white; }
        .modal-btn.confirm:hover { background: #D97706; }
        .modal-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè∑Ô∏è Classification</h1>
            <p>S√©lectionnez le niveau de sensibilit√©</p>
        </div>
        
        <div class="content">
            <div class="current-label">
                <div class="current-label-title">Label actuel</div>
                <div class="current-label-value" id="currentLabel">Chargement...</div>
            </div>
            
            <div class="section-title">Choisir un label</div>
            <div class="labels-grid">
                <button class="label-btn public" data-label="Public" data-priority="1">
                    <div class="label-dot"></div>
                    <span>Public</span>
                    <div class="check">‚úì</div>
                </button>
                <button class="label-btn internal" data-label="Internal" data-priority="2">
                    <div class="label-dot"></div>
                    <span>Internal</span>
                    <div class="check">‚úì</div>
                </button>
                <button class="label-btn confidential" data-label="Confidential" data-priority="3">
                    <div class="label-dot"></div>
                    <span>Confidential</span>
                    <div class="check">‚úì</div>
                </button>
                <button class="label-btn restricted" data-label="Restricted" data-priority="4">
                    <div class="label-dot"></div>
                    <span>Restricted</span>
                    <div class="check">‚úì</div>
                </button>
            </div>
            
            <div class="options">
                <div class="section-title">Options de marquage</div>
                <div class="option-item">
                    <input type="checkbox" id="optHeader">
                    <label for="optHeader">Ajouter dans l'en-t√™te</label>
                </div>
                <div class="option-item">
                    <input type="checkbox" id="optFooter" checked>
                    <label for="optFooter">Ajouter dans le pied de page</label>
                </div>
                <div class="option-item">
                    <input type="checkbox" id="optWatermark">
                    <label for="optWatermark">Ajouter un filigrane</label>
                </div>
            </div>
            
            <button class="apply-btn" id="applyBtn" disabled>Appliquer le label</button>
            
            <div class="status" id="status"></div>
        </div>
        
        <div class="footer">DLPO Classification v1.6</div>
    </div>
    
    <!-- Modal Justification -->
    <div class="modal-overlay" id="justificationModal">
        <div class="modal">
            <div class="modal-header">
                <div class="icon">‚ö†Ô∏è</div>
                <h2>Justification requise</h2>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px; font-size: 13px; color: #666;">Vous abaissez le niveau de classification :</p>
                <div class="downgrade-info">
                    <span id="fromLabel" class="current-label-value restricted">Restricted</span>
                    <span class="arrow">‚Üí</span>
                    <span id="toLabel" class="current-label-value public">Public</span>
                </div>
                <p style="margin-bottom: 10px; font-size: 13px; color: #666;">Veuillez indiquer la raison :</p>
                <div class="justification-options">
                    <label class="justification-option" data-value="manager_approved">
                        <input type="radio" name="justification">
                        <div class="radio"></div>
                        <span>Approuv√© par mon manager</span>
                    </label>
                    <label class="justification-option" data-value="data_removed">
                        <input type="radio" name="justification">
                        <div class="radio"></div>
                        <span>Donn√©es sensibles retir√©es</span>
                    </label>
                    <label class="justification-option" data-value="classification_error">
                        <input type="radio" name="justification">
                        <div class="radio"></div>
                        <span>Erreur de classification initiale</span>
                    </label>
                    <label class="justification-option" data-value="other">
                        <input type="radio" name="justification">
                        <div class="radio"></div>
                        <span>Autre raison</span>
                    </label>
                </div>
                <div class="other-reason" id="otherReason">
                    <textarea id="otherReasonText" rows="3" placeholder="Pr√©cisez la raison..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" id="cancelJustification">Annuler</button>
                <button class="modal-btn confirm" id="confirmJustification" disabled>Confirmer</button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let selectedLabel = null;
        let currentLabelValue = null;
        let currentLabelPriority = 0;
        let pendingDowngrade = null;
        
        const labelPriorities = {
            'Public': 1,
            'Internal': 2,
            'Confidential': 3,
            'Restricted': 4
        };
        
        const labelColors = {
            'Public': 'public',
            'Internal': 'internal',
            'Confidential': 'confidential',
            'Restricted': 'restricted'
        };

        // Initialisation Office
        Office.onReady((info) => {
            console.log('Office.onReady - Host:', info.host);
            
            // Event listeners pour les boutons de label
            document.querySelectorAll('.label-btn').forEach(btn => {
                btn.addEventListener('click', () => selectLabel(btn));
            });
            
            // Event listener pour le bouton Appliquer
            document.getElementById('applyBtn').addEventListener('click', handleApplyClick);
            
            // Event listeners pour la modal de justification
            document.querySelectorAll('.justification-option').forEach(opt => {
                opt.addEventListener('click', () => selectJustification(opt));
            });
            document.getElementById('cancelJustification').addEventListener('click', closeJustificationModal);
            document.getElementById('confirmJustification').addEventListener('click', confirmJustification);
            
            // Charger le label actuel
            loadCurrentLabel();
        });

        function selectLabel(btn) {
            document.querySelectorAll('.label-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedLabel = btn.dataset.label;
            document.getElementById('applyBtn').disabled = false;
            hideStatus();
        }

        function handleApplyClick() {
            if (!selectedLabel) return;
            
            const newPriority = labelPriorities[selectedLabel];
            
            // V√©rifier si c'est un downgrade
            if (currentLabelPriority > 0 && newPriority < currentLabelPriority) {
                // C'est un downgrade - demander justification
                showJustificationModal(currentLabelValue, selectedLabel);
            } else {
                // Pas un downgrade - appliquer directement
                applyLabel(selectedLabel, null);
            }
        }

        function showJustificationModal(fromLabel, toLabel) {
            pendingDowngrade = { from: fromLabel, to: toLabel };
            
            // Mettre √† jour l'affichage de la modal
            const fromEl = document.getElementById('fromLabel');
            const toEl = document.getElementById('toLabel');
            
            fromEl.textContent = fromLabel;
            fromEl.className = 'current-label-value ' + labelColors[fromLabel];
            
            toEl.textContent = toLabel;
            toEl.className = 'current-label-value ' + labelColors[toLabel];
            
            // Reset des s√©lections
            document.querySelectorAll('.justification-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.getElementById('otherReason').classList.remove('show');
            document.getElementById('otherReasonText').value = '';
            document.getElementById('confirmJustification').disabled = true;
            
            // Afficher la modal
            document.getElementById('justificationModal').classList.add('show');
        }

        function closeJustificationModal() {
            document.getElementById('justificationModal').classList.remove('show');
            pendingDowngrade = null;
        }

        function selectJustification(opt) {
            document.querySelectorAll('.justification-option').forEach(o => o.classList.remove('selected'));
            opt.classList.add('selected');
            
            const value = opt.dataset.value;
            if (value === 'other') {
                document.getElementById('otherReason').classList.add('show');
            } else {
                document.getElementById('otherReason').classList.remove('show');
            }
            
            document.getElementById('confirmJustification').disabled = false;
        }

        function confirmJustification() {
            const selectedOption = document.querySelector('.justification-option.selected');
            if (!selectedOption || !pendingDowngrade) return;
            
            const justificationCode = selectedOption.dataset.value;
            let justificationText = selectedOption.querySelector('span').textContent;
            
            if (justificationCode === 'other') {
                const otherText = document.getElementById('otherReasonText').value.trim();
                if (!otherText) {
                    alert('Veuillez pr√©ciser la raison');
                    return;
                }
                justificationText = otherText;
            }
            
            const justification = {
                code: justificationCode,
                text: justificationText,
                from: pendingDowngrade.from,
                to: pendingDowngrade.to,
                timestamp: new Date().toISOString()
            };
            
            // Fermer la modal
            closeJustificationModal();
            
            // ‚≠ê APPLIQUER LE LABEL AVEC LA JUSTIFICATION
            applyLabel(selectedLabel, justification);
        }

        async function applyLabel(label, justification) {
            const applyBtn = document.getElementById('applyBtn');
            applyBtn.disabled = true;
            applyBtn.textContent = 'Application en cours...';
            
            try {
                const host = Office.context.host;
                
                if (host === Office.HostType.Word) {
                    await applyLabelWord(label, justification);
                } else if (host === Office.HostType.Excel) {
                    await applyLabelExcel(label, justification);
                } else if (host === Office.HostType.PowerPoint) {
                    await applyLabelPowerPoint(label, justification);
                }
                
                // Mettre √† jour l'affichage
                updateCurrentLabelDisplay(label);
                
                // Message de succ√®s
                const isDowngrade = justification !== null;
                showStatus('success', `‚úì Label "${label}" appliqu√© avec succ√®s !` + (isDowngrade ? ' (downgrade justifi√©)' : ''));
                
            } catch (error) {
                console.error('Erreur:', error);
                showStatus('error', '‚úó Erreur: ' + error.message);
            } finally {
                applyBtn.disabled = false;
                applyBtn.textContent = 'Appliquer le label';
            }
        }

        async function applyLabelWord(label, justification) {
            await Word.run(async (context) => {
                const properties = context.document.properties.customProperties;
                
                // Propri√©t√©s de base
                properties.add('_DLPO_Classification', label);
                properties.add('_DLPO_ClassifiedAt', new Date().toISOString());
                properties.add('_DLPO_ClassifiedBy', 'DLPO Add-in');
                
                // Propri√©t√©s de justification si downgrade
                if (justification) {
                    properties.add('_DLPO_DowngradedFrom', justification.from);
                    properties.add('_DLPO_DowngradedAt', justification.timestamp);
                    properties.add('_DLPO_DowngradeJustification', justification.code);
                    properties.add('_DLPO_DowngradeReason', justification.text);
                }
                
                // Header
                if (document.getElementById('optHeader').checked) {
                    const sections = context.document.sections;
                    sections.load('items');
                    await context.sync();
                    
                    for (let i = 0; i < sections.items.length; i++) {
                        const header = sections.items[i].getHeader('Primary');
                        header.insertParagraph(`Classification: ${label}`, 'Start');
                    }
                }
                
                // Footer
                if (document.getElementById('optFooter').checked) {
                    const sections = context.document.sections;
                    sections.load('items');
                    await context.sync();
                    
                    for (let i = 0; i < sections.items.length; i++) {
                        const footer = sections.items[i].getFooter('Primary');
                        const para = footer.insertParagraph(`Classification: ${label}`, 'End');
                        para.alignment = Word.Alignment.centered;
                        
                        const colors = {
                            'Public': '#10B981',
                            'Internal': '#3B82F6',
                            'Confidential': '#F59E0B',
                            'Restricted': '#EF4444'
                        };
                        para.font.color = colors[label] || '#000000';
                        para.font.bold = true;
                    }
                }
                
                // Watermark
                if (document.getElementById('optWatermark').checked) {
                    const body = context.document.body;
                    const watermark = body.insertParagraph(label.toUpperCase(), 'Start');
                    watermark.font.color = '#E0E0E0';
                    watermark.font.size = 48;
                    watermark.alignment = Word.Alignment.centered;
                }
                
                await context.sync();
            });
        }

        async function applyLabelExcel(label, justification) {
            await Excel.run(async (context) => {
                const workbook = context.workbook;
                const properties = workbook.properties.custom;
                
                properties.add('_DLPO_Classification', label);
                properties.add('_DLPO_ClassifiedAt', new Date().toISOString());
                properties.add('_DLPO_ClassifiedBy', 'DLPO Add-in');
                
                if (justification) {
                    properties.add('_DLPO_DowngradedFrom', justification.from);
                    properties.add('_DLPO_DowngradedAt', justification.timestamp);
                    properties.add('_DLPO_DowngradeJustification', justification.code);
                    properties.add('_DLPO_DowngradeReason', justification.text);
                }
                
                await context.sync();
            });
        }

        async function applyLabelPowerPoint(label, justification) {
            await PowerPoint.run(async (context) => {
                const presentation = context.presentation;
                
                // PowerPoint ne supporte pas les custom properties via l'API
                // On utilise les tags
                presentation.tags.add('_DLPO_Classification', label);
                presentation.tags.add('_DLPO_ClassifiedAt', new Date().toISOString());
                
                if (justification) {
                    presentation.tags.add('_DLPO_DowngradedFrom', justification.from);
                    presentation.tags.add('_DLPO_DowngradeJustification', justification.code);
                    presentation.tags.add('_DLPO_DowngradeReason', justification.text);
                }
                
                await context.sync();
            });
        }

        async function loadCurrentLabel() {
            try {
                const host = Office.context.host;
                let label = null;
                
                if (host === Office.HostType.Word) {
                    await Word.run(async (context) => {
                        const properties = context.document.properties.customProperties;
                        properties.load('items');
                        await context.sync();
                        
                        for (let item of properties.items) {
                            if (item.key === '_DLPO_Classification') {
                                label = item.value;
                                break;
                            }
                        }
                    });
                } else if (host === Office.HostType.Excel) {
                    await Excel.run(async (context) => {
                        const properties = context.workbook.properties.custom;
                        properties.load('items');
                        await context.sync();
                        
                        for (let item of properties.items) {
                            if (item.key === '_DLPO_Classification') {
                                label = item.value;
                                break;
                            }
                        }
                    });
                } else if (host === Office.HostType.PowerPoint) {
                    await PowerPoint.run(async (context) => {
                        const tags = context.presentation.tags;
                        tags.load('items');
                        await context.sync();
                        
                        for (let item of tags.items) {
                            if (item.key === '_DLPO_Classification') {
                                label = item.value;
                                break;
                            }
                        }
                    });
                }
                
                if (label) {
                    updateCurrentLabelDisplay(label);
                } else {
                    document.getElementById('currentLabel').textContent = 'Non classifi√©';
                    document.getElementById('currentLabel').className = 'current-label-value';
                    currentLabelValue = null;
                    currentLabelPriority = 0;
                }
                
            } catch (error) {
                console.error('Erreur chargement label:', error);
                document.getElementById('currentLabel').textContent = 'Non classifi√©';
                currentLabelValue = null;
                currentLabelPriority = 0;
            }
        }

        function updateCurrentLabelDisplay(label) {
            const el = document.getElementById('currentLabel');
            el.textContent = label;
            el.className = 'current-label-value ' + labelColors[label];
            currentLabelValue = label;
            currentLabelPriority = labelPriorities[label] || 0;
            
            // Mettre √† jour le bouton actif
            document.querySelectorAll('.label-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.label === label) {
                    btn.classList.add('active');
                }
            });
        }

        function showStatus(type, message) {
            const status = document.getElementById('status');
            status.className = 'status ' + type;
            status.textContent = message;
        }

        function hideStatus() {
            document.getElementById('status').className = 'status';
        }
    </script>
</body>
</html>
