<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DLPO Classification</title>
    
    <!-- Office.js -->
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
        }
        
        h1 {
            font-size: 18px;
            color: #333;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .subtitle {
            color: #666;
            font-size: 13px;
            margin-bottom: 20px;
        }
        
        /* Current Label */
        .current-label {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .current-label-title {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .current-label-value {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .label-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .label-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        
        /* Labels List */
        .labels-section {
            background: white;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .labels-title {
            font-size: 12px;
            color: #666;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .label-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            margin-bottom: 8px;
            border: 2px solid transparent;
        }
        
        .label-item:hover {
            background: #f0f0f0;
        }
        
        .label-item.selected {
            border-color: #0078d4;
            background: #f0f7ff;
        }
        
        .label-item:last-child {
            margin-bottom: 0;
        }
        
        .label-color {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            margin-right: 12px;
            flex-shrink: 0;
        }
        
        .label-info {
            flex-grow: 1;
        }
        
        .label-item-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }
        
        .label-item-desc {
            font-size: 12px;
            color: #666;
        }
        
        .label-check {
            color: #0078d4;
            font-size: 18px;
            display: none;
        }
        
        .label-item.selected .label-check {
            display: block;
        }
        
        /* Status */
        .status {
            margin-top: 16px;
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            display: none;
        }
        
        .status.success {
            display: block;
            background: #d4edda;
            color: #155724;
        }
        
        .status.error {
            display: block;
            background: #f8d7da;
            color: #721c24;
        }
        
        .status.loading {
            display: block;
            background: #e7f3ff;
            color: #004085;
        }
        
        /* Loading */
        .loading-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #0078d4;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Justification Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-overlay.show {
            display: flex;
        }
        
        .modal {
            background: white;
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #d32f2f;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .modal-subtitle {
            font-size: 13px;
            color: #666;
            margin-bottom: 20px;
        }
        
        .modal-change {
            background: #fff3e0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        
        .modal-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
        }
        
        .modal-arrow {
            color: #999;
        }
        
        .justification-options {
            margin-bottom: 16px;
        }
        
        .justification-option {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .justification-option:hover {
            background: #f5f5f5;
        }
        
        .justification-option.selected {
            border-color: #1976d2;
            background: #e3f2fd;
        }
        
        .justification-option input {
            margin-right: 10px;
        }
        
        .justification-text {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            resize: vertical;
            min-height: 60px;
            margin-top: 8px;
            display: none;
        }
        
        .justification-text.show {
            display: block;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .modal-btn-cancel {
            background: #f5f5f5;
            color: #333;
        }
        
        .modal-btn-cancel:hover {
            background: #e0e0e0;
        }
        
        .modal-btn-confirm {
            background: #d32f2f;
            color: white;
        }
        
        .modal-btn-confirm:hover {
            background: #b71c1c;
        }
        
        .modal-btn-confirm:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Footer/Header Options */
        .options-section {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .options-title {
            font-size: 12px;
            color: #666;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .footer-option {
            margin-bottom: 10px;
        }
        
        .footer-option:last-child {
            margin-bottom: 0;
        }
        
        .footer-option label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-size: 14px;
            color: #333;
        }
        
        .footer-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* Footer */
        .footer {
            margin-top: 20px;
            text-align: center;
            font-size: 11px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè∑Ô∏è Classification</h1>
        <p class="subtitle">S√©lectionnez le niveau de sensibilit√©</p>
        
        <!-- Current Label -->
        <div class="current-label">
            <div class="current-label-title">Label actuel</div>
            <div class="current-label-value">
                <span class="label-dot" id="currentDot" style="background: #gray;"></span>
                <span class="label-name" id="currentLabel">Chargement...</span>
            </div>
        </div>
        
        <!-- Labels List -->
        <div class="labels-section">
            <div class="labels-title">Choisir un label</div>
            <div id="labelsList"></div>
        </div>
        
        <!-- Status -->
        <div class="status" id="status"></div>
        
        <!-- Options Section -->
        <div class="options-section">
            <div class="options-title">Options de marquage</div>
            <div class="footer-option">
                <label>
                    <input type="checkbox" id="addHeader">
                    Ajouter le label dans l'en-t√™te (haut)
                </label>
            </div>
            <div class="footer-option">
                <label>
                    <input type="checkbox" id="addFooter" checked>
                    Ajouter le label dans le pied de page (bas)
                </label>
            </div>
            <div class="footer-option">
                <label>
                    <input type="checkbox" id="addWatermark">
                    Ajouter un filigrane (watermark)
                </label>
            </div>
        </div>
        
        <div class="footer">DLPO Classification v1.5</div>
    </div>
    
    <!-- Justification Modal -->
    <div class="modal-overlay" id="justificationModal">
        <div class="modal">
            <div class="modal-title">‚ö†Ô∏è Justification requise</div>
            <div class="modal-subtitle">Vous abaissez le niveau de classification. Une justification est obligatoire.</div>
            
            <div class="modal-change">
                <div class="modal-label">
                    <span class="label-dot" id="modalFromDot"></span>
                    <span id="modalFromLabel">Restricted</span>
                </div>
                <span class="modal-arrow">‚Üí</span>
                <div class="modal-label">
                    <span class="label-dot" id="modalToDot"></span>
                    <span id="modalToLabel">Public</span>
                </div>
            </div>
            
            <div class="justification-options">
                <label class="justification-option">
                    <input type="radio" name="justification" value="manager_approved">
                    Approuv√© par mon manager
                </label>
                <label class="justification-option">
                    <input type="radio" name="justification" value="data_changed">
                    Les donn√©es sensibles ont √©t√© retir√©es
                </label>
                <label class="justification-option">
                    <input type="radio" name="justification" value="classification_error">
                    Erreur de classification initiale
                </label>
                <label class="justification-option">
                    <input type="radio" name="justification" value="other">
                    Autre raison (pr√©ciser)
                </label>
            </div>
            
            <textarea class="justification-text" id="justificationText" placeholder="Pr√©cisez la raison..."></textarea>
            
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeJustificationModal()">Annuler</button>
                <button class="modal-btn modal-btn-confirm" id="confirmDowngradeBtn" onclick="confirmDowngrade()" disabled>Confirmer</button>
            </div>
        </div>
    </div>

    <script>
        // === CONFIGURATION ===
        const LABELS = [
            {
                id: "public",
                name: "Public",
                description: "Peut √™tre partag√© librement",
                color: "#10b981",
                priority: 0
            },
            {
                id: "internal",
                name: "Internal",
                description: "Usage interne uniquement",
                color: "#3b82f6",
                priority: 1
            },
            {
                id: "confidential",
                name: "Confidential",
                description: "Acc√®s restreint",
                color: "#f59e0b",
                priority: 2
            },
            {
                id: "restricted",
                name: "Restricted",
                description: "Tr√®s sensible - acc√®s contr√¥l√©",
                color: "#ef4444",
                priority: 3
            }
        ];

        const PROPERTY_PREFIX = "_DLPO_";
        let currentLabelId = null;
        let pendingLabelId = null;

        // === OFFICE.JS INIT ===
        Office.onReady((info) => {
            console.log("Office.js ready:", info.host);
            renderLabels();
            readCurrentLabel();
            setupJustificationListeners();
        });
        
        // === SETUP JUSTIFICATION LISTENERS ===
        function setupJustificationListeners() {
            const radios = document.querySelectorAll('input[name="justification"]');
            const confirmBtn = document.getElementById('confirmDowngradeBtn');
            const textArea = document.getElementById('justificationText');
            
            radios.forEach(radio => {
                radio.addEventListener('change', () => {
                    // Update selected style
                    document.querySelectorAll('.justification-option').forEach(opt => {
                        opt.classList.toggle('selected', opt.querySelector('input').checked);
                    });
                    
                    // Show/hide text area for "other"
                    if (radio.value === 'other') {
                        textArea.classList.add('show');
                        confirmBtn.disabled = textArea.value.trim() === '';
                    } else {
                        textArea.classList.remove('show');
                        confirmBtn.disabled = false;
                    }
                });
            });
            
            textArea.addEventListener('input', () => {
                const otherSelected = document.querySelector('input[name="justification"][value="other"]').checked;
                if (otherSelected) {
                    confirmBtn.disabled = textArea.value.trim() === '';
                }
            });
        }

        // === RENDER LABELS ===
        function renderLabels() {
            const container = document.getElementById('labelsList');
            container.innerHTML = LABELS.map(label => `
                <div class="label-item" data-id="${label.id}" onclick="applyLabel('${label.id}')">
                    <div class="label-color" style="background: ${label.color};"></div>
                    <div class="label-info">
                        <div class="label-item-name">${label.name}</div>
                        <div class="label-item-desc">${label.description}</div>
                    </div>
                    <div class="label-check">‚úì</div>
                </div>
            `).join('');
        }

        // === READ CURRENT LABEL ===
        async function readCurrentLabel() {
            try {
                if (Office.context.host === Office.HostType.Word) {
                    await Word.run(async (context) => {
                        const properties = context.document.properties.customProperties;
                        properties.load("items");
                        await context.sync();
                        
                        const labelProp = properties.items.find(p => p.key === PROPERTY_PREFIX + "LabelID");
                        if (labelProp) {
                            currentLabelId = labelProp.value;
                            updateCurrentLabelDisplay(currentLabelId);
                        } else {
                            updateCurrentLabelDisplay(null);
                        }
                    });
                } else if (Office.context.host === Office.HostType.Excel) {
                    await Excel.run(async (context) => {
                        const properties = context.workbook.properties.custom;
                        properties.load("items");
                        await context.sync();
                        
                        const labelProp = properties.items.find(p => p.key === PROPERTY_PREFIX + "LabelID");
                        if (labelProp) {
                            currentLabelId = labelProp.value;
                            updateCurrentLabelDisplay(currentLabelId);
                        } else {
                            updateCurrentLabelDisplay(null);
                        }
                    });
                } else if (Office.context.host === Office.HostType.PowerPoint) {
                    // PowerPoint doesn't have custom properties API, use document settings
                    const labelId = Office.context.document.settings.get(PROPERTY_PREFIX + "LabelID");
                    if (labelId) {
                        currentLabelId = labelId;
                        updateCurrentLabelDisplay(currentLabelId);
                    } else {
                        updateCurrentLabelDisplay(null);
                    }
                }
            } catch (error) {
                console.error("Error reading label:", error);
                updateCurrentLabelDisplay(null);
            }
        }

        // === UPDATE DISPLAY ===
        function updateCurrentLabelDisplay(labelId) {
            const label = LABELS.find(l => l.id === labelId);
            const dot = document.getElementById('currentDot');
            const name = document.getElementById('currentLabel');
            
            if (label) {
                dot.style.background = label.color;
                name.textContent = label.name;
            } else {
                dot.style.background = '#ccc';
                name.textContent = 'Non classifi√©';
            }
            
            // Update selected state
            document.querySelectorAll('.label-item').forEach(item => {
                item.classList.toggle('selected', item.dataset.id === labelId);
            });
        }

        // === APPLY LABEL ===
        async function applyLabel(labelId) {
            const label = LABELS.find(l => l.id === labelId);
            if (!label) return;
            
            // Check if this is a downgrade
            if (currentLabelId) {
                const currentLabel = LABELS.find(l => l.id === currentLabelId);
                if (currentLabel && label.priority < currentLabel.priority) {
                    // This is a downgrade - show justification modal
                    showJustificationModal(currentLabel, label);
                    return;
                }
            }
            
            // Not a downgrade - apply directly
            await applyLabelWithJustification(labelId, null, null);
        }
        
        // === SHOW JUSTIFICATION MODAL ===
        function showJustificationModal(fromLabel, toLabel) {
            pendingLabelId = toLabel.id;
            
            // Update modal display
            document.getElementById('modalFromDot').style.background = fromLabel.color;
            document.getElementById('modalFromLabel').textContent = fromLabel.name;
            document.getElementById('modalToDot').style.background = toLabel.color;
            document.getElementById('modalToLabel').textContent = toLabel.name;
            
            // Reset form
            document.querySelectorAll('input[name="justification"]').forEach(r => r.checked = false);
            document.querySelectorAll('.justification-option').forEach(o => o.classList.remove('selected'));
            document.getElementById('justificationText').value = '';
            document.getElementById('justificationText').classList.remove('show');
            document.getElementById('confirmDowngradeBtn').disabled = true;
            
            // Show modal
            document.getElementById('justificationModal').classList.add('show');
        }
        
        // === CLOSE MODAL ===
        function closeJustificationModal() {
            document.getElementById('justificationModal').classList.remove('show');
            pendingLabelId = null;
        }
        
        // === CONFIRM DOWNGRADE ===
        async function confirmDowngrade() {
            const selectedRadio = document.querySelector('input[name="justification"]:checked');
            if (!selectedRadio) return;
            
            const justificationCode = selectedRadio.value;
            let justificationText = '';
            
            if (justificationCode === 'other') {
                justificationText = document.getElementById('justificationText').value.trim();
            } else {
                justificationText = selectedRadio.parentElement.textContent.trim();
            }
            
            closeJustificationModal();
            await applyLabelWithJustification(pendingLabelId, justificationCode, justificationText);
        }
        
        // === APPLY LABEL WITH JUSTIFICATION ===
        async function applyLabelWithJustification(labelId, justificationCode, justificationText) {
            const label = LABELS.find(l => l.id === labelId);
            if (!label) return;

            showStatus('loading', 'Application du label...');

            try {
                const timestamp = new Date().toISOString();
                const previousLabelId = currentLabelId;
                
                if (Office.context.host === Office.HostType.Word) {
                    await Word.run(async (context) => {
                        const properties = context.document.properties.customProperties;
                        
                        // Set label properties
                        properties.add(PROPERTY_PREFIX + "LabelID", labelId);
                        properties.add(PROPERTY_PREFIX + "LabelName", label.name);
                        properties.add(PROPERTY_PREFIX + "LabeledAt", timestamp);
                        properties.add(PROPERTY_PREFIX + "LabeledBy", "user");
                        
                        // Store justification if it was a downgrade
                        if (justificationCode) {
                            properties.add(PROPERTY_PREFIX + "DowngradedFrom", previousLabelId || "");
                            properties.add(PROPERTY_PREFIX + "DowngradeJustification", justificationCode);
                            properties.add(PROPERTY_PREFIX + "DowngradeReason", justificationText || "");
                            properties.add(PROPERTY_PREFIX + "DowngradedAt", timestamp);
                        }
                        
                        const sections = context.document.sections;
                        sections.load("items");
                        await context.sync();
                        
                        // Add header and/or watermark
                        const addHeader = document.getElementById('addHeader').checked;
                        const addWatermark = document.getElementById('addWatermark').checked;
                        
                        if (addHeader || addWatermark) {
                            for (let i = 0; i < sections.items.length; i++) {
                                const header = sections.items[i].getHeader("Primary");
                                header.clear();
                                
                                // Add header text
                                if (addHeader) {
                                    const headerPara = header.insertParagraph(`Classification: ${label.name}`, "Start");
                                    headerPara.alignment = "Centered";
                                    headerPara.font.size = 10;
                                    headerPara.font.color = label.color;
                                    headerPara.font.bold = true;
                                }
                                
                                // Add watermark text (light gray, large, centered)
                                if (addWatermark) {
                                    const watermark = header.insertParagraph(`${label.name.toUpperCase()}`, "End");
                                    watermark.alignment = "Centered";
                                    watermark.font.size = 54;
                                    watermark.font.color = "#D0D0D0";
                                    watermark.font.bold = true;
                                    watermark.spaceBefore = 150;
                                }
                            }
                        }
                        
                        // Add footer if checkbox is checked
                        const addFooter = document.getElementById('addFooter').checked;
                        if (addFooter) {
                            for (let i = 0; i < sections.items.length; i++) {
                                const footer = sections.items[i].getFooter("Primary");
                                footer.clear();
                                const footerPara = footer.insertParagraph(`Classification: ${label.name}`, "Start");
                                footerPara.alignment = "Centered";
                                footerPara.font.size = 10;
                                footerPara.font.color = label.color;
                                footerPara.font.bold = true;
                            }
                        }
                        
                        await context.sync();
                    });
                } else if (Office.context.host === Office.HostType.Excel) {
                    await Excel.run(async (context) => {
                        const properties = context.workbook.properties.custom;
                        
                        // Set label properties
                        properties.add(PROPERTY_PREFIX + "LabelID", labelId);
                        properties.add(PROPERTY_PREFIX + "LabelName", label.name);
                        properties.add(PROPERTY_PREFIX + "LabeledAt", timestamp);
                        properties.add(PROPERTY_PREFIX + "LabeledBy", "user");
                        
                        // Store justification if it was a downgrade
                        if (justificationCode) {
                            properties.add(PROPERTY_PREFIX + "DowngradedFrom", previousLabelId || "");
                            properties.add(PROPERTY_PREFIX + "DowngradeJustification", justificationCode);
                            properties.add(PROPERTY_PREFIX + "DowngradeReason", justificationText || "");
                            properties.add(PROPERTY_PREFIX + "DowngradedAt", timestamp);
                        }
                        
                        await context.sync();
                    });
                } else if (Office.context.host === Office.HostType.PowerPoint) {
                    // PowerPoint uses document settings
                    Office.context.document.settings.set(PROPERTY_PREFIX + "LabelID", labelId);
                    Office.context.document.settings.set(PROPERTY_PREFIX + "LabelName", label.name);
                    Office.context.document.settings.set(PROPERTY_PREFIX + "LabeledAt", timestamp);
                    Office.context.document.settings.set(PROPERTY_PREFIX + "LabeledBy", "user");
                    
                    // Store justification if it was a downgrade
                    if (justificationCode) {
                        Office.context.document.settings.set(PROPERTY_PREFIX + "DowngradedFrom", previousLabelId || "");
                        Office.context.document.settings.set(PROPERTY_PREFIX + "DowngradeJustification", justificationCode);
                        Office.context.document.settings.set(PROPERTY_PREFIX + "DowngradeReason", justificationText || "");
                        Office.context.document.settings.set(PROPERTY_PREFIX + "DowngradedAt", timestamp);
                    }
                    
                    await new Promise((resolve, reject) => {
                        Office.context.document.settings.saveAsync((result) => {
                            if (result.status === Office.AsyncResultStatus.Succeeded) {
                                resolve();
                            } else {
                                reject(new Error(result.error.message));
                            }
                        });
                    });
                }

                currentLabelId = labelId;
                updateCurrentLabelDisplay(labelId);
                
                const message = justificationCode 
                    ? `‚úì Label "${label.name}" appliqu√© (downgrade justifi√©)`
                    : `‚úì Label "${label.name}" appliqu√© !`;
                showStatus('success', message);
                
                setTimeout(() => hideStatus(), 3000);
                
            } catch (error) {
                console.error("Error applying label:", error);
                showStatus('error', 'Erreur: ' + error.message);
            }
        }

        // === STATUS HELPERS ===
        function showStatus(type, message) {
            const status = document.getElementById('status');
            status.className = 'status ' + type;
            if (type === 'loading') {
                status.innerHTML = '<span class="loading-spinner"></span>' + message;
            } else {
                status.textContent = message;
            }
        }

        function hideStatus() {
            document.getElementById('status').className = 'status';
        }
    </script>
</body>
</html>
