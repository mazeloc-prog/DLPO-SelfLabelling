<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>MazeShield Commands</title>
    <script src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js"></script>
    <script>
        /*
         * MazeShield - Smart Alerts Handler v2.0
         * Avec popup justification style MIP !
         */
        
        const SENSITIVE_LABELS = ['Confidential', 'Restricted', 'CONFIDENTIAL', 'RESTRICTED'];
        const AUDIT_URL = "https://dlpo-audit-api.azurewebsites.net/api/log-event";
        const DIALOG_URL = "https://mazeloc-prog.github.io/DLPO-SelfLabelling/justification-dialog.html";
        
        let internalDomain = null;
        let currentUser = null;

        Office.onReady(function(info) {
            console.log("MazeShield Smart Alerts v2.0 ready");
            Office.actions.associate("onMessageSendHandler", onMessageSendHandler);
        });

        async function onMessageSendHandler(event) {
            try {
                const item = Office.context.mailbox.item;
                
                // 1. Récupérer le domaine de l'utilisateur (SSO)
                currentUser = Office.context.mailbox.userProfile.emailAddress;
                const atIndex = currentUser.indexOf('@');
                if (atIndex > -1) {
                    internalDomain = currentUser.substring(atIndex + 1).toLowerCase();
                }
                
                // 2. Récupérer le sujet
                const subject = await getSubjectAsync(item);
                
                // 3. Récupérer le label (sujet ou custom properties)
                let label = extractLabelFromSubject(subject);
                if (!label) {
                    label = await getClassificationFromProperties(item);
                }
                
                // 4. Récupérer les destinataires
                const recipients = await getAllRecipientsAsync(item);
                const externalRecipients = recipients.filter(r => isExternal(r.emailAddress));
                
                const hasExternal = externalRecipients.length > 0;
                const isSensitive = label && SENSITIVE_LABELS.some(l => 
                    l.toLowerCase() === label.toLowerCase()
                );
                
                console.log('MazeShield Check:', { label, isSensitive, hasExternal, externalRecipients });
                
                // 5. Si sensible + externe → Ouvrir le dialog
                if (isSensitive && hasExternal) {
                    openJustificationDialog(label, externalRecipients, subject, event);
                } else {
                    event.completed({ allowEvent: true });
                }
                
            } catch (error) {
                console.error("MazeShield Error:", error);
                event.completed({ allowEvent: true });
            }
        }

        function openJustificationDialog(label, externalRecipients, subject, event) {
            const recipientEmails = externalRecipients.map(r => r.emailAddress).join(', ');
            
            const dialogUrl = DIALOG_URL + 
                '?label=' + encodeURIComponent(label) +
                '&recipients=' + encodeURIComponent(recipientEmails) +
                '&subject=' + encodeURIComponent(subject);
            
            Office.context.ui.displayDialogAsync(
                dialogUrl,
                { height: 60, width: 35, displayInIframe: false },
                function(asyncResult) {
                    if (asyncResult.status === Office.AsyncResultStatus.Failed) {
                        console.error("Dialog failed:", asyncResult.error.message);
                        showNativeAlert(label, recipientEmails, event);
                        return;
                    }
                    
                    const dialog = asyncResult.value;
                    
                    dialog.addEventHandler(Office.EventType.DialogMessageReceived, function(arg) {
                        dialog.close();
                        
                        try {
                            const response = JSON.parse(arg.message);
                            
                            if (response.action === 'SEND') {
                                logAudit({
                                    action: "EMAIL_SENT_WITH_JUSTIFICATION",
                                    label: label,
                                    justificationCode: response.justification,
                                    justificationText: response.justificationText,
                                    comment: response.comment,
                                    externalRecipients: externalRecipients.map(r => r.emailAddress),
                                    subject: subject
                                });
                                
                                event.completed({ allowEvent: true });
                            } else {
                                logAudit({
                                    action: "EMAIL_SEND_CANCELLED",
                                    label: label,
                                    externalRecipients: externalRecipients.map(r => r.emailAddress)
                                });
                                
                                event.completed({ allowEvent: false });
                            }
                        } catch (e) {
                            console.error("Parse error:", e);
                            event.completed({ allowEvent: false });
                        }
                    });
                    
                    dialog.addEventHandler(Office.EventType.DialogEventReceived, function(arg) {
                        console.log("Dialog closed:", arg.error);
                        event.completed({ allowEvent: false });
                    });
                }
            );
        }

        function showNativeAlert(label, recipientEmails, event) {
            event.completed({
                allowEvent: false,
                errorMessage: "⚠️ MAZESHIELD ALERT\n\n" +
                    "This email is classified \"" + label.toUpperCase() + "\" and contains EXTERNAL recipients:\n\n" +
                    recipientEmails + "\n\n" +
                    "Please use the MazeShield taskpane to provide justification before sending."
            });
        }

        // === HELPERS ===
        
        function getSubjectAsync(item) {
            return new Promise((resolve) => {
                item.subject.getAsync((result) => {
                    resolve(result.status === Office.AsyncResultStatus.Succeeded ? result.value || '' : '');
                });
            });
        }

        function getClassificationFromProperties(item) {
            return new Promise((resolve) => {
                item.loadCustomPropertiesAsync((result) => {
                    if (result.status === Office.AsyncResultStatus.Succeeded) {
                        resolve(result.value.get("MazeShield_Classification") || null);
                    } else {
                        resolve(null);
                    }
                });
            });
        }

        function extractLabelFromSubject(subject) {
            const match = subject.match(/\[(PUBLIC|INTERNAL|CONFIDENTIAL|RESTRICTED)\]/i);
            return match ? match[1] : null;
        }

        function getAllRecipientsAsync(item) {
            return new Promise((resolve) => {
                const recipients = [];
                let pending = 3;
                
                function done() {
                    pending--;
                    if (pending === 0) resolve(recipients);
                }
                
                item.to.getAsync((r) => {
                    if (r.status === Office.AsyncResultStatus.Succeeded) recipients.push(...(r.value || []));
                    done();
                });
                item.cc.getAsync((r) => {
                    if (r.status === Office.AsyncResultStatus.Succeeded) recipients.push(...(r.value || []));
                    done();
                });
                item.bcc.getAsync((r) => {
                    if (r.status === Office.AsyncResultStatus.Succeeded) recipients.push(...(r.value || []));
                    done();
                });
            });
        }

        function isExternal(email) {
            if (!internalDomain) return false;
            return !email.toLowerCase().endsWith('@' + internalDomain);
        }

        function logAudit(data) {
            try {
                fetch(AUDIT_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        tenantId: internalDomain,
                        user: currentUser,
                        timestamp: new Date().toISOString(),
                        source: "outlook-smart-alert",
                        ...data
                    })
                });
            } catch (e) {
                console.error("Audit log failed:", e);
            }
        }
    </script>
</head>
<body>
    <!-- Runtime Smart Alerts - pas d'UI visible -->
</body>
</html>
